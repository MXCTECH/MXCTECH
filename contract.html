<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MXCTECH — Contract</title>

  <!-- Brand fonts are optional; system stack keeps it fast -->
  <style>
    :root{
      --bg:#0b0e13;
      --panel:#151a22;
      --panel-2:#10141c;
      --line:#233247;
      --text:#eef3ff;
      --muted:#9aa4bd;
      --blue:#1F6BFF;
      --blue-2:#1754c4;
      --accent:#f5b000;       /* gold accent */
      --ok:#18c37a;
      --danger:#e55353;
      --shadow:0 8px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#0a0f19 0%, var(--bg) 60%);color:var(--text)}
    body{font-family:-apple-system, Segoe UI, Roboto, Arial, sans-serif}

    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:14px;
      padding:14px 18px;
      background:var(--panel-2);
      border-bottom:1px solid var(--line);
    }
    header img{height:38px;width:auto;object-fit:contain;filter:drop-shadow(0 2px 3px rgba(0,0,0,.25))}
    header .brand{display:flex;flex-direction:column}
    .brand b{letter-spacing:.4px}
    .brand small{color:var(--muted)}

    main{max-width:1100px;margin:20px auto;padding:0 16px 80px}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:920px){ .grid{grid-template-columns:1.1fr .9fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)) , var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    h1{margin:0 0 6px;font-size:26px;color:var(--blue)}
    h2{margin:0 0 12px;font-size:18px;color:var(--text)}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,textarea,select{
      width:100%; background:#0e141d; color:var(--text);
      border:1px solid var(--line); border-radius:10px; padding:12px 12px;
      outline:none; transition:border .15s ease;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--blue)}
    textarea{min-height:96px; resize:vertical}

    .tag{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:#111;background:var(--accent);
      border-radius:999px;padding:4px 10px;font-weight:600}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      background:linear-gradient(180deg,var(--blue) 0%, var(--blue-2) 100%);
      color:#fff;text-decoration:none;border:0;border-radius:12px;
      padding:12px 16px; font-weight:700; cursor:pointer; box-shadow:var(--shadow)
    }
    .btn.secondary{background:linear-gradient(180deg,#2a3340,#1b2431)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.warn{background:linear-gradient(180deg,#e86b4f,#d64242)}
    .btn.ok{background:linear-gradient(180deg,#20d98a,#10b26b)}
    .btn:disabled{opacity:.6;pointer-events:none}

    .button-bar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}

    /* Signature pad */
    .sig-wrap{background:#0e141d;border:1px dashed var(--line);border-radius:12px;padding:10px}
    canvas#sigPad{width:100%;height:220px;border-radius:8px;background:#0b0f16;touch-action:none;display:block}

    footer{margin-top:28px;text-align:center;color:var(--muted)}
    .tc{font-size:12px;line-height:1.55;color:#cdd6e3}
    .tc h3{font-size:14px;margin:10px 0 6px;color:#e7ecf7}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}

    /* Utility */
    .flex{display:flex;gap:10px;align-items:center}
  </style>

  <!-- libs for PDF + signature -->
  <script src="https://unpkg.com/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <img src="mxctech-logo.png" alt="MXCTECH Logo" onerror="this.style.display='none'">
    <div class="brand">
      <b>MXCTECH INSULATION</b>
      <small>Contract & Signature</small>
    </div>
    <span class="pill" style="margin-left:auto">Secure • e-signature</span>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Client & Job -->
      <section class="card">
        <h1>Client & Job</h1>
        <div class="row">
          <div>
            <label>Client Name</label>
            <input id="custName" placeholder="Full name" />
          </div>
          <div>
            <label>Client Phone (WhatsApp)</label>
            <input id="custPhone" placeholder="+44 7..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Email</label>
            <input id="custEmail" placeholder="client@email.com" />
          </div>
          <div>
            <label>Representative</label>
            <input id="repName" placeholder="Your name" />
          </div>
        </div>

        <label>Address Line</label>
        <input id="addr1" placeholder="Street & number" />
        <div class="row">
          <div>
            <label>Town / City</label>
            <input id="town" placeholder="Town or city" />
          </div>
          <div>
            <label>Postcode</label>
            <input id="postcode" placeholder="YO8 9PY" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Appointment / Contract Date</label>
            <input id="apptDate" type="datetime-local" />
          </div>
          <div>
            <label>Job Type</label>
            <input id="jobType" placeholder="e.g., Multifoil Insulation" />
          </div>
        </div>

        <label>Notes</label>
        <textarea id="notes" placeholder="Any important notes…"></textarea>

        <div class="row">
          <div>
            <label>Total (£)</label>
            <input id="total" inputmode="decimal" placeholder="2150.00" />
          </div>
          <div>
            <label>Deposit (£)</label>
            <input id="deposit" inputmode="decimal" placeholder="1000.00" />
          </div>
        </div>

        <div class="button-bar">
          <button class="btn ok" id="shareWA">Send via WhatsApp</button>
          <button class="btn secondary" id="copyLink">Copy Contract Link</button>
        </div>
      </section>

      <!-- RIGHT: Signature -->
      <section class="card">
        <h1>Signature</h1>
        <div class="sig-wrap">
          <canvas id="sigPad"></canvas>
        </div>
        <div class="row">
          <div>
            <label>Signer full name</label>
            <input id="signerName" placeholder="Type name of signer" />
          </div>
          <div>
            <label>Signed at (auto)</label>
            <input id="signedAt" readonly />
          </div>
        </div>
        <div class="button-bar">
          <button class="btn ghost" id="clearSig">Clear</button>
          <button class="btn" id="savePdf">Download PDF</button>
        </div>

        <div class="hr"></div>
        <h2>Terms & Conditions</h2>
        <div class="tc" id="tcs">
          <h3>Payments</h3>
          Deposit is payable to secure the booking. Balances are due on completion unless otherwise agreed in writing.
          <h3>Scheduling</h3>
          Dates may shift due to weather, access or supply constraints. MXCTECH will notify you promptly of any change.
          <h3>Access & Preparation</h3>
          Client agrees to provide reasonable access and clear areas where work is to be performed.
          <h3>Warranty</h3>
          Our installation workmanship is warranted for 12 months. Manufacturer warranties apply to materials.
          <h3>Variations</h3>
          Any changes requested after acceptance may affect price and duration. Variations require written approval.
          <h3>Cancellation</h3>
          Cancellations within 7 days of the appointment may incur costs for materials or time allocated.
          <h3>Acceptance</h3>
          By signing, the client accepts the scope, price, and terms herein.
        </div>
      </section>
    </div>

    <footer>
      © <span id="year"></span> MXCTECH INSULATION
    </footer>
  </main>

  <script>
    // ---------- Helpers ----------
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const fillIf = (id,key)=>{ const el=$(id); if(!el) return; const v=params.get(key); if(v!==null && v!=="") el.value=decodeURIComponent(v); }
    const digits = s => (s||"").replace(/\D+/g,"");
    const money = s => {
      const n = Number(String(s).replace(/[^\d.]/g,""));
      return isFinite(n) ? n.toFixed(2) : "";
    };

    // ---------- Prefill from URL ----------
    fillIf('#custName','custName');
    fillIf('#custPhone','custPhone');
    fillIf('#custEmail','custEmail');
    fillIf('#addr1','addr1');
    fillIf('#town','town');
    fillIf('#postcode','postcode');
    fillIf('#apptDate','apptDate');
    fillIf('#repName','repName');
    fillIf('#jobType','jobType');
    fillIf('#notes','notes');
    if(params.get('total')) $('#total').value = money(params.get('total'));
    if(params.get('deposit')) $('#deposit').value = money(params.get('deposit'));
    $('#year').textContent = new Date().getFullYear();

    // ---------- Build a clean contract link (dynamic base) ----------
    function contractBaseUrl(){
      // contract.html is in the SAME folder as this page.
      // Replace the last path segment with "contract.html".
      const base = location.origin + location.pathname.replace(/\/[^\/]*$/, '/');
      return base + 'contract.html';
    }
    function buildLink(){
      const q = new URLSearchParams({
        custName: $('#custName').value.trim(),
        custPhone: $('#custPhone').value.trim(),
        custEmail: $('#custEmail').value.trim(),
        addr1: $('#addr1').value.trim(),
        town: $('#town').value.trim(),
        postcode: $('#postcode').value.trim(),
        apptDate: $('#apptDate').value,
        repName: $('#repName').value.trim(),
        jobType: $('#jobType').value.trim(),
        notes: $('#notes').value.trim(),
        total: $('#total').value.trim(),
        deposit: $('#deposit').value.trim()
      });
      return contractBaseUrl() + '?' + q.toString();
    }

    // ---------- WhatsApp share ----------
    $('#shareWA').addEventListener('click', () => {
      const phone = digits($('#custPhone').value);
      const name = $('#custName').value.trim() || 'there';
      const total = $('#total').value ? `£${money($('#total').value)}` : '';
      const deposit = $('#deposit').value ? `£${money($('#deposit').value)}` : '';
      const link = buildLink();

      const msg =
        `Hi ${name}, it’s our team from MXCTECH INSULATION.%0A%0A` +
        `Here’s your contract link:%0A${encodeURIComponent(link)}%0A%0A` +
        (total?`Quote total: ${total}%0A`:'') +
        (deposit?`Deposit: ${deposit}%0A`:'') +
        `%0AIf anything looks wrong, reply here and we’ll fix it.`;

      const wa = `https://wa.me/${phone}?text=${msg}`;
      // Open in same tab (mobile WA app will intercept)  
      location.href = wa;
    });

    // ---------- Copy link ----------
    $('#copyLink').addEventListener('click', async () => {
      const link = buildLink();
      try{
        await navigator.clipboard.writeText(link);
        $('#copyLink').textContent = 'Link copied ✔';
        setTimeout(()=>$('#copyLink').textContent='Copy Contract Link',1600);
      }catch{
        alert('Copy failed. Long-press to copy:\n' + link);
      }
    });

    // ---------- Signature Pad with proper retina scaling ----------
    const canvas = document.getElementById('sigPad');
    const sigPad = new SignaturePad(canvas, {
      minWidth: 0.9,
      maxWidth: 2.6,
      penColor: 'rgba(255,255,255,0.95)',
      backgroundColor: 'rgba(0,0,0,0)'
    });

    function resizeCanvas(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      sigPad.clear(); // required after rescale
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    $('#clearSig').addEventListener('click', () => sigPad.clear());

    // Stamp sign date/time automatically when drawing starts
    sigPad.addEventListener("beginStroke", () => {
      if(!$('#signedAt').value){
        const d = new Date();
        $('#signedAt').value = d.toLocaleString();
      }
    });

    // ---------- PDF Download ----------
    async function makePDF(){
      if(sigPad.isEmpty()){
        if(!confirm("Signature is empty. Continue without signature?")) return;
      }
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });

      // header
      pdf.setFillColor(21,26,34); // panel color
      pdf.rect(0,0,595,84,'F');
      pdf.setTextColor(255,255,255);
      pdf.setFontSize(16);
      pdf.text('MXCTECH INSULATION — Contract', 24, 30);
      pdf.setFontSize(10);
      pdf.setTextColor(200,210,225);
      pdf.text('Generated: ' + (new Date()).toLocaleString(), 24, 50);

      // logo (if available on page)
      const imgEl = document.querySelector('header img');
      if(imgEl && imgEl.src && imgEl.naturalWidth){
        try{
          // draw the displayed logo portion as canvas, then to dataURL
          const logoCanvas = await html2canvas(imgEl, {backgroundColor:null, scale:2});
          const dataUrl = logoCanvas.toDataURL('image/png');
          pdf.addImage(dataUrl, 'PNG', 480, 18, 86, 40);
        }catch(e){}
      }

      let y=100;
      pdf.setTextColor(30,40,55);
      pdf.setDrawColor(35,50,71);

      // Client block
      pdf.setFontSize(12); pdf.setTextColor(31,107,255);
      pdf.text('Client & Job', 24, y); y+=10;
      pdf.setTextColor(20,24,31); pdf.setFontSize(11);
      const lines = [
        ['Client', $('#custName').value],
        ['Phone', $('#custPhone').value],
        ['Email', $('#custEmail').value],
        ['Address', $('#addr1').value],
        ['Town/City', $('#town').value],
        ['Postcode', $('#postcode').value],
        ['Date', $('#apptDate').value],
        ['Representative', $('#repName').value],
        ['Job Type', $('#jobType').value],
        ['Notes', $('#notes').value],
        ['Total', $('#total').value ? '£'+(Number($('#total').value)||0).toFixed(2) : ''],
        ['Deposit', $('#deposit').value ? '£'+(Number($('#deposit').value)||0).toFixed(2) : '']
      ];
      lines.forEach(([k,v])=>{
        if(!v) return;
        pdf.setFont(undefined,'bold'); pdf.text(k+':', 24, y);
        pdf.setFont(undefined,'normal'); pdf.text(String(v), 120, y);
        y+=16;
      });

      // Signature
      y+=8;
      pdf.setDrawColor(170,180,200);
      pdf.line(24,y,571,y); y+=18;

      pdf.setTextColor(31,107,255);
      pdf.setFont(undefined,'bold'); pdf.text('Signature', 24, y); y+=10;
      pdf.setFont(undefined,'normal'); pdf.setTextColor(20,24,31);

      if(!sigPad.isEmpty()){
        const sigData = sigPad.toDataURL('image/png');
        pdf.addImage(sigData,'PNG',24,y,260,90);
      } else {
        pdf.text('No signature captured', 24, y+20);
      }
      pdf.text('Signed by: ' + ($('#signerName').value || $('#custName').value || ''), 300, y+20);
      pdf.text('Signed at: ' + ($('#signedAt').value || new Date().toLocaleString()), 300, y+40);
      y+=110;

      // T&Cs (wrap across pages)
      const tcText = document.getElementById('tcs').innerText.replace(/\n{2,}/g,'\n');
      pdf.setDrawColor(170,180,200);
      pdf.line(24,y,571,y); y+=18;
      pdf.setTextColor(31,107,255);
      pdf.setFont(undefined,'bold'); pdf.text('Terms & Conditions',24,y); y+=12;
      pdf.setTextColor(20,24,31); pdf.setFont(undefined,'normal'); pdf.setFontSize(10);

      const wrap = pdf.splitTextToSize(tcText, 545);
      wrap.forEach(line=>{
        if(y>770){ pdf.addPage(); y=50; }
        pdf.text(line, 24, y); y+=14;
      });

      pdf.save('MXCTECH — Contract.pdf');
    }
    $('#savePdf').addEventListener('click', makePDF);
  </script>
</body>
</html>
