<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000; --accent:#d4af37; --danger:#c31515; --line:#e8e8e8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#f5f6f7;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  input,select,textarea,button{font-size:16px} /* stop iOS zoom */

  .sheet{max-width:900px;margin:14px auto;padding:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}

  /* header */
  .brand{display:grid;grid-template-columns:auto 1fr auto;gap:14px;align-items:center}
  .brand img{width:120px;height:auto;object-fit:contain}
  .brand h1{margin:0;font-size:40px;letter-spacing:.05em}
  .brand .addr{font-size:15px;line-height:1.35;margin-top:6px}
  .brand .right{display:grid;gap:8px;min-width:240px}
  .brand .right input{width:100%;border:1px solid #d4d4d4;border-radius:10px;padding:10px 12px;background:#fff}

  @media (max-width:740px){
    .brand{grid-template-columns:1fr;align-items:start}
    .brand img{width:140px}
    .brand .right{grid-template-columns:1fr 1fr}
  }

  .section{font-weight:800;margin:16px 0 10px;font-size:20px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:740px){ .grid2{grid-template-columns:1fr} }

  .box label{display:block;font-size:13px;color:#555;margin-bottom:6px}
  .box input,.box textarea,.box select{width:100%;border:1px solid #cfcfcf;border-radius:10px;background:#fff;padding:12px}
  .box textarea{min-height:90px;resize:vertical}

  /* product lines as mobile cards */
  .lines{display:grid;gap:10px}
  .line{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa}
  .line .row{display:grid;gap:8px}
  .line .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .line .lt input{background:#fff;border:1px dashed #bbb}
  @media (max-width:740px){ .line .row3{grid-template-columns:1fr} }

  .btns{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:800;color:#fff;background:#111;cursor:pointer}
  .btn.secondary{background:#333}
  .btn.danger{background:#a40a0a}

  /* options + totals */
  .panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .summary{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .rowfx{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed #e6e6e6}
  .rowfx:last-child{border-bottom:0}
  .grand{font-weight:900;font-size:22px}
  .gold{color:var(--accent)}
  .muted{color:#666;font-size:13px}

  /* waiver */
  .waiver{border:2px solid var(--danger);background:#fff7f7;border-radius:12px;padding:12px}
  .waiver h3{margin:0 0 6px;color:var(--danger)}

  /* signatures */
  .sigs{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:740px){ .sigs{grid-template-columns:1fr} }
  .sig{border:1px dashed #bbb;border-radius:12px;padding:10px;background:#fafafa}
  .sig canvas{width:100%;height:200px;background:#fff;border:1px solid #ddd;border-radius:8px;touch-action:none}
  .sig .under{display:flex;gap:8px;align-items:center;margin-top:8px}
  .sig .under input{flex:1}
  .sig .under button{padding:10px 12px;border:0;border-radius:10px;font-weight:800;background:#222;color:#fff}

  .footer{font-size:12px;color:#666;text-align:center;margin-top:8px}

  /* helpers for PDF */
  #capture{background:#fff}
</style>
</head>
<body>
<div class="sheet">
  <div id="capture" class="card">
    <!-- HEADER -->
    <div class="brand">
      <img src="warmupuklogo.jpg" alt="WARM UP UK" />
      <div>
        <h1>WARM UP UK</h1>
        <div class="addr">321–323 Romford High Road, Essex RM6 6AX<br><strong>Tel:</strong> <a href="tel:01708300670">01708 300670</a></div>
      </div>
      <div class="right">
        <input id="contractNo" placeholder="Contract #" readonly />
        <input id="contractDate" placeholder="Date" readonly />
      </div>
    </div>

    <!-- CUSTOMER -->
    <div class="section">Customer</div>
    <div class="grid2">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
        <label style="margin-top:10px">Property Address</label>
        <textarea id="custAddr" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…" />
        <label style="margin-top:10px">Email</label>
        <input id="custEmail" placeholder="email@example.com" />
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="section">Products / Services</div>
    <div id="lines" class="lines"></div>
    <div class="btns" style="margin:10px 0 6px">
      <button class="btn secondary" id="addLine">+ Add Row</button>
      <button class="btn secondary" id="removeLine">– Remove Last</button>
      <button class="btn danger" id="clearLines">Clear Lines</button>
    </div>

    <!-- OPTIONS -->
    <div class="section">Options</div>
    <div class="panel">
      <label style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="vatTick" /> Apply <strong>VAT 20%</strong>
      </label>
      <div class="muted" style="margin-top:6px">Admin Fee of <strong>£150</strong> is automatically applied.</div>
      <div class="box" style="margin-top:12px">
        <label>Install Date</label>
        <input type="date" id="installDate" />
      </div>
    </div>

    <!-- TOTALS -->
    <div class="section">Totals</div>
    <div class="summary">
      <div class="rowfx"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
      <div class="rowfx"><div>Admin Fee</div><div>£ <span id="admin">150.00</span></div></div>
      <div class="rowfx"><div>VAT (20%)</div><div>£ <span id="vat">0.00</span></div></div>
      <div class="rowfx grand"><div>Grand Total</div><div><span class="gold">£</span> <span id="grand">150.00</span></div></div>
      <div class="rowfx">
        <div>Less Deposit</div>
        <div style="display:flex;gap:6px;align-items:center">£
          <input id="deposit" type="number" min="0" step="0.01" value="0" style="width:120px;text-align:right;border:1px solid #cfcfcf;border-radius:10px;padding:8px 10px">
        </div>
      </div>
      <div class="rowfx"><div><strong>Balance Due</strong></div><div><strong id="balance">£150.00</strong></div></div>
    </div>

    <!-- NOTES -->
    <div class="section">Notes</div>
    <div class="box">
      <textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <!-- WAIVER -->
    <div class="section">Express Waiver</div>
    <div class="waiver">
      <h3>Express Waiver</h3>
      <p>I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may affect my right to cancel once the work has started and materials have been ordered or installed.</p>
      <label style="display:flex;gap:10px;align-items:center"><input type="checkbox" id="waiverAck"> I acknowledge and accept the Express Waiver.</label>
    </div>

    <!-- SIGNATURES -->
    <div class="section">Signatures</div>
    <div class="sigs">
      <div class="sig">
        <div style="font-weight:700;margin-bottom:6px">Customer Signature</div>
        <canvas id="sigCustomer"></canvas>
        <div class="under">
          <input id="sigCustName" placeholder="Customer printed name" />
          <button type="button" id="clearCust">Clear</button>
        </div>
      </div>
      <div class="sig">
        <div style="font-weight:700;margin-bottom:6px">Company Signature</div>
        <canvas id="sigCompany"></canvas>
        <div class="under">
          <input id="sigCompName" placeholder="Company representative" />
          <button type="button" id="clearComp">Clear</button>
        </div>
      </div>
    </div>

    <div class="btns" style="margin:14px 0 6px">
      <button class="btn" id="pdfBtn">Generate PDF</button>
      <button class="btn danger" id="clearForm">Clear Form</button>
    </div>

    <div class="footer">WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670</div>
  </div>
</div>

<script>
(() => {
  /* ---------- constants ---------- */
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin Treatment",
    "Timber Treatment"
  ];
  const ADMIN = 150, VAT_RATE = 0.20;

  /* ---------- header autofill ---------- */
  const contractNo = document.getElementById('contractNo');
  const contractDate = document.getElementById('contractDate');
  function genContractNo(){
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    return `WUU-${String(d.getFullYear()).slice(-2)}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}-${Math.floor(1000+Math.random()*9000)}`;
  }
  function todayISO(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
  contractNo.value = genContractNo();
  contractDate.value = todayISO();
  document.getElementById('installDate').value = todayISO();

  /* ---------- product rows ---------- */
  const lines = document.getElementById('lines');
  function selEl(){
    const s=document.createElement('select');
    s.innerHTML = PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
    return s;
  }
  function currency(n){ return (Number(n||0)).toFixed(2); }
  function makeLine(){
    const wrap = document.createElement('div'); wrap.className='line';

    const top = document.createElement('div'); top.className='row';
    const lab = document.createElement('label'); lab.textContent='Product'; lab.style.fontSize='13px'; lab.style.color='#555';
    const sel = selEl();
    top.append(lab, sel);

    const mid = document.createElement('div'); mid.className='row row3';
    const qty = document.createElement('div'); qty.innerHTML = `<label>Qty</label><input type="number" min="0" step="1" value="0">`;
    const unit = document.createElement('div'); unit.innerHTML = `<label>Unit (£)</label><input type="number" min="0" step="0.01" value="0">`;
    const lt = document.createElement('div'); lt.className='lt'; lt.innerHTML = `<label>Line Total</label><input type="text" value="0.00" readonly>`;

    mid.append(qty, unit, lt);
    wrap.append(top, mid);

    function recalc(){
      const q = Number(qty.querySelector('input').value||0);
      const u = Number(unit.querySelector('input').value||0);
      lt.querySelector('input').value = currency(q*u);
      recalcTotals();
    }
    qty.querySelector('input').addEventListener('input', recalc);
    unit.querySelector('input').addEventListener('input', recalc);

    return wrap;
  }

  function addLine(){ lines.appendChild(makeLine()); recalcTotals(); }
  function removeLine(){ if(lines.lastElementChild){ lines.removeChild(lines.lastElementChild); recalcTotals(); } }
  function clearLines(){ lines.innerHTML=''; recalcTotals(); }

  document.getElementById('addLine').addEventListener('click', addLine);
  document.getElementById('removeLine').addEventListener('click', removeLine);
  document.getElementById('clearLines').addEventListener('click', clearLines);
  // start with 3
  addLine(); addLine(); addLine();

  /* ---------- totals ---------- */
  const subtotalEl = document.getElementById('subtotal');
  const adminEl = document.getElementById('admin');
  const vatEl = document.getElementById('vat');
  const grandEl = document.getElementById('grand');
  const balanceEl = document.getElementById('balance');
  const depositEl = document.getElementById('deposit');
  const vatTick = document.getElementById('vatTick');

  function getSubtotal(){
    let s=0;
    lines.querySelectorAll('.line').forEach(l=>{
      const q = Number(l.querySelector('.row3 div:nth-child(1) input').value||0);
      const u = Number(l.querySelector('.row3 div:nth-child(2) input').value||0);
      s += q*u;
    });
    return s;
  }
  function recalcTotals(){
    const sub = getSubtotal();
    const beforeVAT = sub + ADMIN;
    const vat = vatTick.checked ? beforeVAT*VAT_RATE : 0;
    const grand = beforeVAT + vat;
    const dep = Number(depositEl.value||0);
    const bal = Math.max(grand - dep, 0);

    subtotalEl.textContent = currency(sub);
    adminEl.textContent = currency(ADMIN);
    vatEl.textContent = currency(vat);
    grandEl.textContent = currency(grand);
    balanceEl.textContent = "£" + currency(bal);
  }
  vatTick.addEventListener('change', recalcTotals);
  depositEl.addEventListener('input', recalcTotals);

  /* ---------- signature pads (preserve on rotate) ---------- */
  function signaturePad(canvas){
    const ctx = canvas.getContext('2d');
    let drawing=false, last=null;

    function resizePreserving(){
      // save image
      const data = canvas.toDataURL('image/png');
      const img = new Image();
      img.onload = () => {
        const r = canvas.getBoundingClientRect();
        const dpr = Math.max(window.devicePixelRatio||1,1);
        canvas.width = Math.round(r.width*dpr);
        canvas.height= Math.round(r.height*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
        ctx.drawImage(img,0,0,canvas.width/dpr,canvas.height/dpr);
      };
      img.src = data;
    }
    function start(e){ drawing=true; last=pos(e); e.preventDefault(); }
    function move(e){
      if(!drawing) return;
      const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault();
    }
    function end(){ drawing=false; }
    function pos(e){
      const r = canvas.getBoundingClientRect();
      const t = e.touches ? e.touches[0] : e;
      return {x: t.clientX - r.left, y: t.clientY - r.top};
    }

    window.addEventListener('resize', resizePreserving);
    window.addEventListener('orientationchange', resizePreserving);
    // first size
    setTimeout(resizePreserving, 0);

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end);

    return {
      clear(){ const r=canvas.getBoundingClientRect(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); setTimeout(resizePreserving,0); },
      toDataURL(){ return canvas.toDataURL('image/png'); }
    };
  }
  const padCust = signaturePad(document.getElementById('sigCustomer'));
  const padComp = signaturePad(document.getElementById('sigCompany'));
  document.getElementById('clearCust').addEventListener('click', ()=>padCust.clear());
  document.getElementById('clearComp').addEventListener('click', ()=>padComp.clear());

  /* ---------- PDF helpers: bake canvases ---------- */
  function bakeCanvases(){
    const swaps=[];
    document.querySelectorAll('canvas').forEach(cv=>{
      const img = new Image();
      img.src = cv.toDataURL('image/png');
      img.style.width = cv.style.width || (cv.getBoundingClientRect().width + 'px');
      img.style.height = cv.style.height || (cv.getBoundingClientRect().height + 'px');
      img.style.border = cv.style.border; img.style.borderRadius = cv.style.borderRadius;
      cv.style.display='none';
      cv.parentNode.insertBefore(img, cv);
      swaps.push({cv,img});
    });
    return ()=>{ swaps.forEach(({cv,img})=>{ img.remove(); cv.style.display=''; }); };
  }

  /* ---------- PDF ---------- */
  document.getElementById('pdfBtn').addEventListener('click', async ()=>{
    if(!document.getElementById('waiverAck').checked){
      alert('Please acknowledge the Express Waiver before generating the PDF.');
      return;
    }
    recalcTotals();

    const restore = bakeCanvases();
    const node = document.getElementById('capture');
    const canvas = await html2canvas(node, {scale:2,backgroundColor:'#ffffff',useCORS:true,windowWidth:node.scrollWidth,windowHeight:node.scrollHeight});
    restore();

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:'mm',format:'a4',orientation:'p'});
    const a4w = pdf.internal.pageSize.getWidth();
    const a4h = pdf.internal.pageSize.getHeight();

    const imgW = a4w;
    const imgH = canvas.height * (imgW / canvas.width);
    if(imgH <= a4h){
      pdf.addImage(canvas.toDataURL('image/jpeg',0.95),'JPEG',0,0,imgW,imgH);
    }else{
      // slice into pages
      const ratio = canvas.width / a4w;
      const pageHpx = a4h * ratio;
      let y=0, first=true;
      while(y < canvas.height){
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width;
        pageCanvas.height = Math.min(pageHpx, canvas.height - y);
        const ctx2 = pageCanvas.getContext('2d');
        ctx2.drawImage(canvas, 0, y, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);
        const pageImg = pageCanvas.toDataURL('image/jpeg',0.95);
        if(!first) pdf.addPage();
        pdf.addImage(pageImg,'JPEG',0,0,a4w,pageCanvas.height/ratio);
        first=false; y += pageCanvas.height;
      }
    }

    // Force a clean T&Cs page at the end
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Terms & Conditions (Summary)', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
    const terms = [
      "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
      "2. Customer responsible for providing safe access to all work areas.",
      "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
      "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
      "5. Payment terms: unless otherwise stated, balance due on completion.",
      "6. Materials remain property of WARM UP UK until paid in full.",
      "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
      "8. By signing, the customer confirms accuracy of details and authorises the work as described."
    ];
    const left=14, width=a4w-28; let ytxt=26;
    terms.forEach(t=>{ const lines=pdf.splitTextToSize(t,width); pdf.text(lines,left,ytxt); ytxt+=7+(lines.length-1)*5; });

    pdf.save(`${contractNo.value}.pdf`);
  });

  /* ---------- clear form ---------- */
  document.getElementById('clearForm').addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    document.querySelectorAll('#custName,#custAddr,#custPhone,#custEmail,#notes,#sigCustName,#sigCompName')
      .forEach(i=>i.value='');
    document.getElementById('installDate').value = todayISO();
    vatTick.checked=false; depositEl.value=0;
    padCust.clear(); padComp.clear();
    lines.innerHTML=''; addLine(); addLine(); addLine();
    recalcTotals();
    contractNo.value = genContractNo(); contractDate.value=todayISO();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* initial totals */
  recalcTotals();
})();
</script>
</body>
</html>
