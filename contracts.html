!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#111;
    --line:#e7e7e7;
    --muted:#6b6b6b;
    --gold:#d4af37;
    --danger:#c5162c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:#f6f7f9;color:#111;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
  }
  input,select,textarea,button{font-size:16px} /* stop iOS zoom */
  .sheet{max-width:900px;margin:14px auto; padding:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:14px}

  /* Header */
  .brand{display:grid;grid-template-columns:auto 1fr auto;gap:16px;align-items:center}
  .brand .logo{width:150px; /* 50% larger */ height:auto}
  .brand h1{margin:0;font-size:42px;letter-spacing:.06em}
  .brand .addr{color:#333;line-height:1.35}
  .brand .right{display:grid;gap:8px;min-width:240px}
  .brand .right input{width:100%}

  /* Small header layout (mobile) */
  @media (max-width:720px){
    .brand{grid-template-columns:1fr;align-items:start}
    .brand .logo{width:170px}
    .brand .right{order:2}
    .brand .addr{order:3}
    .brand h1{order:1}
  }

  .field{display:grid;gap:8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }

  label{font-size:12px;color:#555}
  input[type="text"],input[type="number"],input[type="date"],input[type="tel"],input[type="email"],select,textarea{
    width:100%;border:1px solid #ccc;border-radius:8px;padding:10px 12px;background:#fff;
  }
  textarea{min-height:120px}

  h2{font-size:18px;margin:18px 0 10px}

  /* Product rows */
  .line{border:1px solid var(--line);border-radius:10px;background:#fafafa;padding:12px;margin-bottom:12px}
  .line .row{display:grid;grid-template-columns:1fr;gap:8px}
  .mini3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  @media (max-width:560px){ .mini3{grid-template-columns:1fr} }
  .mini3 input[readonly]{background:#efefef;font-weight:700}

  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{border:0;border-radius:10px;padding:12px 14px;font-weight:700;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#333}
  button.danger{background:#b00020}
  button:disabled{opacity:.55;cursor:not-allowed}

  .panel{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
  .rowKV{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px dashed #e9e9e9}
  .rowKV:last-child{border-bottom:0}
  .grand{font-size:20px;font-weight:800}
  .pound{color:var(--gold);font-weight:900}

  .waiver{border:2px solid var(--danger);background:#fff7f7;border-radius:10px;padding:12px}
  .waiver h3{margin:0 0 6px;color:var(--danger)}
  .waiver label{display:flex;gap:8px;align-items:flex-start}

  /* Signatures */
  .sigs{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){ .sigs{grid-template-columns:1fr} }
  .sig{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}
  .sig canvas{width:100%;height:200px;border:1px dashed #bbb;border-radius:8px;background:#fff;touch-action:none}
  .sig .under{display:flex;gap:8px;align-items:center;margin-top:8px}
  .sig .under input{flex:1}
  .sig .under button{padding:8px 10px}

  .footer{font-size:12px;color:#666;text-align:center;margin-top:10px}

  /* Capture area for PDF */
  #capture{background:#fff}
</style>
</head>
<body>
<div class="sheet">
  <div id="capture" class="card">

    <!-- HEADER -->
    <div class="brand">
      <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK" />
      <div>
        <h1>WARM UP UK</h1>
        <div class="addr">
          321–323 Romford High Road, Essex RM6 6AX<br>
          <strong>Tel:</strong> <a href="tel:01708300670">01708 300670</a>
        </div>
      </div>
      <div class="right">
        <div class="field">
          <label>Contract #</label>
          <input id="contractNo" readonly />
        </div>
        <div class="field">
          <label>Date</label>
          <input id="contractDate" readonly />
        </div>
      </div>
    </div>

    <!-- CUSTOMER -->
    <h2>Customer</h2>
    <div class="grid2">
      <div class="field">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
      </div>
      <div class="field">
        <label>Phone</label>
        <input id="custPhone" type="tel" placeholder="07…" />
      </div>
      <div class="field">
        <label>Property Address</label>
        <input id="custAddr" placeholder="House/Street, Town, Postcode" />
      </div>
      <div class="field">
        <label>Email</label>
        <input id="custEmail" type="email" placeholder="email@example.com" />
      </div>
    </div>

    <!-- PRODUCTS -->
    <h2>Products / Services</h2>
    <div id="lines"></div>
    <div class="btns">
      <button id="addLine">+ Add Row</button>
      <button id="removeLine" class="secondary">– Remove Last</button>
      <button id="clearLines" class="danger">Clear Lines</button>
    </div>

    <!-- OPTIONS & TOTALS -->
    <h2>Totals</h2>
    <div class="grid2">
      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="vatToggle" />
          <label for="vatToggle">Apply <strong>VAT 20%</strong></label>
        </div>
        <div style="margin-top:8px;color:#555">Admin Fee of <strong>£150</strong> is automatically applied.</div>

        <div class="field" style="margin-top:12px">
          <label>Install Date</label>
          <input id="installDate" type="date" />
        </div>
      </div>

      <div class="panel" id="totalsBox">
        <div class="rowKV"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
        <div class="rowKV"><div>Admin Fee</div><div>£ <span id="admin">150.00</span></div></div>
        <div class="rowKV"><div>VAT (20%)</div><div>£ <span id="vat">0.00</span></div></div>
        <div class="rowKV grand"><div>Grand Total</div><div><span class="pound">£</span> <span id="grand">150.00</span></div></div>
        <div class="rowKV"><div>Less Deposit</div>
          <div style="display:flex;gap:6px;align-items:center">£
            <input id="deposit" type="number" min="0" step="0.01" value="0" style="width:120px;text-align:right">
          </div>
        </div>
        <div class="rowKV"><div><strong>Balance Due</strong></div><div><strong>£ <span id="balance">150.00</span></strong></div></div>
      </div>
    </div>

    <!-- NOTES -->
    <h2>Notes</h2>
    <textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea>

    <!-- WAIVER BELOW NOTES -->
    <div class="waiver" style="margin-top:12px">
      <h3>Express Waiver</h3>
      <p>I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may affect my right to cancel once the work has started and materials have been ordered or installed.</p>
      <label><input id="waiverTick" type="checkbox"> I acknowledge and accept the Express Waiver.</label>
    </div>

    <!-- SIGNATURES (stack on mobile) -->
    <h2>Signatures</h2>
    <div class="sigs">
      <div class="sig">
        <label><strong>Customer Signature</strong></label>
        <canvas id="sigCust"></canvas>
        <div class="under">
          <input id="sigCustName" placeholder="Customer printed name">
          <button type="button" id="clearCust" class="secondary">Clear</button>
        </div>
      </div>
      <div class="sig">
        <label><strong>Company Signature</strong></label>
        <canvas id="sigComp"></canvas>
        <div class="under">
          <input id="sigCompName" placeholder="Company representative">
          <button type="button" id="clearComp" class="secondary">Clear</button>
        </div>
      </div>
    </div>

    <div class="btns" style="margin-top:12px">
      <button id="pdfBtn" disabled>Generate PDF</button>
      <button id="clearBtn" class="danger">Clear Form</button>
    </div>

    <div class="footer">WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670</div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const PRODUCTS = [
  "Loft Insulation 270mm Fibreglass",
  "Multifoil YBS SuperQuilt",
  "Pitched Roof TLX Silver",
  "Cavity Wall Insulation",
  "Spray Foam Removal",
  "Loft Boarding",
  "Ventilation Upgrade",
  "Vermin Treatment",
  "Timber Treatment"
];
const ADMIN_FEE = 150, VAT_RATE = 0.20;

const el = id => document.getElementById(id);
const lines = el('lines');
const vatToggle = el('vatToggle');
const subtotalEl = el('subtotal'), adminEl = el('admin'), vatEl = el('vat'),
      grandEl = el('grand'), depositEl = el('deposit'), balanceEl = el('balance');

/* ----- Contract # and Date (DD-MM-YYYY) ----- */
function pad(n){return String(n).padStart(2,'0')}
function genContractNo(){
  const d=new Date();
  return `WUU-${pad(d.getDate())}${pad(d.getMonth()+1)}${d.getFullYear()}-${pad(d.getHours())}${pad(d.getMinutes())}-${Math.floor(1000+Math.random()*9000)}`;
}
function todayDDMMYYYY(){
  const d=new Date(); return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
}
el('contractNo').value = genContractNo();
el('contractDate').value = todayDDMMYYYY();

/* ----- Product row builder (stacked) ----- */
function makeSelect(){
  const s = document.createElement('select');
  s.innerHTML = PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
  return s;
}
function currency(n){ return Number(n||0).toFixed(2) }

function makeLine(){
  const wrap = document.createElement('div'); wrap.className='line';

  // Product dropdown
  const prodRow = document.createElement('div'); prodRow.className='row';
  const prodLabel = document.createElement('label'); prodLabel.textContent = 'Product';
  const sel = makeSelect();
  prodRow.append(prodLabel, sel);

  // Qty / Unit / Line Total under product (stack on mobile)
  const mini = document.createElement('div'); mini.className='mini3';
  const qtyBox = document.createElement('div');
  qtyBox.innerHTML = `<label>Qty</label><input type="number" min="0" step="1" value="0">`;
  const unitBox = document.createElement('div');
  unitBox.innerHTML = `<label>Unit (£)</label><input type="number" min="0" step="0.01" value="0">`;
  const totalBox = document.createElement('div');
  totalBox.innerHTML = `<label>Line Total</label><input type="text" value="0.00" readonly>`;
  mini.append(qtyBox, unitBox, totalBox);

  wrap.append(prodRow, mini);

  function recalcLine(){
    const q = parseFloat(qtyBox.querySelector('input').value||0);
    const u = parseFloat(unitBox.querySelector('input').value||0);
    totalBox.querySelector('input').value = currency(q*u);
    recalcTotals();
  }
  qtyBox.querySelector('input').addEventListener('input', recalcLine);
  unitBox.querySelector('input').addEventListener('input', recalcLine);
  sel.addEventListener('change', ()=>{}); // reserved
  return wrap;
}

/* Row buttons */
function addLine(){ lines.appendChild(makeLine()); recalcTotals(); }
function removeLine(){ if(lines.lastElementChild){ lines.removeChild(lines.lastElementChild); recalcTotals(); } }
function clearLines(){ lines.innerHTML=''; recalcTotals(); }

document.getElementById('addLine').addEventListener('click', addLine);
document.getElementById('removeLine').addEventListener('click', removeLine);
document.getElementById('clearLines').addEventListener('click', clearLines);

/* Start with 3 lines */
addLine(); addLine(); addLine();

/* ----- Totals ----- */
function getSubtotal(){
  let sum = 0;
  lines.querySelectorAll('.line').forEach(line=>{
    const q = parseFloat(line.querySelector('.mini3 div:nth-child(1) input').value||0);
    const u = parseFloat(line.querySelector('.mini3 div:nth-child(2) input').value||0);
    sum += q*u;
  });
  return sum;
}
function recalcTotals(){
  const subtotal = getSubtotal();
  const admin = ADMIN_FEE;
  const beforeVAT = subtotal + admin;
  const vat = vatToggle.checked ? beforeVAT * VAT_RATE : 0;
  const grand = beforeVAT + vat;
  const deposit = parseFloat(depositEl.value||0);
  const balance = Math.max(grand - deposit, 0);

  subtotalEl.textContent = currency(subtotal);
  adminEl.textContent = currency(admin);
  vatEl.textContent = currency(vat);
  grandEl.textContent = currency(grand);
  balanceEl.textContent = currency(balance);
}
vatToggle.addEventListener('change', recalcTotals);
depositEl.addEventListener('input', recalcTotals);

/* ----- Waiver gate enables PDF button ----- */
const waiverTick = document.getElementById('waiverTick');
const pdfBtn = document.getElementById('pdfBtn');
function updatePDFEnable(){ pdfBtn.disabled = !waiverTick.checked; }
waiverTick.addEventListener('change', updatePDFEnable); updatePDFEnable();

/* ----- Signature Pads (no wobble, persist across rotate) ----- */
function makePad(canvas){
  const ctx = canvas.getContext('2d');
  let drawing=false, lastX=0, lastY=0, dataBeforeResize=null;

  function resize(){
    // preserve drawing on resize/orientation change
    dataBeforeResize = canvas.toDataURL('image/png');
    const dpr = Math.max(window.devicePixelRatio||1,1);
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.round(r.width*dpr);
    canvas.height= Math.round(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    if(dataBeforeResize){
      const img = new Image(); img.onload=()=>ctx.drawImage(img,0,0,canvas.width/dpr,canvas.height/dpr); img.src=dataBeforeResize;
    }
  }
  resize(); window.addEventListener('resize', resize);

  function pos(e){ const r=canvas.getBoundingClientRect();
    const t=(e.touches&&e.touches[0])||e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
  function lock(lock){ document.body.style.overflow = lock?'hidden':''; }

  function start(e){ drawing=true; lock(true); const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function end(){ drawing=false; lock(false); }

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove', move, {passive:false});
  window.addEventListener('touchend', end);

  return {
    clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); },
    toDataURL(){ return canvas.toDataURL('image/png'); }
  };
}
const sigCust = makePad(document.getElementById('sigCust'));
const sigComp = makePad(document.getElementById('sigComp'));
document.getElementById('clearCust').addEventListener('click', ()=>sigCust.clear());
document.getElementById('clearComp').addEventListener('click', ()=>sigComp.clear());

/* ----- Clear Form ----- */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('Clear all fields?')) return;
  ['custName','custPhone','custAddr','custEmail','notes','sigCustName','sigCompName'].forEach(id=>el(id).value='');
  el('installDate').value='';
  vatToggle.checked=false; depositEl.value=0;
  sigCust.clear(); sigComp.clear();
  clearLines(); addLine(); addLine(); addLine();
  recalcTotals(); updatePDFEnable();
  el('contractNo').value = genContractNo();
  el('contractDate').value = todayDDMMYYYY();
  window.scrollTo({top:0,behavior:'smooth'});
});

/* ----- PDF (bake canvases so signatures show) ----- */
function bakeCanvases(){
  const swaps=[];
  document.querySelectorAll('canvas').forEach(cv=>{
    const img=new Image();
    img.src = cv.toDataURL('image/png');
    img.style.width = cv.style.width|| (cv.getBoundingClientRect().width+'px');
    img.style.height= cv.style.height|| (cv.getBoundingClientRect().height+'px');
    img.style.border=cv.style.border; img.style.borderRadius=cv.style.borderRadius;
    cv.style.display='none'; cv.parentNode.insertBefore(img,cv);
    swaps.push({cv,img});
  });
  return ()=>swaps.forEach(({cv,img})=>{img.remove(); cv.style.display='';});
}

document.getElementById('pdfBtn').addEventListener('click', async ()=>{
  if(!waiverTick.checked){ alert('Please acknowledge the Express Waiver.'); return; }
  recalcTotals();

  const restore = bakeCanvases();
  const node = document.getElementById('capture');

  const canvas = await html2canvas(node,{scale:2,useCORS:true,backgroundColor:'#ffffff',
    windowWidth: node.scrollWidth, windowHeight: node.scrollHeight});
  restore();

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'mm',format:'a4',orientation:'p'});
  const a4w=210, a4h=297;

  // slice tall capture across pages
  const imgW=a4w, ratio = canvas.width/imgW, pagePx = a4h*ratio;
  let topPx=0, page=0;
  while(topPx < canvas.height){
    const hPx = Math.min(pagePx, canvas.height-topPx);
    const pageCanvas=document.createElement('canvas');
    pageCanvas.width=canvas.width; pageCanvas.height=hPx;
    pageCanvas.getContext('2d').drawImage(canvas,0,topPx,canvas.width,hPx,0,0,canvas.width,hPx);
    const pageImg=pageCanvas.toDataURL('image/jpeg',0.95);
    if(page>0) pdf.addPage();
    pdf.addImage(pageImg,'JPEG',0,0,imgW,hPx/ratio);
    topPx += hPx; page++;
  }

  // Page 2: Terms & Conditions ONLY
  pdf.addPage();
  pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
  pdf.text('Terms & Conditions (Summary)', 14, 16);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  const terms = [
    "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
    "2. Customer responsible for providing safe access to all work areas.",
    "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
    "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
    "5. Payment terms: unless otherwise stated, balance due on completion.",
    "6. Materials remain property of WARM UP UK until paid in full.",
    "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
    "8. By signing, the customer confirms accuracy of details and authorises the work as described."
  ];
  const left=14, width=pdf.internal.pageSize.getWidth()-28; let y=26;
  terms.forEach(t=>{ const lines=pdf.splitTextToSize(t,width); pdf.text(lines,left,y); y+=7+(lines.length-1)*5; });

  pdf.save(`${el('contractNo').value}.pdf`);
});

/* Init totals once */
recalcTotals();
</script>
</body>
</html>
