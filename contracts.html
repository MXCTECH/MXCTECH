<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37; /* gold-ish */
    --danger:#d90000;
    --line:#e8e8e8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0;
    background:#f7f7f8;
    color:#111;
    -webkit-font-smoothing:antialiased;
    overscroll-behavior:contain;
  }
  input, select, textarea, button { font-size:16px; } /* stop iOS zoom */

  .sheet{
    max-width: 900px;
    margin: 16px auto;
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    padding:16px;
    box-shadow:0 3px 12px rgba(0,0,0,.06);
  }
  header{
    display:flex; gap:16px; align-items:center;
    border-bottom:1px solid var(--line); padding-bottom:12px;
  }
  header img.logo{ width:120px; height:auto; object-fit:contain; }
  .brandblock{ flex:1; }
  .brandblock h1{ margin:0; font-size:26px; letter-spacing:.08em; }
  .brandblock .addr{ margin-top:6px; font-size:14px; line-height:1.35; color:#333; }

  .box{ background:#fafafa; border:1px solid var(--line); padding:10px; border-radius:8px;}
  .box label{display:block; font-size:12px; color:#555; margin-bottom:6px;}
  .box input, .box textarea, .box select{ width:100%; border:1px solid #ccc; border-radius:6px; padding:10px; }

  .meta{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
  .meta .box{ flex:1 1 280px; }

  .section-title{ font-weight:700; margin:18px 0 10px; font-size:16px; }

  /* --- Product lines (mobile-first cards) --- */
  .lines{ display:grid; gap:10px; }
  .line{ background:#fbfbfb; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .line .top select{ width:100%; }
  .line .bottom{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px; }
  .item label{ font-size:12px; color:#666; display:block; margin-bottom:4px; }
  .item input{ width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; }
  .total input{ background:#f1f1f1; font-weight:700; }

  /* widescreens show 3 across for bottom row */
  @media (min-width:720px){
    .line .bottom{ grid-template-columns:repeat(3,1fr); }
  }

  .controls{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 6px; }
  button{ border:0; background:#111; color:#fff; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
  button.secondary{ background:#2f2f2f;}
  button.danger{ background:var(--danger);}
  button:disabled{ opacity:.6; cursor:not-allowed;}

  .totals{ display:grid; grid-template-columns:1fr 280px; gap:12px; margin-top:12px; align-items:start;}
  .panel{ border:1px solid var(--line); border-radius:8px; padding:10px; background:#fafafa;}
  .summary{ border:1px solid var(--line); border-radius:8px; padding:10px; background:#fff; }
  .summary .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #e3e3e3; }
  .summary .row:last-child{ border-bottom:none;}
  .grand{ font-size:18px; font-weight:800;}
  .pound{ color:var(--accent); font-weight:800; }

  .notes, .tnc, .waiver, .signatures{ border:1px solid var(--line); border-radius:8px; padding:12px; background:#fff; margin-top:12px;}
  .notes textarea{ width:100%; min-height:120px; } /* wider notes */
  .tnc ol{ padding-left:18px; } .tnc li{ margin:6px 0; }
  .waiver{ border-color:var(--danger); position:relative;}
  .waiver .flash{
    position:absolute; top:8px; right:12px; font-weight:800; color:#fff; background:var(--danger); padding:4px 8px; border-radius:6px;
    animation:blink 1s infinite;
  }
  @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:.25} }
  .waiver.ack .flash{ display:none; }

  .signatures .sig-wrap{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .sig{ border:1px dashed #bbb; border-radius:8px; padding:10px; background:#fafafa; }
  .sig canvas{
    width:100%; height:200px; background:#fff; border:1px solid #ddd; border-radius:6px;
    touch-action:none;
  }
  .sig .sig-row{ display:flex; justify-content:space-between; align-items:center; margin-top:6px; gap:8px;}
  .footer-note{ text-align:center; font-size:12px; color:#777; margin-top:10px; }

  /* PDF capture wrapper */
  #capture{ padding:12px; }
  .avoid-break { break-inside: avoid; page-break-inside: avoid; }

  @media (max-width:720px){
    header{ align-items:flex-start; }
    .totals{ grid-template-columns:1fr; }
    .signatures .sig-wrap{ grid-template-columns:1fr; } /* stack signatures on mobile */
  }
</style>
</head>
<body>
  <div id="capture" class="sheet">
    <header>
      <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK logo" />
      <div class="brandblock">
        <h1>WARM UP UK</h1>
        <div class="addr">
          321-323 Romford High Road, Essex RM6 6AX<br />
          <strong>Tel:</strong> 01708 300670
        </div>
      </div>
      <div class="box" style="max-width:230px">
        <label>Contract #</label>
        <input id="contractNo" readonly />
        <label>Date</label>
        <input id="contractDate" readonly />
      </div>
    </header>

    <div class="meta">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
        <label>Property Address</label>
        <textarea id="custAddr" rows="3" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…" />
        <label>Email</label>
        <input id="custEmail" placeholder="email@example.com" />
      </div>
    </div>

    <div class="section-title">Products / Services</div>
    <div id="lines" class="lines"></div>
    <div class="controls">
      <button type="button" id="addRowBtn" class="secondary">+ Add Row</button>
      <button type="button" id="delRowBtn" class="secondary">− Remove Last</button>
    </div>

    <div class="totals">
      <div class="panel">
        <div class="section-title" style="margin-top:0">Options</div>
        <label style="display:flex; gap:10px; align-items:center;">
          <input type="checkbox" id="vatToggle" />
          Apply <strong>VAT 20%</strong>
        </label>
        <div class="fine">Admin Fee of <strong>£150</strong> is automatically applied.</div>
      </div>

      <div class="summary" id="totalsBox">
        <div class="row"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
        <div class="row"><div>Admin Fee</div><div>£ <span id="adminFee">150.00</span></div></div>
        <div class="row"><div>VAT (20%)</div><div>£ <span id="vatAmt">0.00</span></div></div>
        <div class="row grand"><div>Grand Total</div><div><span class="pound">£</span> <span id="grand">150.00</span></div></div>
      </div>
    </div>

    <div class="notes">
      <div class="section-title" style="margin-top:0">Notes</div>
      <textarea id="notes" rows="5" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <!-- Keep T&Cs in DOM for the user, but PDF puts them on page 2 -->
    <div class="tnc avoid-break" id="tnc">
      <div class="section-title" style="margin-top:0">Terms &amp; Conditions (Summary)</div>
      <ol>
        <li>All works to be carried out by or on behalf of WARM UP UK to agreed specification.</li>
        <li>Customer responsible for providing safe access to all work areas.</li>
        <li>Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.</li>
        <li>Electrical/ventilation upgrades, if required by building guidance, may be chargeable.</li>
        <li>Payment terms: unless otherwise stated, balance due on completion.</li>
        <li>Materials remain property of WARM UP UK until paid in full.</li>
        <li>Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.</li>
        <li>By signing, the customer confirms accuracy of details and authorises the work as described.</li>
      </ol>
    </div>

    <div class="waiver avoid-break" id="waiver">
      <div class="flash">ACTION REQUIRED</div>
      <div class="section-title" style="margin-top:0; color:var(--danger)">Express Waiver</div>
      <p style="margin:6px 0 10px">
        I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may
        affect my right to cancel once the work has started and materials have been ordered or installed.
      </p>
      <label style="display:flex; gap:10px; align-items:center; font-weight:600;">
        <input type="checkbox" id="waiverAck" />
        I acknowledge and accept the Express Waiver.
      </label>
    </div>

    <div class="signatures avoid-break">
      <div class="section-title" style="margin-top:0">Signatures</div>
      <div class="sig-wrap">
        <div class="sig">
          <label><strong>Customer Signature</strong></label>
          <canvas id="sigCustomer"></canvas>
          <div class="sig-row">
            <input id="sigCustName" placeholder="Customer printed name" />
            <button type="button" class="secondary" data-clear="sigCustomer">Clear</button>
          </div>
        </div>
        <div class="sig">
          <label><strong>Company Signature</strong></label>
          <canvas id="sigCompany"></canvas>
          <div class="sig-row">
            <input id="sigCompName" placeholder="Company representative" />
            <button type="button" class="secondary" data-clear="sigCompany">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="pdfBtn" type="button" disabled>Generate PDF</button>
      <button id="clearBtn" type="button" class="danger">Clear Form</button>
    </div>

    <div class="footer-note">
      WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670
    </div>
  </div>

<script>
(function(){
  // ----- Constants -----
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin Treatment",
    "Timber Treatment"
  ];
  const ADMIN_FEE = 150;
  const VAT_RATE = 0.20;

  // ----- El refs -----
  const linesEl = document.getElementById('lines');
  const addRowBtn = document.getElementById('addRowBtn');
  const delRowBtn = document.getElementById('delRowBtn');
  const vatToggle = document.getElementById('vatToggle');
  const subtotalEl = document.getElementById('subtotal');
  const adminFeeEl = document.getElementById('adminFee');
  const vatAmtEl = document.getElementById('vatAmt');
  const grandEl = document.getElementById('grand');
  const waiverEl = document.getElementById('waiver');
  const waiverAck = document.getElementById('waiverAck');
  const pdfBtn = document.getElementById('pdfBtn');
  const clearBtn = document.getElementById('clearBtn');

  const contractNo = document.getElementById('contractNo');
  const contractDate = document.getElementById('contractDate');
  const custName = document.getElementById('custName');
  const custAddr = document.getElementById('custAddr');
  const custPhone = document.getElementById('custPhone');
  const custEmail = document.getElementById('custEmail');
  const notes = document.getElementById('notes');

  // ----- Contract number/date -----
  function genContractNo(){
    const d = new Date(); const pad=n=>String(n).padStart(2,'0');
    const core = `${String(d.getFullYear()).slice(-2)}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`;
    return `WUU-${core}-${Math.floor(1000+Math.random()*8999)}`;
  }
  function today(){
    const d=new Date(); const p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  }
  contractNo.value = genContractNo();
  contractDate.value = today();

  // ----- Product line helpers -----
  function makeSelect(){
    const sel = document.createElement('select');
    sel.innerHTML = PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
    return sel;
  }
  function currency(n){ return (Number(n||0)).toFixed(2); }

  function makeLine(){
    const line = document.createElement('div');
    line.className = 'line';

    const top = document.createElement('div');
    top.className = 'top';
    const sel = makeSelect();
    top.appendChild(sel);

    const bottom = document.createElement('div');
    bottom.className = 'bottom';

    const qtyBox = document.createElement('div');
    qtyBox.className = 'item qty';
    qtyBox.innerHTML = `<label>Qty</label><input type="number" min="0" step="1" value="0">`;

    const unitBox = document.createElement('div');
    unitBox.className = 'item unit';
    unitBox.innerHTML = `<label>Unit (£)</label><input type="number" min="0" step="0.01" value="0">`;

    const totalBox = document.createElement('div');
    totalBox.className = 'item total';
    totalBox.innerHTML = `<label>Line Total (£)</label><input type="text" value="0.00" readonly>`;

    bottom.append(qtyBox, unitBox, totalBox);
    line.append(top,bottom);

    function recalc(){
      const q = +qtyBox.querySelector('input').value || 0;
      const u = +unitBox.querySelector('input').value || 0;
      totalBox.querySelector('input').value = currency(q*u);
      updateTotals();
    }
    qtyBox.querySelector('input').addEventListener('input', recalc);
    unitBox.querySelector('input').addEventListener('input', recalc);
    sel.addEventListener('change', ()=>{}); // reserved

    return line;
  }

  function addRow(){ linesEl.appendChild(makeLine()); updateTotals(); }
  function removeRow(){
    if(linesEl.lastElementChild){ linesEl.removeChild(linesEl.lastElementChild); updateTotals(); }
  }
  addRowBtn.addEventListener('click', addRow);
  delRowBtn.addEventListener('click', removeRow);

  // start with 3 lines
  addRow(); addRow(); addRow();

  // ----- Totals -----
  function getSubtotal(){
    let s=0;
    linesEl.querySelectorAll('.line').forEach(l=>{
      const q = +l.querySelector('.qty input').value || 0;
      const u = +l.querySelector('.unit input').value || 0;
      s += q*u;
    });
    return s;
  }
  function updateTotals(){
    const subtotal = getSubtotal();
    const admin = ADMIN_FEE;
    const beforeVAT = subtotal + admin;
    const vat = vatToggle.checked ? beforeVAT * VAT_RATE : 0;
    const grand = beforeVAT + vat;

    subtotalEl.textContent = subtotal.toFixed(2);
    adminFeeEl.textContent = admin.toFixed(2);
    vatAmtEl.textContent = vat.toFixed(2);
    grandEl.textContent = grand.toFixed(2);
  }
  vatToggle.addEventListener('change', updateTotals);
  updateTotals();

  // ----- Waiver gate -----
  function updateWaiver(){
    if(waiverAck.checked){ waiverEl.classList.add('ack'); pdfBtn.disabled=false; }
    else { waiverEl.classList.remove('ack'); pdfBtn.disabled=true; }
  }
  waiverAck.addEventListener('change', updateWaiver);
  updateWaiver();

  // ----- Signature pads (simple, pixel-ratio aware) -----
  function makePad(canvas){
    const ctx = canvas.getContext('2d');
    let drawing=false, lastX=0, lastY=0;

    function resize(){
      const dpr = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    }
    resize(); window.addEventListener('resize', resize);

    function pos(e){
      const r = canvas.getBoundingClientRect();
      if(e.touches && e.touches[0]){
        return { x:e.touches[0].clientX - r.left, y:e.touches[0].clientY - r.top };
      }
      return { x:e.clientX - r.left, y:e.clientY - r.top };
    }
    function lockScroll(on){ document.body.style.overflow = on ? 'hidden' : ''; }

    function start(e){ drawing=true; lockScroll(true); const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
    function move(e){
      if(!drawing) return;
      const p=pos(e);
      ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
      lastX=p.x; lastY=p.y; e.preventDefault();
    }
    function end(){ drawing=false; lockScroll(false); }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end);

    return {
      clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); resize(); },
      toDataURL(){ return canvas.toDataURL('image/png'); }
    }
  }
  const sigCustomer = makePad(document.getElementById('sigCustomer'));
  const sigCompany  = makePad(document.getElementById('sigCompany'));
  document.querySelectorAll('[data-clear]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-clear');
      (id==='sigCustomer'?sigCustomer:sigCompany).clear();
    });
  });

  // ----- Bake canvases so signatures appear in html2canvas -----
  function bakeSignatures(){
    const swaps = [];
    document.querySelectorAll('canvas').forEach(cv=>{
      const img = document.createElement('img');
      img.src = cv.toDataURL('image/png');
      img.style.width = cv.style.width || (cv.width + 'px');
      img.style.height = cv.style.height || (cv.height + 'px');
      img.style.border = cv.style.border;
      img.style.borderRadius = cv.style.borderRadius;
      cv.parentNode.insertBefore(img, cv);
      cv.style.display = 'none';
      swaps.push({cv,img});
    });
    return function restore(){
      swaps.forEach(({cv,img})=>{ img.remove(); cv.style.display=''; });
    };
  }

  // ----- PDF (page 1 = contract bitmap, page 2 = T&Cs text) -----
  async function generatePDF(){
    if(!waiverAck.checked){ alert('Please acknowledge the Express Waiver before generating the PDF.'); return; }

    const node = document.getElementById('capture');
    const { jsPDF } = window.jspdf;
    const a4w=210, a4h=297;
    const pdf=new jsPDF('p','mm','a4');

    // Temporarily hide T&Cs when capturing page 1
    const tnc = document.getElementById('tnc');
    const tncPrevDisplay = tnc.style.display;
    tnc.style.display = 'none';

    // Bake signature canvases
    const restoreSigs = bakeSignatures();

    // Capture page 1
    const canvas = await html2canvas(node, {
      scale:2, useCORS:true, backgroundColor:'#ffffff',
      windowWidth: node.scrollWidth, windowHeight: node.scrollHeight
    });

    // restore UI
    restoreSigs();
    tnc.style.display = tncPrevDisplay || '';

    // Add page 1 (slice if tall)
    const imgData = canvas.toDataURL('image/png');
    const mmPerPx = a4w / canvas.width;
    const imgH = canvas.height * mmPerPx;

    if(imgH <= a4h){
      pdf.addImage(imgData, 'PNG', 0, 0, a4w, imgH);
    } else {
      let topPx = 0; const pageHeightPx = a4h / mmPerPx;
      while(topPx < canvas.height){
        const sliceHeightPx = Math.min(pageHeightPx, canvas.height - topPx);
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width; pageCanvas.height = sliceHeightPx;
        pageCanvas.getContext('2d').drawImage(canvas, 0, topPx, canvas.width, sliceHeightPx, 0, 0, canvas.width, sliceHeightPx);
        const pageImg = pageCanvas.toDataURL('image/png');
        if(topPx>0) pdf.addPage();
        pdf.addImage(pageImg, 'PNG', 0, 0, a4w, sliceHeightPx*mmPerPx);
        topPx += sliceHeightPx;
      }
    }

    // Force a clean T&Cs page at the end
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Terms & Conditions (Summary)', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);

    const terms = [
      "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
      "2. Customer responsible for providing safe access to all work areas.",
      "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
      "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
      "5. Payment terms: unless otherwise stated, balance due on completion.",
      "6. Materials remain property of WARM UP UK until paid in full.",
      "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
      "8. By signing, the customer confirms accuracy of details and authorises the work as described."
    ];
    const left = 14, width = a4w - 28;
    let cursor = 26;
    terms.forEach(t=>{
      const lines = pdf.splitTextToSize(t, width);
      pdf.text(lines, left, cursor);
      cursor += 7 + (lines.length-1)*5;
    });

    pdf.save(`${contractNo.value}.pdf`);
  }
  document.getElementById('pdfBtn').addEventListener('click', generatePDF);

  // ----- Clear -----
  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    [custName,custAddr,custPhone,custEmail,notes].forEach(i=>i.value='');
    linesEl.innerHTML=''; addRow(); addRow(); addRow();
    vatToggle.checked=false; updateTotals();
    waiverAck.checked=false; updateWaiver();
    document.getElementById('sigCustName').value='';
    document.getElementById('sigCompName').value='';
    // wipe canvases
    document.querySelectorAll('canvas').forEach(cv=>{
      const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
    });
    contractNo.value = genContractNo(); contractDate.value = today();
    window.scrollTo({top:0,behavior:'smooth'});
  });
})();
</script>
</body>
</html>
