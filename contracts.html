<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37;
    --danger:#b00020;
    --line:#e8e8e8;
    --ink:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#f7f7f8;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  input,select,textarea,button{font-size:16px}

  .sheet{max-width:900px;margin:16px auto;background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 3px 12px rgba(0,0,0,.06)}
  header.top{display:flex;gap:16px;align-items:center;border-bottom:1px solid var(--line);padding-bottom:12px;flex-wrap:wrap}
  header.top img.logo{width:120px;height:auto;object-fit:contain}
  .brandblock{flex:1;min-width:220px}
  .brandblock h1{margin:0;font-size:32px;letter-spacing:.06em}
  .brandblock .addr{margin-top:6px;font-size:14px;line-height:1.35;color:#333}
  .box{background:#fafafa;border:1px solid var(--line);padding:10px;border-radius:8px}
  .box label{display:block;font-size:12px;color:#555;margin-bottom:6px}
  .box input{width:100%;border:1px solid #ccc;border-radius:6px;padding:10px}

  .meta{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .meta .box input,.meta .box textarea,.meta .box select{width:100%;border:1px solid #ccc;border-radius:6px;padding:10px}
  .section-title{font-weight:700;margin:18px 0 10px;font-size:16px}

  /* Product lines (card layout) */
  .lines{display:grid;gap:10px}
  .line{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fafafa}
  .line .top{margin-bottom:8px}
  .line .top select{width:100%;border:1px solid #ccc;border-radius:8px;padding:10px}
  .line .bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .line .bottom .field label{display:block;font-size:12px;color:#666;margin-bottom:4px}
  .line .bottom .field input{width:100%;border:1px solid #ccc;border-radius:8px;padding:10px}
  .line .bottom .total input{background:#f2f2f2;font-weight:700}

  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 6px}
  button{border:0;background:#111;color:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  button.secondary{background:#2f2f2f}
  button.danger{background:var(--danger)}
  button:disabled{opacity:.6;cursor:not-allowed}

  .totals{display:grid;grid-template-columns:1fr 280px;gap:12px;margin-top:12px;align-items:start}
  .panel{border:1px solid var(--line);border-radius:8px;padding:10px;background:#fff}
  .summary{border:1px solid var(--line);border-radius:8px;padding:10px;background:#fff}
  .summary .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #e3e3e3}
  .summary .row:last-child{border-bottom:none}
  .grand{font-size:18px;font-weight:800}
  .pound{color:var(--accent);font-weight:800}

  .notes,.tnc,.waiver,.signatures{border:1px solid var(--line);border-radius:8px;padding:12px;background:#fff;margin-top:12px}
  .notes textarea{width:100%;min-height:140px}
  .tnc ol{padding-left:18px} .tnc li{margin:6px 0}

  .waiver{border-color:#d90000;background:#fff7f7;position:relative}
  .waiver .flash{position:absolute;top:8px;right:12px;font-weight:800;color:#fff;background:#d90000;padding:4px 8px;border-radius:6px;animation:blink 1s infinite}
  @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:.25}}
  .waiver.ack .flash{display:none}

  .signatures .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sig{border:1px dashed #bbb;border-radius:8px;padding:10px;background:#fafafa}
  .sig label{display:block;margin-bottom:6px;font-weight:700}
  .sig canvas{width:100%;height:200px;background:#fff;border:1px solid #ddd;border-radius:6px;touch-action:none}
  .sig .row{display:flex;gap:8px;margin-top:6px}
  .sig .row input{flex:1;border:1px solid #ccc;border-radius:8px;padding:10px}

  .footer-note{text-align:center;font-size:12px;color:#777;margin-top:10px}

  /* PDF capture root */
  #capture{padding:12px}

  /* Mobile tweaks */
  @media (max-width:720px){
    /* move contract/date under header and ABOVE customer section */
    header.top{flex-direction:column;align-items:flex-start}
    .meta{grid-template-columns:1fr}
    .totals{grid-template-columns:1fr}
    .signatures .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div id="capture" class="sheet">
    <!-- HEADER -->
    <header class="top">
      <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK logo" />
      <div class="brandblock">
        <h1>WARM UP UK</h1>
        <div class="addr">
          321-323 Romford High Road, Essex RM6 6AX<br />
          <strong>Tel:</strong> <a href="tel:01708300670">01708 300670</a>
        </div>
      </div>

      <!-- Contract/date card (floats right on desktop, sits under header on mobile) -->
      <div class="box" id="contractCard" style="max-width:260px">
        <label>Contract #</label>
        <input id="contractNo" readonly />
        <label style="margin-top:8px">Date</label>
        <input id="contractDate" readonly />
      </div>
    </header>

    <!-- On phones we also show the contract/date again directly above customer form by moving the same card with JS (not duplicating). -->

    <!-- CUSTOMER -->
    <div class="meta" id="customerMeta">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
        <label style="margin-top:8px">Property Address</label>
        <textarea id="custAddr" rows="3" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…" />
        <label style="margin-top:8px">Email</label>
        <input id="custEmail" placeholder="email@example.com" />
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="section-title">Products / Services</div>
    <div id="lines" class="lines"></div>
    <div class="controls">
      <button type="button" id="addLineBtn" class="secondary">+ Add Row</button>
      <button type="button" id="delLineBtn" class="secondary">− Remove Last</button>
    </div>

    <!-- OPTIONS + TOTALS -->
    <div class="totals">
      <div class="panel">
        <div class="section-title" style="margin-top:0">Options</div>
        <label style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="vatToggle" />
          Apply <strong>VAT 20%</strong>
        </label>
        <div style="font-size:12px;color:#666;margin-top:6px">Admin Fee of <strong>£150</strong> is automatically applied.</div>
      </div>

      <div class="summary" id="totalsBox">
        <div class="row"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
        <div class="row"><div>Admin Fee</div><div>£ <span id="adminFee">150.00</span></div></div>
        <div class="row"><div>VAT (20%)</div><div>£ <span id="vatAmt">0.00</span></div></div>
        <div class="row grand"><div>Grand Total</div><div><span class="pound">£</span> <span id="grand">150.00</span></div></div>
      </div>
    </div>

    <!-- NOTES (wider) -->
    <div class="notes">
      <div class="section-title" style="margin-top:0">Notes</div>
      <textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <!-- T&Cs -->
    <div class="tnc">
      <div class="section-title" style="margin-top:0">Terms &amp; Conditions (Summary)</div>
      <ol>
        <li>All works to be carried out by or on behalf of WARM UP UK to agreed specification.</li>
        <li>Customer responsible for providing safe access to all work areas.</li>
        <li>Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.</li>
        <li>Electrical/ventilation upgrades, if required by building guidance, may be chargeable.</li>
        <li>Payment terms: unless otherwise stated, balance due on completion.</li>
        <li>Materials remain property of WARM UP UK until paid in full.</li>
        <li>Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.</li>
        <li>By signing, the customer confirms accuracy of details and authorises the work as described.</li>
      </ol>
    </div>

    <!-- WAIVER -->
    <div id="waiver" class="waiver">
      <div class="flash">ACTION REQUIRED</div>
      <div class="section-title" style="margin-top:0;color:#b00020">Express Waiver</div>
      <p style="margin:6px 0 10px">
        I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may
        affect my right to cancel once the work has started and materials have been ordered or installed.
      </p>
      <label style="display:flex;gap:10px;align-items:center;font-weight:600">
        <input type="checkbox" id="waiverAck" />
        I acknowledge and accept the Express Waiver.
      </label>
    </div>

    <!-- SIGNATURES (stack on mobile) -->
    <div class="signatures">
      <div class="section-title" style="margin-top:0">Signatures</div>
      <div class="grid">
        <div class="sig">
          <label>Customer Signature</label>
          <canvas id="sigCustomer"></canvas>
          <div class="row">
            <input id="sigCustName" placeholder="Customer printed name" />
            <button class="secondary" id="clearCust" type="button">Clear</button>
          </div>
        </div>
        <div class="sig">
          <label>Company Signature</label>
          <canvas id="sigCompany"></canvas>
          <div class="row">
            <input id="sigCompName" placeholder="Company representative" />
            <button class="secondary" id="clearComp" type="button">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="controls">
      <button id="pdfBtn" type="button" disabled>Generate PDF</button>
      <button id="clearBtn" type="button" class="danger">Clear Form</button>
    </div>

    <div class="footer-note">
      WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670
    </div>
  </div>

<script>
(function(){
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin Treatment",
    "Timber Treatment"
  ];
  const ADMIN_FEE = 150, VAT_RATE = 0.20;

  // Header: put contract card above customer on phones (no duplication)
  function relocateContractCard(){
    const card = document.getElementById('contractCard');
    const meta = document.getElementById('customerMeta');
    if(window.innerWidth <= 720){
      if(card.nextElementSibling !== meta) meta.parentNode.insertBefore(card, meta);
    }else{
      const header = document.querySelector('header.top');
      if(card.parentNode !== header) header.appendChild(card);
    }
  }
  window.addEventListener('resize', relocateContractCard);
  relocateContractCard();

  // Contract #
  const contractNo = document.getElementById('contractNo');
  const contractDate = document.getElementById('contractDate');
  function genContractNo(){
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    return `WUU-${String(d.getFullYear()).slice(-2)}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}-${Math.floor(1000+Math.random()*8999)}`;
  }
  contractNo.value = genContractNo();
  contractDate.value = new Date().toISOString().slice(0,10);

  // Lines
  const linesEl = document.getElementById('lines');
  function makeLine(def={}){
    const wrap = document.createElement('div'); wrap.className='line';

    const top = document.createElement('div'); top.className='top';
    const sel = document.createElement('select');
    sel.innerHTML = PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
    if(def.product) sel.value = def.product;
    top.appendChild(sel);

    const bottom = document.createElement('div'); bottom.className='bottom';

    const fQty = document.createElement('div'); fQty.className='field';
    fQty.innerHTML = `<label>Qty</label><input type="number" min="0" step="1" value="${def.qty||0}">`;

    const fUnit = document.createElement('div'); fUnit.className='field';
    fUnit.innerHTML = `<label>Unit (£)</label><input type="number" min="0" step="0.01" value="${def.unit||0}">`;

    const fTot = document.createElement('div'); fTot.className='field total';
    fTot.innerHTML = `<label>Line Total</label><input type="text" value="0.00" readonly>`;

    bottom.append(fQty,fUnit,fTot);
    wrap.append(top,bottom);

    const recalc = ()=>{
      const q = Number(fQty.querySelector('input').value||0);
      const u = Number(fUnit.querySelector('input').value||0);
      fTot.querySelector('input').value = (q*u).toFixed(2);
      updateTotals();
    };
    fQty.querySelector('input').addEventListener('input', recalc);
    fUnit.querySelector('input').addEventListener('input', recalc);
    sel.addEventListener('change', ()=>{ /* reserved */ });

    recalc();
    return wrap;
  }

  function addLine(){ linesEl.appendChild(makeLine()); updateTotals(); }
  function delLine(){ if(linesEl.lastElementChild){ linesEl.removeChild(linesEl.lastElementChild); updateTotals(); } }
  document.getElementById('addLineBtn').addEventListener('click', addLine);
  document.getElementById('delLineBtn').addEventListener('click', delLine);
  // start with 3 rows
  addLine(); addLine(); addLine();

  // Totals
  const subtotalEl = document.getElementById('subtotal');
  const adminFeeEl = document.getElementById('adminFee');
  const vatAmtEl = document.getElementById('vatAmt');
  const grandEl = document.getElementById('grand');
  const vatToggle = document.getElementById('vatToggle');

  function updateTotals(){
    let subtotal = 0;
    linesEl.querySelectorAll('.line').forEach(line=>{
      const q = Number(line.querySelector('.field input[type="number"]').value||0);
      const unit = Number(line.querySelectorAll('.field input[type="number"]')[1].value||0);
      const lt = q*unit;
      line.querySelector('.total input').value = lt.toFixed(2);
      subtotal += lt;
    });
    const admin = ADMIN_FEE;
    const beforeVAT = subtotal + admin;
    const vat = vatToggle.checked ? beforeVAT*VAT_RATE : 0;
    const grand = beforeVAT + vat;

    subtotalEl.textContent = subtotal.toFixed(2);
    adminFeeEl.textContent = admin.toFixed(2);
    vatAmtEl.textContent = vat.toFixed(2);
    grandEl.textContent = grand.toFixed(2);
  }
  vatToggle.addEventListener('change', updateTotals);

  // Waiver gate
  const waiverAck = document.getElementById('waiverAck');
  const waiverEl  = document.getElementById('waiver');
  const pdfBtn    = document.getElementById('pdfBtn');
  function updateWaiver(){
    if(waiverAck.checked){ waiverEl.classList.add('ack'); pdfBtn.disabled=false; }
    else { waiverEl.classList.remove('ack'); pdfBtn.disabled=true; }
  }
  waiverAck.addEventListener('change', updateWaiver); updateWaiver();

  // Simple signature pads (no resize during rotate = no wipe)
  function makePad(canvas){
    const ctx = canvas.getContext('2d');
    ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    let drawing=false,last=null;
    function p(e){
      const r=canvas.getBoundingClientRect();
      const t=e.touches?e.touches[0]:e;
      return {x:t.clientX-r.left,y:t.clientY-r.top};
    }
    function start(e){ drawing=true; last=p(e); e.preventDefault(); }
    function move(e){ if(!drawing) return; const cur=p(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(cur.x,cur.y); ctx.stroke(); last=cur; e.preventDefault(); }
    function end(){ drawing=false; }
    canvas.addEventListener('mousedown',start); window.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
    canvas.addEventListener('touchstart',start,{passive:false}); window.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',end);
    return {
      clear(){ const r=canvas.getBoundingClientRect(); ctx.clearRect(0,0,r.width,r.height); },
      dataURL(){ return canvas.toDataURL('image/png'); }
    };
  }
  const sigCustomer = makePad(document.getElementById('sigCustomer'));
  const sigCompany  = makePad(document.getElementById('sigCompany'));
  document.getElementById('clearCust').addEventListener('click', ()=>sigCustomer.clear());
  document.getElementById('clearComp').addEventListener('click', ()=>sigCompany.clear());

  // Convert canvases to <img> temporarily so html2canvas captures them
  function bakeSignatures(){
    const swaps=[];
    document.querySelectorAll('canvas').forEach(cv=>{
      const r=cv.getBoundingClientRect();
      const img=new Image();
      img.src=cv.toDataURL('image/png');
      img.style.width=r.width+'px'; img.style.height=r.height+'px';
      img.style.border=cv.style.border; img.style.borderRadius=cv.style.borderRadius;
      cv.style.display='none'; cv.parentNode.insertBefore(img,cv);
      swaps.push({cv,img});
    });
    return ()=>{ swaps.forEach(({cv,img})=>{ img.remove(); cv.style.display=''; }); };
  }

  // PDF
  async function generatePDF(){
    updateTotals();
    if(!waiverAck.checked){ alert('Please acknowledge the Express Waiver.'); return; }

    const restore = bakeSignatures(); // ensure signatures render
    const node = document.getElementById('capture');
    const { jsPDF } = window.jspdf;
    const a4w=210, a4h=297;
    const pdf=new jsPDF('p','mm','a4');

    const canvas = await html2canvas(node, {scale:2,backgroundColor:'#ffffff',useCORS:true,windowWidth:node.scrollWidth,windowHeight:node.scrollHeight});
    restore();

    const imgData = canvas.toDataURL('image/png');
    const mmPerPx = a4w / canvas.width;
    const imgH = canvas.height * mmPerPx;

    if(imgH <= a4h){
      pdf.addImage(imgData,'PNG',0,0,a4w,imgH);
    }else{
      let topPx = 0; const pageHeightPx = a4h / mmPerPx;
      while(topPx < canvas.height){
        const sliceHeightPx = Math.min(pageHeightPx, canvas.height - topPx);
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width; pageCanvas.height = sliceHeightPx;
        const ctx = pageCanvas.getContext('2d');
        ctx.drawImage(canvas,0,topPx,canvas.width,sliceHeightPx,0,0,canvas.width,sliceHeightPx);
        const pageImg = pageCanvas.toDataURL('image/png');
        if(topPx>0) pdf.addPage();
        pdf.addImage(pageImg,'PNG',0,0,a4w,sliceHeightPx*mmPerPx);
        topPx += sliceHeightPx;
      }
    }

    // Page 2: T&Cs (always)
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Terms & Conditions (Summary)', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
    const terms = [
      "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
      "2. Customer responsible for providing safe access to all work areas.",
      "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
      "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
      "5. Payment terms: unless otherwise stated, balance due on completion.",
      "6. Materials remain property of WARM UP UK until paid in full.",
      "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
      "8. By signing, the customer confirms accuracy of details and authorises the work as described."
    ];
    const left=14, width=pdf.internal.pageSize.getWidth()-28; let y=26;
    terms.forEach(t=>{ const lines=pdf.splitTextToSize(t,width); pdf.text(lines,left,y); y+=7+(lines.length-1)*5; });

    pdf.save(`${contractNo.value}.pdf`);
  }
  document.getElementById('pdfBtn').addEventListener('click', generatePDF);

  // Clear
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    ['custName','custAddr','custPhone','custEmail','notes','sigCustName','sigCompName'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    linesEl.innerHTML=''; addLine(); addLine(); addLine();
    document.getElementById('vatToggle').checked=false; updateTotals();
    waiverAck.checked=false; updateWaiver();
    sigCustomer.clear(); sigCompany.clear();
    contractNo.value = genContractNo(); contractDate.value = new Date().toISOString().slice(0,10);
    window.scrollTo({top:0,behavior:'smooth'});
  });

})();
</script>
</body>
</html>
