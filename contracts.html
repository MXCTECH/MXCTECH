<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37; /* gold */
    --danger:#d90000;
    --line:#e8e8e8;
    --ink:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0; background:#f7f7f8; color:var(--ink);
    -webkit-font-smoothing:antialiased; overscroll-behavior:contain;
  }
  /* Prevent iOS zoom on inputs */
  input, select, textarea, button { font-size:16px; }

  .sheet{ max-width: 900px; margin: 16px auto; background:#fff; border:1px solid #ddd; border-radius:12px; padding:16px; box-shadow:0 3px 12px rgba(0,0,0,.06); }
  header{
    display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:center;
    border-bottom:1px solid var(--line); padding-bottom:12px;
  }
  header img.logo{ width:180px; height:auto; object-fit:contain; } /* bigger logo (≈3× phone vs before) */
  .brandblock h1{ margin:0; font-size:30px; letter-spacing:.08em; }
  .brandblock .addr{ margin-top:6px; font-size:14px; line-height:1.35; color:#333; }
  .head-right{ width:230px; }
  .box{ background:#fafafa; border:1px solid var(--line); padding:10px; border-radius:8px;}
  .box label{display:block; font-size:12px; color:#555; margin-bottom:6px;}
  .box input, .box textarea, .box select{ width:100%; border:1px solid #ccc; border-radius:6px; padding:10px; background:#fff; }

  .section-title{ font-weight:700; margin:18px 0 10px; font-size:18px; }
  .subtle{ font-size:12px; color:#777; }

  /* Customer grid */
  .meta{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .meta .box{ min-height:100%; }

  /* Products */
  .lines-wrap{ border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; }
  .line{ border:1px solid var(--line); border-radius:10px; padding:10px; background:#fafafa; margin-bottom:12px; }
  .line .rowlabel{ font-weight:600; margin-bottom:6px; }
  .line select{ width:100%; border:1px solid #ccc; border-radius:8px; padding:10px; background:#fff; }
  .line .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; }
  .line .grid3 .fld label{ display:block; font-size:12px; color:#555; margin-bottom:6px;}
  .line .grid3 .fld input{ width:100%; border:1px solid #ccc; border-radius:8px; padding:10px; }
  .line .grid3 .fld.readonly input{ background:#f2f2f2; font-weight:700; }

  .controls{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0; }
  button{ border:0; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:800; }
  .btn-gold{ background:var(--accent); color:#000; }
  .btn-dark{ background:#111; color:#fff; }
  .btn-danger{ background:#b00020; color:#fff; }

  /* Options / Totals */
  .panel{ border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; }
  .opt-row{ display:flex; align-items:center; gap:10px; }
  .totals{ border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; margin-top:12px; }
  .totals .row{ display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #e3e3e3; }
  .totals .row:last-child{ border-bottom:none; }
  .totals .grand{ font-size:20px; font-weight:900; }
  .totals .value{ min-width:120px; text-align:right; font-variant-numeric:tabular-nums; }

  .notes{ border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; margin-top:12px; }
  .notes textarea{ width:100%; min-height:140px; border:1px solid #ccc; border-radius:8px; padding:10px; }

  .waiver{ border:2px solid var(--danger); background:#fff7f7; border-radius:10px; padding:12px; margin-top:12px;}
  .waiver h3{margin:0 0 6px; font-size:16px; color:#b00020}
  .waiver p{margin:6px 0 10px; font-size:14px; line-height:1.35}

  .sign-wrap{ border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; margin-top:12px;}
  .sigs{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .sig{ border:1px dashed #bbb; border-radius:8px; padding:10px; background:#fafafa; }
  .sig label{ font-weight:700; display:block; margin-bottom:6px; }
  .sig canvas{ width:100%; height:200px; background:#fff; border:1px solid #ddd; border-radius:6px; touch-action:none; }
  .sig .under{ display:flex; gap:8px; margin-top:6px; align-items:center; }
  .sig .under input{ flex:1; border:1px solid #ccc; border-radius:8px; padding:10px; }
  .sig .under button{ padding:10px 12px; }

  .footer-note{ text-align:center; font-size:12px; color:#777; margin-top:10px; }

  /* PDF capture wrapper */
  #capture{ padding:12px; }

  @media (max-width:760px){
    header{ grid-template-columns:auto 1fr; grid-template-rows:auto auto; }
    .head-right{ grid-column:1 / -1; width:100%; }
    .meta{ grid-template-columns:1fr; }
    .sigs{ grid-template-columns:1fr; } /* stack customer & company on phones */
    .line .grid3{ grid-template-columns:1fr; } /* stack qty/unit/total under product on phones */
    .notes textarea{ min-height:170px; } /* wider/taller notes on phones */
  }
</style>
</head>
<body>
  <div id="capture" class="sheet">
    <header>
      <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK logo" />
      <div class="brandblock">
        <h1>WARM UP UK</h1>
        <div class="addr">
          321-323 Romford High Road, Essex RM6 6AX<br />
          <strong>Tel:</strong> <a href="tel:01708300670">01708 300670</a>
        </div>
      </div>
      <div class="head-right box">
        <label>Contract #</label>
        <input id="contractNo" readonly />
        <label>Date</label>
        <input id="contractDate" readonly />
      </div>
    </header>

    <div class="section-title">Customer</div>
    <div class="meta">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
        <label>Property Address</label>
        <textarea id="custAddr" rows="3" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…" />
        <label>Email</label>
        <input id="custEmail" placeholder="email@example.com" />
      </div>
    </div>

    <div class="section-title">Products / Services</div>
    <div class="lines-wrap" id="linesWrap">
      <div id="lines"></div>
      <div class="controls">
        <button type="button" id="addLineBtn" class="btn-gold">+ Add Line</button>
        <button type="button" id="removeLineBtn" class="btn-gold">− Remove Last</button>
        <button type="button" id="clearLinesBtn" class="btn-danger">Clear Lines</button>
      </div>
      <div class="subtle" style="margin-top:6px">Qty, Unit £, and Line Total sit under each product for phone layouts.</div>
    </div>

    <div class="section-title">Options</div>
    <div class="panel">
      <div class="opt-row" style="margin-bottom:10px">
        <input type="checkbox" id="vatToggle" />
        <label for="vatToggle">Apply <strong>VAT 20%</strong></label>
      </div>
      <div class="subtle" style="margin-bottom:10px">Admin Fee of <strong>£150</strong> is automatically applied.</div>

      <label style="display:block; font-size:12px; color:#555; margin:8px 0 6px;">Install Date</label>
      <input id="installDate" type="date" style="width:260px; border:1px solid #ccc; border-radius:8px; padding:10px;" />
    </div>

    <div class="section-title">Totals</div>
    <div class="totals" id="totalsBox">
      <div class="row"><div>Subtotal</div><div class="value">£ <span id="subtotal">0.00</span></div></div>
      <div class="row"><div>Admin Fee</div><div class="value">£ <span id="adminFee">150.00</span></div></div>
      <div class="row"><div>VAT (20%)</div><div class="value">£ <span id="vatAmt">0.00</span></div></div>
      <div class="row grand"><div>Grand Total</div><div class="value"><span style="color:var(--accent); font-weight:900">£</span> <span id="grand">150.00</span></div></div>
      <div class="row">
        <div>Less Deposit</div>
        <div class="value" style="display:flex; gap:6px; justify-content:flex-end; align-items:center">
          £ <input id="deposit" type="number" min="0" step="0.01" value="0" style="width:120px; text-align:right; border:1px solid #ccc; border-radius:8px; padding:8px 10px;">
        </div>
      </div>
      <div class="row"><div><strong>Balance Due</strong></div><div class="value"><strong>£ <span id="balance">150.00</span></strong></div></div>
    </div>

    <div class="notes">
      <div style="font-weight:700; margin-bottom:6px;">Notes</div>
      <textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <div class="waiver">
      <h3>Express Waiver</h3>
      <p>I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may affect my right to cancel once the work has started and materials have been ordered or installed.</p>
      <label style="display:flex; gap:10px; align-items:center; font-weight:600;">
        <input type="checkbox" id="waiverAck" />
        I acknowledge and accept the Express Waiver.
      </label>
    </div>

    <div class="sign-wrap">
      <div class="section-title" style="margin:0 0 10px">Signatures</div>
      <div class="sigs">
        <div class="sig">
          <label>Customer Signature</label>
          <canvas id="sigCustomer"></canvas>
          <div class="under">
            <input id="sigCustName" placeholder="Customer printed name" />
            <button type="button" class="btn-dark" data-clear="sigCustomer">Clear</button>
          </div>
        </div>
        <div class="sig">
          <label>Company Signature</label>
          <canvas id="sigCompany"></canvas>
          <div class="under">
            <input id="sigCompName" placeholder="Company representative" />
            <button type="button" class="btn-dark" data-clear="sigCompany">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="controls" style="margin-top:14px">
      <button id="pdfBtn" class="btn-dark">Generate PDF</button>
      <button id="clearBtn" class="btn-danger">Clear Form</button>
    </div>

    <div class="footer-note">
      WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670
    </div>
  </div>

<script>
(function(){
  /* ------------------ CONSTANTS ------------------ */
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin Treatment",
    "Timber Treatment"
  ];
  const ADMIN_FEE = 150;
  const VAT_RATE = 0.20;

  /* ------------------ HEADER AUTO FIELDS ------------------ */
  const contractNo = document.getElementById('contractNo');
  const contractDate = document.getElementById('contractDate');

  const pad = n => String(n).padStart(2,'0');
  function formatDDMMYYYY(d){
    return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
  }
  function genContractNo(){
    const d = new Date();
    const core = `${String(d.getFullYear()).slice(-2)}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`;
    return `WUU-${core}-${Math.floor(1000+Math.random()*9000)}`;
  }
  function fillHeader(){
    const d = new Date();
    contractNo.value = genContractNo();
    contractDate.value = formatDDMMYYYY(d); // DD-MM-YYYY per your request
    // default install date = today
    document.getElementById('installDate').valueAsDate = d;
  }
  fillHeader();

  /* ------------------ PRODUCT LINES ------------------ */
  const linesEl = document.getElementById('lines');
  const addLineBtn = document.getElementById('addLineBtn');
  const removeLineBtn = document.getElementById('removeLineBtn');
  const clearLinesBtn = document.getElementById('clearLinesBtn');

  function makeSelect(){
    const sel = document.createElement('select');
    sel.innerHTML = `<option value="" disabled selected>Choose a product…</option>` +
      PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
    return sel;
  }

  function makeLine(){
    const wrap = document.createElement('div');
    wrap.className = 'line';

    const prodLbl = document.createElement('div');
    prodLbl.className = 'rowlabel';
    prodLbl.textContent = 'Product';

    const sel = makeSelect();

    const grid = document.createElement('div');
    grid.className = 'grid3';

    const fldQty = document.createElement('div');
    fldQty.className = 'fld';
    fldQty.innerHTML = `<label>Qty</label><input type="number" min="0" step="1" value="0">`;

    const fldUnit = document.createElement('div');
    fldUnit.className = 'fld';
    fldUnit.innerHTML = `<label>Unit £</label><input type="number" min="0" step="0.01" value="0">`;

    const fldTot = document.createElement('div');
    fldTot.className = 'fld readonly';
    fldTot.innerHTML = `<label>Line Total</label><input type="text" value="0.00" readonly>`;

    grid.append(fldQty, fldUnit, fldTot);
    wrap.append(prodLbl, sel, grid);

    // listeners
    function recalcLine(){
      const q = parseFloat(fldQty.querySelector('input').value || 0);
      const u = parseFloat(fldUnit.querySelector('input').value || 0);
      const line = (isNaN(q)?0:q) * (isNaN(u)?0:u);
      fldTot.querySelector('input').value = line.toFixed(2);
      updateTotals();
    }
    fldQty.querySelector('input').addEventListener('input', recalcLine);
    fldUnit.querySelector('input').addEventListener('input', recalcLine);
    sel.addEventListener('change', ()=>{}); // reserved

    return wrap;
  }

  function addLine(){ linesEl.appendChild(makeLine()); updateTotals(); }
  function removeLine(){ if(linesEl.lastElementChild){ linesEl.lastElementChild.remove(); updateTotals(); } }
  function clearLines(){ linesEl.innerHTML=''; addLine(); updateTotals(); }

  addLineBtn.addEventListener('click', addLine);
  removeLineBtn.addEventListener('click', removeLine);
  clearLinesBtn.addEventListener('click', clearLines);

  // start with 3 lines
  addLine(); addLine(); addLine();

  /* ------------------ TOTALS ------------------ */
  const subtotalEl = document.getElementById('subtotal');
  const adminFeeEl = document.getElementById('adminFee');
  const vatAmtEl = document.getElementById('vatAmt');
  const grandEl = document.getElementById('grand');
  const balanceEl = document.getElementById('balance');
  const depositEl = document.getElementById('deposit');
  const vatToggle = document.getElementById('vatToggle');

  function num(v){ const n = parseFloat(v); return isNaN(n)?0:n; }

  function getSubtotal(){
    let s = 0;
    linesEl.querySelectorAll('.line').forEach(line=>{
      const q = num(line.querySelector('.fld:nth-child(1) input').value);
      const u = num(line.querySelector('.fld:nth-child(2) input').value);
      s += (q*u);
    });
    return s;
  }

  function updateTotals(){
    const subtotal = getSubtotal();
    const admin = ADMIN_FEE;
    const preVat = subtotal + admin;
    const vat = vatToggle.checked ? preVat * VAT_RATE : 0;
    const grand = preVat + vat;
    const deposit = num(depositEl.value);
    const balance = Math.max(grand - deposit, 0);

    subtotalEl.textContent = subtotal.toFixed(2);
    adminFeeEl.textContent = admin.toFixed(2);
    vatAmtEl.textContent = vat.toFixed(2);
    grandEl.textContent = grand.toFixed(2);
    balanceEl.textContent = balance.toFixed(2);
  }
  vatToggle.addEventListener('change', updateTotals);
  depositEl.addEventListener('input', updateTotals);

  /* ------------------ SIGNATURE PADS ------------------ */
  function makePad(canvas){
    const ctx = canvas.getContext('2d');
    let drawing=false, lastX=0, lastY=0;

    function resize(){
      const dpr = Math.max(window.devicePixelRatio||1,1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width*dpr);
      canvas.height= Math.round(rect.height*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    }
    resize(); window.addEventListener('resize', resize);

    function pos(e){
      const r = canvas.getBoundingClientRect();
      if(e.touches && e.touches[0]) return {x:e.touches[0].clientX - r.left, y:e.touches[0].clientY - r.top};
      return {x:e.clientX - r.left, y:e.clientY - r.top};
    }
    function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
    function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault();}
    function end(){ drawing=false; }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end);

    return {
      clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); resize(); },
      toDataURL(){ return canvas.toDataURL('image/png'); }
    };
  }
  const sigCustomer = makePad(document.getElementById('sigCustomer'));
  const sigCompany  = makePad(document.getElementById('sigCompany'));
  document.querySelectorAll('[data-clear]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-clear');
      (id==='sigCustomer'?sigCustomer:sigCompany).clear();
    });
  });

  /* ------------------ PDF (page1: everything up to waiver+totals; page2+: T&Cs + smaller stacked signatures) ------------------ */
  const pdfBtn = document.getElementById('pdfBtn');
  pdfBtn.addEventListener('click', async ()=>{
    // bake canvases as images so signatures appear in html2canvas
    const swaps = [];
    document.querySelectorAll('canvas').forEach(cv=>{
      const img = document.createElement('img');
      img.src = cv.toDataURL('image/png');
      img.style.width = cv.style.width || (cv.width + 'px');
      img.style.height = cv.style.height || (cv.height + 'px');
      img.style.border = cv.style.border; img.style.borderRadius = cv.style.borderRadius;
      cv.parentNode.insertBefore(img, cv); cv.style.display='none';
      swaps.push({cv,img});
    });

    // capture whole node
    const node = document.getElementById('capture');
    const canvas = await html2canvas(node, { scale:2, useCORS:true, backgroundColor:'#ffffff',
      windowWidth: node.scrollWidth, windowHeight: node.scrollHeight });

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const a4w=210, a4h=297;

    // slice long canvas into pages
    const mmPerPx = a4w / canvas.width;
    const pageHeightPx = a4h / mmPerPx;
    let topPx = 0, first=true;
    while(topPx < canvas.height){
      const sliceHeightPx = Math.min(pageHeightPx, canvas.height - topPx);
      const pageCanvas = document.createElement('canvas');
      pageCanvas.width = canvas.width; pageCanvas.height = sliceHeightPx;
      const ctx = pageCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, topPx, canvas.width, sliceHeightPx, 0, 0, canvas.width, sliceHeightPx);
      const pageImg = pageCanvas.toDataURL('image/jpeg', 0.95);
      if(!first) pdf.addPage();
      pdf.addImage(pageImg, 'JPEG', 0, 0, a4w, sliceHeightPx*mmPerPx);
      first=false; topPx += sliceHeightPx;
    }

    /* Terms & Conditions page (force separate), then compact stacked signature recap */
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Terms & Conditions (Summary)', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
    const terms = [
      "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
      "2. Customer responsible for providing safe access to all work areas.",
      "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
      "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
      "5. Payment terms: unless otherwise stated, balance due on completion.",
      "6. Materials remain property of WARM UP UK until paid in full.",
      "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
      "8. By signing, the customer confirms accuracy of details and authorises the work as described."
    ];
    const left = 14, width = a4w - 28;
    let y = 26;
    terms.forEach(t=>{
      const lines = pdf.splitTextToSize(t, width);
      pdf.text(lines, left, y);
      y += 7 + (lines.length-1)*5;
    });

    // Small stacked signature recap (page 3)
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Signatures', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);

    // grab the baked images (now present right before hidden canvases)
    const imgs = Array.from(document.querySelectorAll('canvas')).map(cv => cv.previousSibling).filter(n=>n && n.tagName==='IMG');
    const custImg = imgs[0]; const compImg = imgs[1];

    if(custImg){
      const img1 = custImg.src;
      pdf.text('Customer Signature:', 14, 28);
      pdf.addImage(img1, 'PNG', 14, 32, 182, 40); // smaller
    }
    if(compImg){
      const img2 = compImg.src;
      pdf.text('Company Signature:', 14, 78);
      pdf.addImage(img2, 'PNG', 14, 82, 182, 40);
    }

    pdf.save(`${contractNo.value}.pdf`);

    // restore canvases
    swaps.forEach(({cv,img})=>{ img.remove(); cv.style.display=''; });
  });

  /* ------------------ CLEAR ------------------ */
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    document.getElementById('custName').value='';
    document.getElementById('custAddr').value='';
    document.getElementById('custPhone').value='';
    document.getElementById('custEmail').value='';
    document.getElementById('notes').value='';
    document.getElementById('waiverAck').checked=false;
    document.getElementById('vatToggle').checked=false;
    depositEl.value='0';
    sigCustomer.clear(); sigCompany.clear();
    linesEl.innerHTML=''; addLine(); addLine(); addLine();
    fillHeader();
    updateTotals();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* Kick initial calc */
  updateTotals();
})();
</script>
</body>
</html>
