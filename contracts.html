<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Contract Order Form</title>

  <!-- Minimal reset + tidy mobile-friendly styles -->
  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --ink:#222;
      --muted:#6b7280;
      --brand:#b89112; /* gold-ish */
      --line:#e5e7eb;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .wrap{max-width:840px;margin:24px auto 120px;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 4px 18px rgba(0,0,0,.06);padding:22px}
    h1{margin:0 0 12px;font-size:28px}
    h2{margin:0 0 14px;font-size:22px}
    h3{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{display:block;font-weight:600;margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:12px 14px;border:1px dashed #cfd3d8;border-radius:12px;background:#fff;outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .muted{color:var(--muted);font-size:14px}
    .bar{
      position:sticky;bottom:0;left:0;right:0;display:flex;gap:14px;justify-content:center;
      padding:14px;backdrop-filter:saturate(160%) blur(8px);background:rgba(255,255,255,.85);border-top:1px solid var(--line);z-index:50;
    }
    .btn{
      padding:14px 18px;border-radius:14px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer;
    }
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn:active{transform:translateY(1px)}
    .section{margin:18px 0 22px}
    .sig-card{
      border:1px solid #e5e5e5;border-radius:14px;padding:16px 16px 6px;background:#fff;
    }
    .sig-head{font-weight:700;margin:0 0 8px}
    .sig-pad{
      position:relative;border:2px dashed #d1d5db;border-radius:12px;background:#fafafa;height:220px; /* visible height */
      display:block;overflow:hidden;
    }
    canvas.signature{display:block;width:100%;height:100%;touch-action:none; /* critical for iOS Safari */ }
    .sig-actions{display:flex;justify-content:flex-start;margin:10px 0 4px}
    .sig-actions .btn{padding:10px 12px}
    .badge{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:2px 10px;font-size:12px}
    .stack{display:grid;gap:14px}
    .footer{font-size:12px;color:var(--muted);margin-top:8px}
    .hr{height:1px;background:var(--line);margin:16px 0}
    .box{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff}
    .brandline{border-radius:12px;padding:12px 14px;background:#111;color:#fff;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
    .brandline .brand{font-weight:800;letter-spacing:.6px}
    .brandline .sub{font-size:12px;opacity:.8}
    .watermark{opacity:.06;font-weight:900;font-size:40px;text-align:center;letter-spacing:2px}

    /* Keep signature block together on PDF */
    .avoid-break{break-inside:avoid-page;page-break-inside:avoid}

    /* Print/PDF tweaks */
    @media print{
      .bar{display:none}
      .card{box-shadow:none}
      a[href]:after{content:""}
    }

    /* Small iPhones safe spacing under bottom bar */
    .pb-safe{padding-bottom:80px}
  </style>

  <!-- html2pdf bundle (includes html2canvas & jsPDF) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="wrap pb-safe" id="pageRoot">
    <!-- HEADER / BRAND -->
    <div class="card">
      <div class="brandline">
        <div class="brand">WARM UP UK HOMES LIMITED</div>
        <div class="sub">Order Form & Contract</div>
      </div>

      <div class="row">
        <div class="col">
          <label>Customer Name</label>
          <input id="custName" placeholder="Full name" />
        </div>
        <div class="col">
          <label>Phone</label>
          <input id="custPhone" placeholder="07..." inputmode="tel" />
        </div>
        <div class="col">
          <label>Email</label>
          <input id="custEmail" type="email" placeholder="name@email.com" />
        </div>
        <div class="col">
          <label>Address</label>
          <input id="custAddr" placeholder="House & street, Town, Postcode" />
        </div>
      </div>

      <!-- ========= PRODUCTS: DROP-IN SLOT ========= -->
      <div class="section">
        <h2>Products</h2>
        <div id="PRODUCTS_SLOT" class="box">
          <!-- ▸▸▸ REPLACE THIS BLOCK WITH YOUR EXISTING PRODUCTS LAYOUT (unchanged).  ◂◂◂
               Leave the id="PRODUCTS_SLOT" on the wrapper. None of the JS depends on the inner layout.
               Your totals/logic can stay exactly as-is.
          -->
          <div class="muted">
            Products block placeholder (safe to delete). Paste your existing products table/rows here.
          </div>
        </div>
      </div>
      <!-- ========= / PRODUCTS ========= -->

      <!-- NOTES (optional, won’t affect layout) -->
      <div class="section">
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Special instructions, access, etc."></textarea>
      </div>

      <!-- SIGNATURES -->
      <div class="section avoid-break">
        <h2>Signatures</h2>

        <div class="stack">
          <div class="sig-card">
            <div class="sig-head">Customer Signature</div>
            <div class="sig-pad">
              <canvas id="sigCustomer" class="signature"></canvas>
            </div>
            <div class="sig-actions">
              <button class="btn" data-clear="sigCustomer">Clear</button>
              <span class="badge" id="sigCustomerStatus">Not signed</span>
            </div>
          </div>

          <div class="sig-card">
            <div class="sig-head">Company Representative Signature</div>
            <div class="sig-pad">
              <canvas id="sigRep" class="signature"></canvas>
            </div>
            <div class="sig-actions">
              <button class="btn" data-clear="sigRep">Clear</button>
              <span class="badge" id="sigRepStatus">Not signed</span>
            </div>
          </div>
        </div>

        <div class="footer">
          Tip: On iPhone/Android, use your finger or a stylus. If the page scrolls while signing,
          tap the pad once and try again—this pad disables scrolling while you draw.
        </div>
      </div>

      <div class="hr"></div>

      <!-- COMPANY DETAILS FOOTER -->
      <div class="row">
        <div class="col">
          <div><strong>Warm Up UK Homes Limited</strong></div>
          <div>Fitzwilliam House, Middle Bank, Doncaster, DN4 5NG</div>
          <div>Tel: 01708 300670 &nbsp;|&nbsp; Mob: 07470 474774</div>
          <div class="muted">mxctech.github.io</div>
        </div>
      </div>

      <div class="watermark">WARM UP UK</div>
    </div>
  </div>

  <!-- Sticky action bar -->
  <div class="bar">
    <button class="btn" id="clearForm">Clear Form</button>
    <button class="btn primary" id="makePdf">Generate PDF</button>
  </div>

  <script>
    /* ------------------------------
       Signature Pad (vanilla JS)
       Works on iOS + Android + desktop.
       No layout assumptions about Products.
    --------------------------------*/
    class SigPad {
      constructor(canvas, statusEl){
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.statusEl = statusEl;
        this.drawing = false;
        this.last = {x:0,y:0};
        this._resize();
        this._bind();
        this._markEmpty();
        // Re-scale on rotate/zoom
        window.addEventListener('resize', ()=>this._resize());
      }
      _resize(){
        // Scale for crisp lines on high-DPI screens
        const rect = this.canvas.getBoundingClientRect();
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        this.canvas.width  = Math.floor(rect.width  * ratio);
        this.canvas.height = Math.floor(rect.height * ratio);
        this.ctx.scale(ratio, ratio);
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.lineWidth = 2.2;
        this.ctx.strokeStyle = '#111';
        this.clear(false);
      }
      _pos(e){
        const rect = this.canvas.getBoundingClientRect();
        if (e.touches && e.touches.length){
          return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        } else {
          return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
      }
      _bind(){
        const c = this.canvas;

        const start = (e)=>{
          e.preventDefault();
          this.drawing = true;
          this.last = this._pos(e);
          this._markSigned();
        };
        const move = (e)=>{
          if(!this.drawing) return;
          e.preventDefault();
          const p = this._pos(e);
          this.ctx.beginPath();
          this.ctx.moveTo(this.last.x, this.last.y);
          this.ctx.lineTo(p.x, p.y);
          this.ctx.stroke();
          this.last = p;
        };
        const end = (e)=>{
          if(!this.drawing) return;
          e.preventDefault();
          this.drawing = false;
        };

        // Pointer events first
        c.addEventListener('pointerdown', start);
        c.addEventListener('pointermove', move);
        c.addEventListener('pointerup', end);
        c.addEventListener('pointerleave', end);

        // Fallback touch listeners (iOS)
        c.addEventListener('touchstart', start, {passive:false});
        c.addEventListener('touchmove',  move,  {passive:false});
        c.addEventListener('touchend',   end,   {passive:false});
        // Mouse fallback
        c.addEventListener('mousedown', start);
        c.addEventListener('mousemove', move);
        c.addEventListener('mouseup',   end);
        c.addEventListener('mouseleave',end);
      }
      _markEmpty(){
        if (this.statusEl) this.statusEl.textContent = 'Not signed';
      }
      _markSigned(){
        if (this.statusEl) this.statusEl.textContent = 'Signed';
      }
      clear(markEmpty=true){
        const rect = this.canvas.getBoundingClientRect();
        this.ctx.clearRect(0,0, this.canvas.width, this.canvas.height);
        if (markEmpty) this._markEmpty();
      }
      toDataURL(){
        // Use visible size for export
        const rect = this.canvas.getBoundingClientRect();
        const tmp = document.createElement('canvas');
        tmp.width = rect.width * (window.devicePixelRatio || 1);
        tmp.height = rect.height * (window.devicePixelRatio || 1);
        const tctx = tmp.getContext('2d');
        tctx.scale((window.devicePixelRatio || 1), (window.devicePixelRatio || 1));
        tctx.drawImage(this.canvas, 0, 0, rect.width, rect.height);
        return tmp.toDataURL('image/png');
      }
      isBlank(){
        // crude blank check: export and see if transparent PNG is tiny
        return this.toDataURL().length < 1200;
      }
    }

    // Init two pads
    const padCustomer = new SigPad(document.getElementById('sigCustomer'), document.getElementById('sigCustomerStatus'));
    const padRep      = new SigPad(document.getElementById('sigRep'),      document.getElementById('sigRepStatus'));

    // Clear buttons
    document.querySelectorAll('[data-clear]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-clear');
        if (id==='sigCustomer') padCustomer.clear();
        if (id==='sigRep')      padRep.clear();
      });
    });

    // Clear form (does not touch your Products internals)
    document.getElementById('clearForm').addEventListener('click', ()=>{
      ['custName','custPhone','custEmail','custAddr','notes'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      padCustomer.clear();
      padRep.clear();
      // If your products block has its own clear/reset, call it here (optional hook):
      if (window.resetProductsBlock) window.resetProductsBlock();
    });

    // Generate PDF — captures the visible card, preserving signatures (as canvas)
    document.getElementById('makePdf').addEventListener('click', async ()=>{
      // Ensure canvases are up-to-date for html2canvas
      // (html2canvas will rasterize canvases as they are)
      const opt = {
        margin:       8,
        filename:     `Contract_${(document.getElementById('custName')?.value||'customer').trim().replace(/\s+/g,'_')}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      const source = document.getElementById('pageRoot');
      await html2pdf().set(opt).from(source).save();
    });

    /* -------- OPTIONAL: if you need to programmatically inject your fixed product list
       WITHOUT changing layout, you can paste your HTML into the template string below.
       If you prefer to keep your current block, IGNORE this and just paste your section
       into the PRODUCTS_SLOT div in the markup.
    ------------------------------------------------------------------------------ */
    (function optionalProductDropIn(){
      const USE_PLACEHOLDER = true; // set to false if you’re pasting your own block in HTML
      if (!USE_PLACEHOLDER) return;
      const slot = document.getElementById('PRODUCTS_SLOT');
      if (!slot) return;

      // Lightweight placeholder (delete when you paste your own)
      slot.innerHTML = `
        <div class="muted" style="margin-bottom:10px">▼ Replace this with your existing products layout (unchanged).</div>
        <div class="row">
          <div class="col">
            <label>Product</label>
            <select>
              <option value="">Select…</option>
              <option>Loft Insulation 270mm Fibreglass</option>
              <option>Multifoil YBS SuperQuilt</option>
              <option>Pitched Roof TLX Silver</option>
              <option>Cavity Wall Insulation</option>
              <option>Spray Foam Removal</option>
              <option>Loft Boarding</option>
              <option>Ventilation Upgrade</option>
              <option>Vermin Treatment</option>
              <option>Timber Treatment</option>
            </select>
          </div>
          <div class="col">
            <label>Qty</label>
            <input inputmode="decimal" placeholder="e.g. 45" />
          </div>
          <div class="col">
            <label>Unit £</label>
            <input inputmode="decimal" placeholder="e.g. 650" />
          </div>
        </div>
      `;
    })();
  </script>
</body>
</html>
