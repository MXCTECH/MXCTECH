<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37;
    --danger:#d90000;
    --line:#e8e8e8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0; background:#f5f6f8; color:#111; -webkit-font-smoothing:antialiased;
  }
  /* prevent iOS zoom on inputs */
  input,select,textarea,button{font-size:16px}

  .sheet{max-width:900px;margin:14px auto 64px;background:#fff;border:1px solid #ddd;border-radius:12px;padding:14px;box-shadow:0 3px 10px rgba(0,0,0,.05)}
  header.hdr{display:flex;gap:14px;align-items:center;border-bottom:1px solid var(--line);padding-bottom:12px}
  header .logo{width:110px;height:auto;object-fit:contain}
  header .hgroup{flex:1}
  header h1{margin:0;font-size:34px;letter-spacing:.06em}
  header .addr{margin-top:6px;color:#333}
  .idpanel{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:280px}
  .idpanel label{font-size:12px;color:#444}
  .idpanel input{width:100%;border:1px solid #ccc;border-radius:8px;padding:10px}

  .section{font-weight:800;margin:18px 0 10px;font-size:18px}
  .card{border:1px solid var(--line);border-radius:10px;background:#fff}
  .box{border:1px solid var(--line);border-radius:10px;background:#fafafa;padding:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid1{display:grid;grid-template-columns:1fr;gap:12px}
  .box label{display:block;font-size:12px;color:#555;margin-bottom:6px}
  .box input,.box textarea,.box select{width:100%;border:1px solid #ccc;border-radius:8px;padding:10px;background:#fff}
  .box textarea{min-height:90px;resize:vertical}

  /* Product line card */
  .pline{border:1px solid var(--line);border-radius:10px;background:#f9f9f9;padding:10px;margin-bottom:10px}
  .pline .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .pline .tot input[readonly]{background:#eee;font-weight:700}

  .controls{display:flex;gap:10px;flex-wrap:wrap}
  button{border:0;border-radius:10px;padding:12px 14px;font-weight:800;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#2f2f2f}
  button.danger{background:#b00020}
  button:disabled{opacity:.6;cursor:not-allowed}

  .panel{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
  .summary .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e3e3e3}
  .summary .row:last-child{border-bottom:none}
  .grand{font-size:20px;font-weight:800}
  .money{font-variant-numeric:tabular-nums}

  .waiver{border:2px solid var(--danger);background:#fff7f7;border-radius:10px;padding:12px}
  .waiver .flash{display:inline-block;font-weight:800;color:#fff;background:var(--danger);padding:4px 8px;border-radius:6px;animation:blink 1s infinite}
  @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:.3}}
  .waiver.ack .flash{display:none}

  .sigwrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sig{border:1px dashed #bdbdbd;border-radius:10px;padding:10px;background:#fafafa}
  .sig label{font-weight:700}
  .sig canvas{width:100%;height:200px;background:#fff;border:1px solid #ddd;border-radius:8px;touch-action:none}
  .sig .under{display:flex;gap:8px;align-items:center;margin-top:8px}
  .sig .under input{flex:1}
  .footer{font-size:12px;color:#777;text-align:center;margin-top:10px}

  /* stack things on phones */
  @media (max-width:740px){
    header.hdr{align-items:flex-start}
    .idpanel{order:-1;grid-template-columns:1fr;max-width:none}
    .sigwrap{grid-template-columns:1fr}
    .pline .row{grid-template-columns:1fr}
  }

  /* capture container for pdf */
  #capture{padding:12px}
</style>
</head>
<body>
<div id="capture" class="sheet">
  <header class="hdr">
    <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK">
    <div class="hgroup">
      <h1>WARM UP UK</h1>
      <div class="addr">321-323 Romford High Road, Essex RM6 6AX · <strong>Tel:</strong> <a href="tel:01708300670">01708 300670</a></div>
    </div>

    <!-- Contract meta (moves above Customer on mobile) -->
    <div class="idpanel">
      <div>
        <label>Contract #</label>
        <input id="contractNo" readonly />
      </div>
      <div>
        <label>Date</label>
        <input id="contractDate" readonly />
      </div>
    </div>
  </header>

  <div class="section">Customer</div>
  <div class="box grid2">
    <div>
      <label>Customer Name</label>
      <input id="custName" placeholder="Full name"/>
      <label>Property Address</label>
      <textarea id="custAddr" rows="3" placeholder="House/Street, Town, Postcode"></textarea>
    </div>
    <div>
      <label>Phone</label>
      <input id="custPhone" placeholder="07…"/>
      <label>Email</label>
      <input id="custEmail" placeholder="email@example.com"/>
    </div>
  </div>

  <div class="section">Products / Services</div>
  <div id="lines"></div>
  <div class="controls" style="margin:10px 0 6px">
    <button id="addLine" class="secondary">+ Add Row</button>
    <button id="removeLine" class="secondary">− Remove Last</button>
  </div>

  <div class="section">Options</div>
  <div class="panel">
    <div style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="vatToggle"><label for="vatToggle">Apply <strong>VAT 20%</strong></label></div>
    <div style="font-size:12px;color:#666;margin-top:6px">Admin Fee of <strong>£150</strong> is automatically applied.</div>
    <div style="margin-top:12px">
      <label style="display:block;font-size:12px;color:#555;margin:6px 0">Install Date</label>
      <input id="installDate" type="date" style="border:1px solid #ccc;border-radius:8px;padding:10px;width:220px"/>
    </div>
  </div>

  <div class="section">Totals</div>
  <div class="panel summary">
    <div class="row"><div>Subtotal</div><div class="money">£ <span id="subtotal">0.00</span></div></div>
    <div class="row"><div>Admin Fee</div><div class="money">£ <span id="adminFee">150.00</span></div></div>
    <div class="row"><div>VAT (20%)</div><div class="money">£ <span id="vatAmt">0.00</span></div></div>
    <div class="row grand"><div>Grand Total</div><div class="money">£ <span id="grand">150.00</span></div></div>
    <div class="row">
      <div>Less Deposit</div>
      <div class="money" style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
        £ <input id="deposit" type="number" min="0" step="0.01" value="0" style="width:120px;text-align:right;border:1px solid #ccc;border-radius:8px;padding:8px 10px">
      </div>
    </div>
    <div class="row"><div><strong>Balance Due</strong></div><div class="money"><strong>£ <span id="balance">150.00</span></strong></div></div>
  </div>

  <div class="section">Notes</div>
  <div class="box"><textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea></div>

  <div id="waiver" class="section">Express Waiver</div>
  <div class="waiver">
    <span class="flash">ACTION REQUIRED</span>
    <p style="margin:8px 0 10px">
      I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may
      affect my right to cancel once the work has started and materials have been ordered or installed.
    </p>
    <label style="display:flex;gap:10px;align-items:center;font-weight:600"><input id="waiverAck" type="checkbox">I acknowledge and accept the Express Waiver.</label>
  </div>

  <div class="section">Signatures</div>
  <div class="sigwrap">
    <div class="sig">
      <label>Customer Signature</label>
      <canvas id="sigCustomer"></canvas>
      <div class="under">
        <input id="sigCustName" placeholder="Customer printed name" />
        <button type="button" class="secondary" id="sigCustomerClear">Clear</button>
      </div>
    </div>
    <div class="sig">
      <label>Company Signature</label>
      <canvas id="sigCompany"></canvas>
      <div class="under">
        <input id="sigCompName" placeholder="Company representative" />
        <button type="button" class="secondary" id="sigCompanyClear">Clear</button>
      </div>
    </div>
  </div>

  <div class="controls" style="margin-top:14px">
    <button id="pdfBtn" disabled>Generate PDF</button>
    <button id="clearBtn" class="danger">Clear Form</button>
  </div>

  <div class="footer">WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670</div>
</div>

<script>
(function(){
  /* ---------- Constants & Helpers ---------- */
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin Treatment",
    "Timber Treatment"
  ];
  const ADMIN_FEE = 150, VAT_RATE = 0.20;
  const money = n => (Number(n||0).toFixed(2));

  /* ---------- Contract meta ---------- */
  const contractNo = document.getElementById('contractNo');
  const contractDate = document.getElementById('contractDate');
  function genNo(){
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    return `WUU-${String(d.getFullYear()).slice(-2)}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}-${Math.floor(1000+Math.random()*9000)}`;
  }
  function today(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
  contractNo.value = genNo();
  contractDate.value = today();
  document.getElementById('installDate').value = today();

  /* ---------- Product lines (mobile-friendly cards) ---------- */
  const lines = document.getElementById('lines');
  function makeSelect(){
    const s = document.createElement('select');
    s.innerHTML = PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
    return s;
  }
  function addLine(pref={}){
    const wrap = document.createElement('div');
    wrap.className = 'pline';

    const prodLbl = document.createElement('label');
    prodLbl.textContent = 'Product';
    const sel = makeSelect(); if(pref.product) sel.value = pref.product;

    const qtyLbl = document.createElement('label'); qtyLbl.textContent='Qty';
    const qty = document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='1'; qty.value = pref.qty||0;

    const unitLbl = document.createElement('label'); unitLbl.textContent='Unit (£)';
    const unit = document.createElement('input'); unit.type='number'; unit.min='0'; unit.step='0.01'; unit.value = pref.unit||0;

    const totLbl = document.createElement('label'); totLbl.textContent='Line Total';
    const tot = document.createElement('input'); tot.readOnly=true; tot.value='0.00';

    // top select
    const top = document.createElement('div'); top.className='grid1 box'; top.style.background='#fff';
    const topInner = document.createElement('div');
    topInner.appendChild(prodLbl); topInner.appendChild(sel);
    top.appendChild(topInner);

    // bottom triple stacked on mobile
    const bottom = document.createElement('div'); bottom.className='row';
    const c1 = document.createElement('div'); c1.className='box'; c1.append(qtyLbl, qty);
    const c2 = document.createElement('div'); c2.className='box'; c2.append(unitLbl, unit);
    const c3 = document.createElement('div'); c3.className='box'; c3.append(totLbl, tot);
    bottom.append(c1,c2,c3);

    wrap.append(top,bottom);
    lines.appendChild(wrap);

    function recalc(){ tot.value = money((+qty.value||0) * (+unit.value||0)); updateTotals(); }
    [qty,unit,sel].forEach(el=>el.addEventListener('input', recalc));
    recalc();
  }
  function removeLine(){ if(lines.lastElementChild) { lines.removeChild(lines.lastElementChild); updateTotals(); } }
  document.getElementById('addLine').addEventListener('click', ()=>addLine());
  document.getElementById('removeLine').addEventListener('click', removeLine);
  // start with 3
  addLine(); addLine(); addLine();

  /* ---------- Totals ---------- */
  const subtotalEl = document.getElementById('subtotal');
  const adminFeeEl = document.getElementById('adminFee');
  const vatAmtEl   = document.getElementById('vatAmt');
  const grandEl    = document.getElementById('grand');
  const depositEl  = document.getElementById('deposit');
  const balanceEl  = document.getElementById('balance');
  const vatToggle  = document.getElementById('vatToggle');

  function getSubtotal(){
    let s=0;
    lines.querySelectorAll('.pline').forEach(pl=>{
      const lt = pl.querySelector('.box:last-child input'); // line total
      s += parseFloat(lt.value||0);
    });
    return s;
  }
  function updateTotals(){
    const subtotal = getSubtotal();
    const admin = ADMIN_FEE;
    const beforeVAT = subtotal + admin;
    const vat = vatToggle.checked ? beforeVAT * VAT_RATE : 0;
    const grand = beforeVAT + vat;
    const deposit = parseFloat(depositEl.value||0);
    const balance = Math.max(grand - deposit, 0);

    subtotalEl.textContent = money(subtotal);
    adminFeeEl.textContent = money(admin);
    vatAmtEl.textContent   = money(vat);
    grandEl.textContent    = money(grand);
    balanceEl.textContent  = money(balance);
  }
  vatToggle.addEventListener('change', updateTotals);
  depositEl.addEventListener('input', updateTotals);

  /* ---------- Waiver gate -> enable PDF ---------- */
  const waiverBox = document.getElementById('waiver');
  const waiverAck = document.getElementById('waiverAck');
  const pdfBtn = document.getElementById('pdfBtn');
  function gate(){ if(waiverAck.checked){ document.querySelector('.waiver').classList.add('ack'); pdfBtn.disabled=false; } else { document.querySelector('.waiver').classList.remove('ack'); pdfBtn.disabled=true; } }
  waiverAck.addEventListener('change', gate); gate();

  /* ---------- Signatures (robust, survive rotate) ---------- */
  function makeSig(canvasId, clearBtnId){
    const canvas = document.getElementById(canvasId);
    const pad = new SignaturePad(canvas, { penColor:'#000', backgroundColor:'#fff' });

    function resizeKeep(){
      // Save existing
      const data = pad.isEmpty() ? null : pad.toData();
      // scale canvas to device pixel ratio
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * ratio);
      canvas.height = Math.round(rect.height * ratio);
      pad.clear();
      // restore
      if(data){ pad.fromData(data); }
    }
    window.addEventListener('resize', resizeKeep);
    // initial
    setTimeout(resizeKeep, 0);

    document.getElementById(clearBtnId).addEventListener('click', ()=>pad.clear());

    return {
      toDataURL(){ return pad.isEmpty() ? null : pad.toDataURL('image/png'); },
      pad,
      bakeForPDF(){ // return an IMG element that visually matches canvas size
        const url = this.toDataURL();
        if(!url) return null;
        const img = document.createElement('img');
        img.src = url;
        img.style.width = canvas.style.width || canvas.getBoundingClientRect().width + 'px';
        img.style.height = canvas.style.height || canvas.getBoundingClientRect().height + 'px';
        img.style.border = canvas.style.border; img.style.borderRadius = canvas.style.borderRadius;
        return {img, canvas};
      }
    };
  }
  const sigCustomer = makeSig('sigCustomer','sigCustomerClear');
  const sigCompany  = makeSig('sigCompany','sigCompanyClear');

  /* ---------- PDF (embed signatures + page2 T&Cs) ---------- */
  function swapSignaturesInDOM(){
    const swaps=[];
    [sigCustomer,sigCompany].forEach(s=>{
      const baked = s.bakeForPDF();
      if(baked){
        const {img, canvas} = baked;
        canvas.style.display='none';
        canvas.parentNode.insertBefore(img, canvas);
        swaps.push({img, canvas});
      }
    });
    return ()=>{ swaps.forEach(({img,canvas})=>{ img.remove(); canvas.style.display=''; }); };
  }

  async function generatePDF(){
    if(!waiverAck.checked){ alert('Please acknowledge the Express Waiver.'); return; }
    updateTotals();

    const restore = swapSignaturesInDOM(); // make canvases renderable

    const node = document.getElementById('capture');
    const { jsPDF } = window.jspdf;
    const a4w=210,a4h=297;
    const pdf = new jsPDF('p','mm','a4');

    const canvas = await html2canvas(node, {scale:2,backgroundColor:'#ffffff',useCORS:true,windowWidth:node.scrollWidth,windowHeight:node.scrollHeight});
    restore();

    const imgData = canvas.toDataURL('image/png');
    const mmPerPx = a4w / canvas.width;
    const imgH = canvas.height * mmPerPx;

    if(imgH <= a4h){
      pdf.addImage(imgData,'PNG',0,0,a4w,imgH);
    }else{
      let topPx = 0; const pagePx = a4h / mmPerPx;
      while(topPx < canvas.height){
        const sliceH = Math.min(pagePx, canvas.height - topPx);
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width; pageCanvas.height = sliceH;
        pageCanvas.getContext('2d').drawImage(canvas, 0, topPx, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
        const pageImg = pageCanvas.toDataURL('image/png');
        if(topPx>0) pdf.addPage();
        pdf.addImage(pageImg,'PNG',0,0,a4w,sliceH*mmPerPx);
        topPx += sliceH;
      }
    }

    // FORCE Terms on their own final page
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Terms & Conditions (Summary)', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
    const terms = [
      "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
      "2. Customer responsible for providing safe access to all work areas.",
      "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
      "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
      "5. Payment terms: unless otherwise stated, balance due on completion.",
      "6. Materials remain property of WARM UP UK until paid in full.",
      "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
      "8. By signing, the customer confirms accuracy of details and authorises the work as described.",
      "9. VAT charged where applicable at the prevailing rate when selected.",
      "10. Dispute resolution: please contact us in writing; we aim to resolve issues promptly."
    ];
    const left=14, width=pdf.internal.pageSize.getWidth()-28;
    let y=26;
    terms.forEach(t=>{ const lines=pdf.splitTextToSize(t,width); pdf.text(lines,left,y); y+=7+(lines.length-1)*5; });

    pdf.save(`${contractNo.value}.pdf`);
  }
  document.getElementById('pdfBtn').addEventListener('click', generatePDF);

  /* ---------- Clear ---------- */
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    ['custName','custAddr','custPhone','custEmail','notes','sigCustName','sigCompName'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    // reset products
    lines.innerHTML=''; addLine(); addLine(); addLine();
    document.getElementById('deposit').value=0;
    document.getElementById('vatToggle').checked=false;
    document.getElementById('installDate').value=today();
    sigCustomer.pad.clear(); sigCompany.pad.clear();
    contractNo.value=genNo(); contractDate.value=today();
    waiverAck.checked=false; gate(); updateTotals();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // initial totals
  updateTotals();
})();
</script>
</body>
</html>
