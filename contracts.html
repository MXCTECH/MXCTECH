<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37;
    --danger:#d90000;
    --line:#e8e8e8;
    --ink:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0;background:#f7f7f8;color:var(--ink);
    -webkit-font-smoothing:antialiased; overscroll-behavior:contain;
  }
  input,select,textarea,button{font-size:16px}

  .sheet{max-width:900px;margin:16px auto;background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;box-shadow:0 3px 12px rgba(0,0,0,.06)}
  header{display:flex;gap:16px;align-items:center;border-bottom:1px solid var(--line);padding-bottom:12px}
  header img.logo{width:120px;height:auto;object-fit:contain}
  .brandblock{flex:1}
  .brandblock h1{margin:0;font-size:26px;letter-spacing:.08em}
  .brandblock .addr{margin-top:6px;font-size:14px;line-height:1.35;color:#333}

  .box{background:#fafafa;border:1px solid var(--line);padding:10px;border-radius:8px}
  .box label{display:block;font-size:12px;color:#555;margin-bottom:6px}
  .box input,.box textarea,.box select{width:100%;border:1px solid #ccc;border-radius:6px;padding:10px}

  .meta{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .meta .box{flex:1 1 280px}

  .section-title{font-weight:700;margin:18px 0 10px;font-size:16px}

  /* PRODUCT LINES (mobile-first cards) */
  .lines{display:grid;gap:10px}
  .line{border:1px solid var(--line);border-radius:10px;background:#fafafa;padding:10px}
  .line .top select{width:100%}
  .line .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .line .grid .field input{width:100%}
  .line .grid .field.total input{background:#fff;border:1px dashed #bbb;font-weight:700}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 6px}
  button{border:0;background:#111;color:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  button.secondary{background:#2f2f2f} button.danger{background:var(--danger)} button:disabled{opacity:.6;cursor:not-allowed}

  .totals{display:grid;grid-template-columns:1fr 280px;gap:12px;margin-top:12px;align-items:start}
  .panel{border:1px solid var(--line);border-radius:8px;padding:10px;background:#fafafa}
  .summary{border:1px solid var(--line);border-radius:8px;padding:10px;background:#fff}
  .summary .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #e3e3e3}
  .summary .row:last-child{border-bottom:none}
  .grand{font-size:18px;font-weight:800}
  .pound{color:var(--accent);font-weight:800}

  .notes,.tnc,.waiver,.signatures{border:1px solid var(--line);border-radius:8px;padding:12px;background:#fff;margin-top:12px}
  .notes textarea{min-height:120px}
  .tnc ol{padding-left:18px} .tnc li{margin:6px 0}
  .waiver{border-color:var(--danger);position:relative}
  .waiver .flash{position:absolute;top:8px;right:12px;font-weight:800;color:#fff;background:var(--danger);padding:4px 8px;border-radius:6px;animation:blink 1s infinite}
  @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:.25}}
  .waiver.ack .flash{display:none}

  .signatures .sig-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sig{border:1px dashed #bbb;border-radius:8px;padding:10px;background:#fafafa}
  .sig canvas{width:100%;height:200px;background:#fff;border:1px solid #ddd;border-radius:6px;touch-action:none}
  .sig .sig-row{display:flex;justify-content:space-between;align-items:center;margin-top:6px;gap:8px}

  .footer-note{text-align:center;font-size:12px;color:#777;margin-top:10px}

  /* Hide from page-1 capture, we’ll render on a dedicated PDF page */
  [data-pdf-exclude]{}

  @media (max-width:720px){
    header{align-items:flex-start}
    .totals{grid-template-columns:1fr}
    .notes textarea{min-height:150px}
    .signatures .sig-wrap{grid-template-columns:1fr} /* stack signatures */
    /* make qty/unit/total comfortable on small screens */
    .line .grid{grid-template-columns:1fr 1fr 1fr}
  }
</style>
</head>
<body>
  <div id="capture" class="sheet">
    <header>
      <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK logo" />
      <div class="brandblock">
        <h1>WARM UP UK</h1>
        <div class="addr">
          321-323 Romford High Road, Essex RM6 6AX<br />
          <strong>Tel:</strong> 01708 300670
        </div>
      </div>
      <div class="box" style="max-width:230px">
        <label>Contract #</label>
        <input id="contractNo" readonly />
        <label>Date</label>
        <input id="contractDate" readonly />
      </div>
    </header>

    <div class="meta">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
        <label>Property Address</label>
        <textarea id="custAddr" rows="3" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…" />
        <label>Email</label>
        <input id="custEmail" placeholder="email@example.com" />
      </div>
    </div>

    <div class="section-title">Products / Services</div>
    <div id="lines" class="lines"></div>
    <div class="controls">
      <button type="button" id="addRowBtn" class="secondary">+ Add Row</button>
      <button type="button" id="delRowBtn" class="secondary">− Remove Last</button>
    </div>

    <div class="totals">
      <div class="panel">
        <div class="section-title" style="margin-top:0">Options</div>
        <label style="display:flex;gap:10px;align-items:center">
          <input type="checkbox" id="vatToggle" /> Apply <strong>VAT 20%</strong>
        </label>
        <div class="fine" style="font-size:12px;color:#666;margin-top:6px">
          Admin Fee of <strong>£150</strong> is automatically applied.
        </div>
      </div>

      <div class="summary" id="totalsBox">
        <div class="row"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
        <div class="row"><div>Admin Fee</div><div>£ <span id="adminFee">150.00</span></div></div>
        <div class="row"><div>VAT (20%)</div><div>£ <span id="vatAmt">0.00</span></div></div>
        <div class="row grand"><div>Grand Total</div><div><span class="pound">£</span> <span id="grand">150.00</span></div></div>
      </div>
    </div>

    <div class="notes">
      <div class="section-title" style="margin-top:0">Notes</div>
      <textarea id="notes" rows="5" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <!-- Keep T&C on screen, but exclude from page-1 capture -->
    <div class="tnc" data-pdf-exclude>
      <div class="section-title" style="margin-top:0">Terms &amp; Conditions (Summary)</div>
      <ol>
        <li>All works to be carried out by or on behalf of WARM UP UK to agreed specification.</li>
        <li>Customer responsible for providing safe access to all work areas.</li>
        <li>Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.</li>
        <li>Electrical/ventilation upgrades, if required by building guidance, may be chargeable.</li>
        <li>Payment terms: unless otherwise stated, balance due on completion.</li>
        <li>Materials remain property of WARM UP UK until paid in full.</li>
        <li>Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.</li>
        <li>By signing, the customer confirms accuracy of details and authorises the work as described.</li>
      </ol>
    </div>

    <div id="waiver" class="waiver">
      <div class="flash">ACTION REQUIRED</div>
      <div class="section-title" style="margin-top:0;color:var(--danger)">Express Waiver</div>
      <p style="margin:6px 0 10px">
        I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may
        affect my right to cancel once the work has started and materials have been ordered or installed.
      </p>
      <label style="display:flex;gap:10px;align-items:center;font-weight:600">
        <input type="checkbox" id="waiverAck" /> I acknowledge and accept the Express Waiver.
      </label>
    </div>

    <div class="signatures">
      <div class="section-title" style="margin-top:0">Signatures</div>
      <div class="sig-wrap">
        <div class="sig">
          <label><strong>Customer Signature</strong></label>
          <canvas id="sigCustomer"></canvas>
          <div class="sig-row">
            <input id="sigCustName" placeholder="Customer printed name" />
            <button type="button" class="secondary" data-clear="sigCustomer">Clear</button>
          </div>
        </div>
        <div class="sig">
          <label><strong>Company Signature</strong></label>
          <canvas id="sigCompany"></canvas>
          <div class="sig-row">
            <input id="sigCompName" placeholder="Company representative" />
            <button type="button" class="secondary" data-clear="sigCompany">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="pdfBtn" type="button" disabled>Generate PDF</button>
      <button id="clearBtn" type="button" class="danger">Clear Form</button>
    </div>

    <div class="footer-note">
      WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670
    </div>
  </div>

<script>
(function(){
  // ---- Constants ----
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin Treatment",
    "Timber Treatment"
  ];
  const ADMIN_FEE = 150, VAT_RATE = 0.20;

  // ---- Refs ----
  const lines = document.getElementById('lines');
  const addRowBtn = document.getElementById('addRowBtn');
  const delRowBtn = document.getElementById('delRowBtn');
  const vatToggle = document.getElementById('vatToggle');
  const subtotalEl = document.getElementById('subtotal');
  const adminFeeEl = document.getElementById('adminFee');
  const vatAmtEl = document.getElementById('vatAmt');
  const grandEl = document.getElementById('grand');
  const waiver = document.getElementById('waiver');
  const waiverAck = document.getElementById('waiverAck');
  const pdfBtn = document.getElementById('pdfBtn');
  const clearBtn = document.getElementById('clearBtn');

  const contractNo = document.getElementById('contractNo');
  const contractDate = document.getElementById('contractDate');

  // ---- Contract no / date ----
  function genContractNo(){
    const d=new Date(), pad=n=>String(n).padStart(2,'0');
    return `WUU-${String(d.getFullYear()).slice(-2)}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}-${Math.floor(1000+Math.random()*9000)}`;
  }
  function today(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
  contractNo.value = genContractNo(); contractDate.value = today();

  // ---- Product line factory (mobile-first) ----
  function makeSelect(){
    const sel=document.createElement('select');
    sel.innerHTML = PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
    return sel;
  }
  function makeLine(){
    const wrap=document.createElement('div'); wrap.className='line';

    const top=document.createElement('div'); top.className='top';
    const sel=makeSelect(); top.appendChild(sel);

    const grid=document.createElement('div'); grid.className='grid';

    const qty=document.createElement('div'); qty.className='field';
    qty.innerHTML=`<label>Qty</label><input type="number" min="0" step="1" placeholder="0">`;

    const unit=document.createElement('div'); unit.className='field';
    unit.innerHTML=`<label>Unit (£)</label><input type="number" min="0" step="0.01" placeholder="0.00">`;

    const total=document.createElement('div'); total.className='field total';
    total.innerHTML=`<label>Line Total</label><input type="text" value="0.00" readonly>`;

    grid.append(qty,unit,total);
    wrap.append(top,grid);

    function recalc(){
      const q=+qty.querySelector('input').value||0;
      const u=+unit.querySelector('input').value||0;
      total.querySelector('input').value=(q*u).toFixed(2);
      updateTotals();
    }
    qty.querySelector('input').addEventListener('input',recalc);
    unit.querySelector('input').addEventListener('input',recalc);
    sel.addEventListener('change',()=>{}); // reserved

    return wrap;
  }
  function addRow(){ lines.appendChild(makeLine()); updateTotals(); }
  function removeRow(){ if(lines.lastElementChild){ lines.lastElementChild.remove(); updateTotals(); } }

  addRowBtn.addEventListener('click', addRow);
  delRowBtn.addEventListener('click', removeRow);

  // start with 3 rows
  addRow(); addRow(); addRow();

  // ---- Totals ----
  function updateTotals(){
    let subtotal=0;
    lines.querySelectorAll('.line').forEach(l=>{
      const q=+l.querySelector('.field input[type="number"]').value||0;
      const unit=+l.querySelectorAll('.field input[type="number"]')[1].value||0;
      subtotal += q*unit;
    });
    const admin=ADMIN_FEE;
    const beforeVAT=subtotal+admin;
    const vat=vatToggle.checked ? beforeVAT*VAT_RATE : 0;
    const grand=beforeVAT+vat;

    subtotalEl.textContent=subtotal.toFixed(2);
    adminFeeEl.textContent=admin.toFixed(2);
    vatAmtEl.textContent=vat.toFixed(2);
    grandEl.textContent=grand.toFixed(2);
  }
  vatToggle.addEventListener('change', updateTotals);

  // ---- Waiver gate ----
  function updateWaiver(){
    if(waiverAck.checked){ waiver.classList.add('ack'); pdfBtn.disabled=false; }
    else { waiver.classList.remove('ack'); pdfBtn.disabled=true; }
  }
  waiverAck.addEventListener('change', updateWaiver); updateWaiver();

  // ---- Signature pads (preserve on rotate/resize) ----
  function makePad(canvas){
    const ctx=canvas.getContext('2d');
    function resize(preserve=true){
      let data;
      if(preserve){ data=canvas.toDataURL(); }
      const dpr=Math.max(window.devicePixelRatio||1,1);
      const rect=canvas.getBoundingClientRect();
      canvas.width=Math.round(rect.width*dpr);
      canvas.height=Math.round(rect.height*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
      if(preserve && data){
        const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,canvas.width/dpr,canvas.height/dpr);
        img.src=data;
      }
    }
    resize(false);
    let drawing=false,lastX=0,lastY=0;
    function pos(e){ const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top};}
    function start(e){ drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
    function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault();}
    function end(){ drawing=false; }

    canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
    canvas.addEventListener('touchstart',start,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',end);
    window.addEventListener('resize', ()=>resize(true)); // preserve ink on rotate

    return {
      clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); resize(false); },
      dataURL(){ return canvas.toDataURL('image/png'); },
      bakeToImg(){ const img=new Image(); img.src=canvas.toDataURL('image/png'); img.style.width='100%'; img.style.height='200px'; img.style.border='1px solid #ddd'; img.style.borderRadius='6px'; canvas.style.display='none'; canvas.parentNode.insertBefore(img, canvas); return img; },
      restoreFromImg(img){ if(img && img.parentNode){ img.remove(); canvas.style.display=''; }
    }};
  }
  const sigCustomer = makePad(document.getElementById('sigCustomer'));
  const sigCompany  = makePad(document.getElementById('sigCompany'));
  document.querySelectorAll('[data-clear]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      (btn.getAttribute('data-clear')==='sigCustomer'?sigCustomer:sigCompany).clear();
    });
  });

  // ---- PDF helpers ----
  function prepForPDF(){
    // 1) Hide elements marked as exclude (T&C page goes later)
    const excluded=[...document.querySelectorAll('[data-pdf-exclude]')];
    excluded.forEach(el=>el.style.display='none');

    // 2) Bake signature canvases so html2canvas captures them
    const baked = [sigCustomer.bakeToImg(), sigCompany.bakeToImg()];

    return function restore(){
      excluded.forEach(el=>el.style.display='');
      baked.forEach(img=>{
        if(img===baked[0]) sigCustomer.restoreFromImg(img);
        else sigCompany.restoreFromImg(img);
      });
    };
  }

  // ---- PDF generation ----
  document.getElementById('pdfBtn').addEventListener('click', async ()=>{
    if(!waiverAck.checked){ alert('Please acknowledge the Express Waiver before generating the PDF.'); return; }
    const restore = prepForPDF();

    const node = document.getElementById('capture');
    const { jsPDF } = window.jspdf;
    const a4w=210, a4h=297;
    const pdf = new jsPDF('p','mm','a4');

    // page 1 capture (without T&C, with baked signatures)
    const canvas = await html2canvas(node,{scale:2,useCORS:true,backgroundColor:'#ffffff',windowWidth:node.scrollWidth,windowHeight:node.scrollHeight});
    restore(); // bring screen back

    const imgData = canvas.toDataURL('image/png');
    const mmPerPx = a4w / canvas.width;
    const imgH = canvas.height * mmPerPx;

    if(imgH <= a4h){
      pdf.addImage(imgData,'PNG',0,0,a4w,imgH);
    }else{
      let topPx=0; const pageHeightPx = a4h / mmPerPx;
      while(topPx < canvas.height){
        const sliceHeightPx = Math.min(pageHeightPx, canvas.height - topPx);
        const pageCanvas=document.createElement('canvas');
        pageCanvas.width=canvas.width; pageCanvas.height=sliceHeightPx;
        pageCanvas.getContext('2d').drawImage(canvas,0,topPx,canvas.width,sliceHeightPx,0,0,canvas.width,sliceHeightPx);
        const pageImg=pageCanvas.toDataURL('image/png');
        if(topPx>0) pdf.addPage();
        pdf.addImage(pageImg,'PNG',0,0,a4w,sliceHeightPx*mmPerPx);
        topPx += sliceHeightPx;
      }
    }

    // page 2 – Terms & Conditions
    pdf.addPage();
    pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
    pdf.text('Terms & Conditions (Summary)', 14, 16);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
    const terms = [
      "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
      "2. Customer responsible for providing safe access to all work areas.",
      "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
      "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
      "5. Payment terms: unless otherwise stated, balance due on completion.",
      "6. Materials remain property of WARM UP UK until paid in full.",
      "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
      "8. By signing, the customer confirms accuracy of details and authorises the work as described."
    ];
    const left=14, width=pdf.internal.pageSize.getWidth()-28;
    let y=26;
    terms.forEach(t=>{ const lines=pdf.splitTextToSize(t,width); pdf.text(lines,left,y); y += 7 + (lines.length-1)*5; });

    pdf.save(`${contractNo.value || 'WarmUpUK_Contract'}.pdf`);
  });

  // ---- Clear ----
  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    document.querySelectorAll('input, textarea').forEach(el=>{
      if(el.id==='contractNo'){ el.value=genContractNo(); }
      else if(el.id==='contractDate'){ el.value=today(); }
      else if(el.type!=='checkbox'){ el.value=''; }
    });
    vatToggle.checked=false;
    lines.innerHTML=''; addRow(); addRow(); addRow();
    waiverAck.checked=false; waiver.classList.remove('ack'); pdfBtn.disabled=true;
    sigCustomer.clear(); sigCompany.clear();
    window.scrollTo({top:0,behavior:'smooth'});
    updateTotals();
  });
})();
</script>
</body>
</html>
