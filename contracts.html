<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WARM UP UK — Contract</title>
  <style>
    :root {
      --bg: #ffffff;
      --ink: #111;
      --gold: #b08d2f;
      --muted: #f5f5f7;
      --line: #e6e6ea;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--ink); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .page { max-width: 900px; margin: 24px auto 80px; padding: 16px; }
    .card { background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow: 0 2px 6px rgba(0,0,0,.04); overflow:hidden; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 240px; }
    header.brand {
      padding:16px 20px; display:flex; align-items:center; gap:16px;
      background: #000; color:#fff;
    }
    header.brand img { height:56px; width:auto; display:block; }
    header.brand .title { flex:1; }
    header.brand h1 { margin:0 0 2px; font-size:22px; letter-spacing:1px; color: var(--gold); }
    header.brand p { margin:0; opacity:.9; }
    section { padding: 18px 20px; }
    section + section { border-top:1px solid var(--line); }
    h2 { font-size:16px; margin:0 0 12px; letter-spacing:.3px; }
    label { display:block; font-size:12px; margin-bottom:4px; opacity:.8; }
    input, select, textarea {
      width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }
    textarea { min-height:72px; resize:vertical; }
    table.products { width:100%; border-collapse:collapse; }
    table.products th, table.products td { border-top:1px solid var(--line); padding:10px; vertical-align:top; }
    table.products th { background:var(--muted); text-align:left; font-weight:600; }
    table.products tfoot td { font-weight:700; }
    .num { text-align:right; }
    .actions { padding:16px; display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-end; background:#fff; position:sticky; bottom:0; border-top:1px solid var(--line); }
    button {
      appearance:none; border:1px solid #000; background:#000; color:#fff; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    button.secondary { background:#fff; color:#000; }
    .sig-wrap { display:flex; gap:16px; flex-wrap:wrap; }
    .sig { flex:1 1 260px; }
    .sig canvas { width:100%; height:150px; border:1px dashed var(--line); border-radius:8px; background:#fff; }
    .hint { font-size:12px; opacity:.7; margin-top:6px; }
    .totals { max-width: 380px; margin-left:auto; }
    .totals .rowline { display:flex; justify-content:space-between; padding:8px 0; border-top:1px solid var(--line); }
    .totals .rowline.total { font-size:16px; font-weight:800; }
    /* Mobile tweaks */
    @media (max-width:640px){
      header.brand img { height:48px; }
      header.brand h1 { font-size:18px; }
      table.products th:nth-child(2), table.products td:nth-child(2) { display:none; } /* hide description on very small screens (keeps layout tidy) */
    }
  </style>
</head>
<body>
  <div class="page">
    <div id="contract" class="card">
      <header class="brand">
        <img src="warmupuklogo.jpg" alt="WARM UP UK logo" />
        <div class="title">
          <h1>WARM UP UK</h1>
          <p>321-323 Romford High Road, Essex, RM6 6AX</p>
        </div>
      </header>

      <section>
        <h2>Order Form</h2>
        <div class="row">
          <div class="col">
            <label>Customer Name</label>
            <input id="custName" type="text" placeholder="Full name" />
          </div>
          <div class="col">
            <label>Contact Number</label>
            <input id="custPhone" type="tel" placeholder="07..." />
          </div>
          <div class="col">
            <label>Email</label>
            <input id="custEmail" type="email" placeholder="example@email.com" />
          </div>
          <div class="col">
            <label>Installation Address</label>
            <input id="custAddress" type="text" placeholder="House/Street, Town, Postcode" />
          </div>
        </div>
      </section>

      <section>
        <h2>Products</h2>
        <table class="products" id="productsTable">
          <thead>
            <tr>
              <th style="width:34%">Product</th>
              <th style="width:28%">Description</th>
              <th style="width:12%">Qty</th>
              <th style="width:14%">Unit (£)</th>
              <th class="num" style="width:12%">Line (£)</th>
            </tr>
          </thead>
          <tbody>
            <!-- 3 rows fixed, as requested -->
            <tr>
              <td>
                <select class="prod"></select>
              </td>
              <td>
                <textarea class="desc" placeholder="Notes / spec (optional)"></textarea>
              </td>
              <td><input class="qty" type="number" min="0" step="1" value="0" /></td>
              <td><input class="unit" type="number" min="0" step="0.01" value="0.00" /></td>
              <td class="num"><span class="lineTotal">0.00</span></td>
            </tr>
            <tr>
              <td>
                <select class="prod"></select>
              </td>
              <td>
                <textarea class="desc" placeholder="Notes / spec (optional)"></textarea>
              </td>
              <td><input class="qty" type="number" min="0" step="1" value="0" /></td>
              <td><input class="unit" type="number" min="0" step="0.01" value="0.00" /></td>
              <td class="num"><span class="lineTotal">0.00</span></td>
            </tr>
            <tr>
              <td>
                <select class="prod"></select>
              </td>
              <td>
                <textarea class="desc" placeholder="Notes / spec (optional)"></textarea>
              </td>
              <td><input class="qty" type="number" min="0" step="1" value="0" /></td>
              <td><input class="unit" type="number" min="0" step="0.01" value="0.00" /></td>
              <td class="num"><span class="lineTotal">0.00</span></td>
            </tr>
          </tbody>
        </table>

        <div class="totals" id="totalsBox">
          <div class="rowline"><span>Subtotal</span><span>£ <span id="subtotal">0.00</span></span></div>
          <div class="rowline total"><span>Total</span><span>£ <span id="grandTotal">0.00</span></span></div>
        </div>
      </section>

      <section>
        <h2>Signatures</h2>
        <div class="sig-wrap">
          <div class="sig">
            <label>Customer Signature</label>
            <canvas id="sigCustomer"></canvas>
            <div class="row" style="margin-top:8px;">
              <div class="col">
                <label>Signed By</label>
                <input id="sigCustomerName" type="text" placeholder="Customer name" />
              </div>
              <div class="col">
                <label>Date</label>
                <input id="sigCustomerDate" type="date" />
              </div>
            </div>
            <div class="hint">Use your finger (mobile) or mouse (desktop) to sign.</div>
            <button class="secondary" type="button" id="clearCust">Clear Customer Signature</button>
          </div>

          <div class="sig">
            <label>Company Signature</label>
            <canvas id="sigCompany"></canvas>
            <div class="row" style="margin-top:8px;">
              <div class="col">
                <label>Signed By</label>
                <input id="sigCompanyName" type="text" placeholder="Warm Up UK Representative" />
              </div>
              <div class="col">
                <label>Date</label>
                <input id="sigCompanyDate" type="date" />
              </div>
            </div>
            <div class="hint">WARM UP UK — Authorised Representative</div>
            <button class="secondary" type="button" id="clearComp">Clear Company Signature</button>
          </div>
        </div>
      </section>

      <section>
        <h2>Terms & Conditions (Summary)</h2>
        <ol style="padding-left:20px; margin:0;">
          <li>All prices are in GBP and valid for 30 days unless stated otherwise.</li>
          <li>Customer confirms access, power, and clear working areas for installation.</li>
          <li>Any unforeseen works will be discussed and quoted prior to proceeding.</li>
          <li>Product warranties per manufacturer guidance; workmanship warranty by WARM UP UK.</li>
          <li>Balance due on completion unless otherwise agreed in writing.</li>
          <li>Title to goods passes only on full payment received.</li>
          <li>Cancellations may incur costs where materials or labour are committed.</li>
          <li>Jurisdiction: England & Wales.</li>
        </ol>
      </section>
    </div>

    <div class="actions">
      <button id="btnPDF" type="button">Generate PDF</button>
      <button id="btnClearSigs" class="secondary" type="button">Clear Both Signatures</button>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ---------- PRODUCTS (fixed list; layout unchanged) ----------
    const PRODUCT_OPTIONS = [
      "Loft Insulation 270mm Fibreglass",
      "Multifoil YBS SuperQuilt",
      "Pitched Roof TLX Silver",
      "Cavity Wall Insulation",
      "Spray Foam Removal",
      "Loft Boarding",
      "Ventilation Upgrade",
      "Vermin Treatment",
      "Timber Treatment"
    ];

    function populateProductDropdowns() {
      document.querySelectorAll('select.prod').forEach(sel => {
        sel.innerHTML = "";
        PRODUCT_OPTIONS.forEach(opt => {
          const o = document.createElement("option");
          o.value = opt; o.textContent = opt;
          sel.appendChild(o);
        });
      });
    }

    // ---------- CALCS ----------
    function calcLine(tr){
      const qty = parseFloat(tr.querySelector(".qty").value || "0");
      const unit = parseFloat(tr.querySelector(".unit").value || "0");
      const line = (qty * unit) || 0;
      tr.querySelector(".lineTotal").textContent = line.toFixed(2);
      return line;
    }
    function recalc(){
      const rows = Array.from(document.querySelectorAll("#productsTable tbody tr"));
      const subtotal = rows.reduce((s,tr)=> s + calcLine(tr), 0);
      document.getElementById("subtotal").textContent = subtotal.toFixed(2);
      document.getElementById("grandTotal").textContent = subtotal.toFixed(2);
    }
    function bindCalcInputs(){
      document.querySelectorAll(".qty,.unit").forEach(el=>{
        el.addEventListener("input", recalc);
      });
    }

    // ---------- SIGNATURES ----------
    let sigPadCustomer, sigPadCompany;
    function resizeCanvasForHiDPI(canvas){
      // Properly scale canvas so signatures render sharp and export properly.
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * ratio);
      canvas.height = Math.round(rect.height * ratio);
      const ctx = canvas.getContext("2d");
      ctx.scale(ratio, ratio);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width, canvas.height);
    }
    function initSignatures(){
      const c1 = document.getElementById("sigCustomer");
      const c2 = document.getElementById("sigCompany");
      resizeCanvasForHiDPI(c1);
      resizeCanvasForHiDPI(c2);

      sigPadCustomer = new SignaturePad(c1, { backgroundColor: "rgba(255,255,255,1)", penColor: "black" });
      sigPadCompany  = new SignaturePad(c2, { backgroundColor: "rgba(255,255,255,1)", penColor: "black" });

      // Clear buttons
      document.getElementById("clearCust").addEventListener("click", ()=> sigPadCustomer.clear());
      document.getElementById("clearComp").addEventListener("click", ()=> sigPadCompany.clear());
      document.getElementById("btnClearSigs").addEventListener("click", ()=>{
        sigPadCustomer.clear(); sigPadCompany.clear();
      });

      // Re-scale canvases on orientation/resize so signing still works on phones
      window.addEventListener("resize", () => {
        const data1 = sigPadCustomer.toData();
        const data2 = sigPadCompany.toData();
        resizeCanvasForHiDPI(c1); resizeCanvasForHiDPI(c2);
        sigPadCustomer.fromData(data1);
        sigPadCompany.fromData(data2);
      });
    }

    // ---------- PDF ----------
    async function generatePDF(){
      // Ensure totals are up to date
      recalc();

      const { jsPDF } = window.jspdf;
      const node = document.getElementById("contract");

      // Temporarily replace signature canvases with images so html2canvas captures them sharply
      function sigAsImg(canvas){
        const img = new Image();
        img.src = canvas.toDataURL("image/png");
        img.style.width = canvas.clientWidth + "px";
        img.style.height = canvas.clientHeight + "px";
        img.className = "sig-img";
        return img;
      }
      const custCanvas = document.getElementById("sigCustomer");
      const compCanvas = document.getElementById("sigCompany");
      const custImg = sigAsImg(custCanvas);
      const compImg = sigAsImg(compCanvas);
      custCanvas.replaceWith(custImg);
      compCanvas.replaceWith(compImg);

      // Render
      const scale = 2; // good balance of sharpness vs size
      const canvas = await html2canvas(node, { scale, backgroundColor:"#ffffff", useCORS:true, });
      const imgData = canvas.toDataURL("image/jpeg", 0.95);

      // Restore canvases (so page remains interactive)
      custImg.replaceWith(custCanvas);
      compImg.replaceWith(compCanvas);

      // Create PDF and paginate
      const pdf = new jsPDF("p","mm","a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth; // full-bleed inside margins
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let position = 0;
      const pxPerMm = canvas.width / imgWidth;
      const pageHeightPx = pageHeight * pxPerMm;

      let pageIndex = 0;
      while (position < canvas.height) {
        const slice = document.createElement("canvas");
        slice.width = canvas.width;
        slice.height = Math.min(pageHeightPx, canvas.height - position);
        const ctx = slice.getContext("2d");
        ctx.drawImage(canvas, 0, position, canvas.width, slice.height, 0, 0, canvas.width, slice.height);
        const sliceData = slice.toDataURL("image/jpeg", 0.95);

        if (pageIndex > 0) pdf.addPage();
        const sliceHeightMm = (slice.height / pxPerMm);
        pdf.addImage(sliceData, "JPEG", 0, 0, imgWidth, sliceHeightMm, undefined, "FAST");
        position += slice.height;
        pageIndex++;
      }

      const cust = (document.getElementById("custName").value || "customer").trim();
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      pdf.save(`WARM-UP-UK_Contract_${cust || "client"}_${stamp}.pdf`);
    }

    // ---------- INIT ----------
    document.getElementById("btnPDF").addEventListener("click", generatePDF);

    populateProductDropdowns();
    bindCalcInputs();
    recalc();
    initSignatures();
  </script>
</body>
</html>
