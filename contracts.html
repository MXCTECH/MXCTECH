<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37;   /* gold */
    --danger:#c1121f;
    --line:#e8e8e8;
    --ink:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#f6f7f8; color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
  }
  /* Avoid zoom-jumps on iOS inputs */
  input,select,textarea,button{font-size:16px}

  .sheet{max-width:960px;margin:16px auto;padding:14px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .section-title{font-weight:800;font-size:18px;margin:18px 0 10px}

  /* Header */
  header.brand{display:grid;grid-template-columns:auto 1fr auto;gap:14px;align-items:center}
  header .logo{width:180px;max-width:40vw;height:auto}
  header .name{font-weight:900;font-size:42px;letter-spacing:.02em}
  header .addr{color:#333;line-height:1.35}
  header .meta{display:grid;gap:8px;min-width:240px}
  header .meta input{width:100%}
  @media (max-width:720px){
    header.brand{grid-template-columns:auto 1fr}
    header .logo{width:270px;max-width:65vw} /* ≈ 3× */
    header .meta{grid-column:1 / -1}
  }

  /* Blocks */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid2 > .box{background:#fafafa;border:1px solid var(--line);border-radius:10px;padding:10px}
  .box label{display:block;font-size:12px;color:#555;margin:6px 0 6px}
  .box input,.box textarea,.box select{width:100%;border:1px solid #cfcfcf;border-radius:8px;padding:10px 12px;background:#fff}
  .box textarea{min-height:92px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }

  /* Product lines */
  .lines{display:grid;gap:12px}
  .line{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fbfbfb}
  .line .row{display:grid;grid-template-columns:1fr;gap:8px}
  .line .under{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .line .total{grid-column:1 / -1}
  .line .banner{font-weight:700;color:#111;margin-bottom:4px}
  .line .readonly{background:#efefef;border:1px solid #ddd}
  @media (min-width:721px){
    .line .under{grid-template-columns:repeat(3,1fr)}
    .line .total{grid-column:auto}
  }

  /* Buttons */
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .btn{border:0;border-radius:10px;padding:12px 14px;font-weight:800;color:#000;background:var(--accent);cursor:pointer}
  .btn.dark{background:#111;color:#fff}
  .btn.red{background:#b10012;color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Options + totals */
  .panel{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
  .summary{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
  .summary .row{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #e2e2e2}
  .summary .row:last-child{border-bottom:none}
  .grand{font-size:22px;font-weight:900}
  .pound{color:var(--accent);font-weight:900}
  .balance{font-weight:800}

  /* Waiver */
  .waiver{border:2px solid var(--danger);background:#fff7f7;border-radius:12px;padding:12px}
  .waiver h3{margin:0 0 6px;color:var(--danger)}

  /* Notes (wider) */
  #notes{min-height:140px}

  /* Signatures */
  .sigs{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sig{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
  .sig label{font-weight:700}
  .sig canvas{width:100%;height:180px;border:1px dashed #bbb;border-radius:8px;background:#fff;touch-action:none}
  .sig .under{display:flex;gap:8px;margin-top:8px}
  .sig .under input{flex:1}
  @media (max-width:720px){ .sigs{grid-template-columns:1fr} }

  /* Capture wrapper for PDF */
  #capture{padding:12px;background:#fff;border:1px solid var(--line);border-radius:12px}

  .footer-note{font-size:12px;color:#666;text-align:center;margin-top:10px}
</style>
</head>
<body>
<div class="sheet">
  <!-- HEADER -->
  <header class="brand card">
    <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK" />
    <div>
      <div class="name">WARM UP UK</div>
      <div class="addr">
        321–323 Romford High Road, Essex RM6 6AX<br>
        <strong>Tel:</strong> <a href="tel:01708300670">01708 300670</a>
      </div>
    </div>
    <div class="meta">
      <label>Contract #</label><input id="contractNo" readonly>
      <label>Date</label><input id="contractDate" readonly>
    </div>
  </header>

  <div id="capture" class="card" style="margin-top:12px">
    <!-- CUSTOMER -->
    <div class="section-title">Customer</div>
    <div class="grid2">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name">
        <label>Property Address</label>
        <textarea id="custAddr" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…">
        <label>Email</label>
        <input id="custEmail" placeholder="email@example.com">
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="section-title">Products / Services</div>
    <div id="lines" class="lines"></div>
    <div class="controls">
      <button id="addLineBtn" class="btn">+ Add Line</button>
      <button id="removeLineBtn" class="btn">– Remove Last</button>
      <button id="clearLinesBtn" class="btn red">Clear Lines</button>
    </div>

    <!-- OPTIONS / TOTALS -->
    <div class="section-title">Totals</div>
    <div class="grid2">
      <div class="panel">
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <input type="checkbox" id="vatToggle"><label for="vatToggle"><strong>Apply VAT 20%</strong></label>
        </div>
        <div class="panel" style="padding:10px;background:#fbfbfb;border-color:#eee">
          Admin Fee of <strong>£150</strong> is automatically applied.
        </div>
        <div style="margin-top:10px">
          <label style="display:block;margin-bottom:6px">Install Date</label>
          <input id="installDate" readonly />
        </div>
      </div>

      <div class="summary" id="totalsBox">
        <div class="row"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
        <div class="row"><div>Admin Fee</div><div>£ <span id="adminFee">150.00</span></div></div>
        <div class="row"><div>VAT (20%)</div><div>£ <span id="vatAmt">0.00</span></div></div>
        <div class="row grand"><div>Grand Total</div><div><span class="pound">£</span> <span id="grand">150.00</span></div></div>
        <div class="row">
          <div>Less Deposit</div>
          <div style="display:flex;gap:6px;align-items:center">£
            <input id="deposit" type="number" min="0" step="0.01" value="0" style="width:120px;text-align:right">
          </div>
        </div>
        <div class="row balance"><div>Balance Due</div><div id="balance">£ 150.00</div></div>
      </div>
    </div>

    <!-- NOTES (wider) -->
    <div class="section-title">Notes</div>
    <div class="box" style="border-color:#ddd;background:#fff">
      <textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <!-- WAIVER -->
    <div class="section-title">Express Waiver</div>
    <div class="waiver">
      <h3>Express Waiver</h3>
      <p style="margin:6px 0 10px">
        I request that WARM UP UK begins work before the end of my 14-day cooling-off period.
        I understand this may affect my right to cancel once the work has started and materials have been ordered or installed.
      </p>
      <label style="display:flex;gap:8px;align-items:center;font-weight:600">
        <input id="waiverAck" type="checkbox"> I acknowledge and accept the Express Waiver.
      </label>
    </div>
  </div>

  <!-- SIGNATURES (rendered live here, moved to page 3 in PDF) -->
  <div class="section-title">Signatures</div>
  <div class="sigs">
    <div class="sig">
      <label>Customer Signature</label>
      <canvas id="sigCustomer"></canvas>
      <div class="under">
        <input id="sigCustName" placeholder="Customer printed name">
        <button type="button" class="btn dark" id="sigCustClear">Clear</button>
      </div>
    </div>
    <div class="sig">
      <label>Company Signature</label>
      <canvas id="sigCompany"></canvas>
      <div class="under">
        <input id="sigCompName" placeholder="Company representative">
        <button type="button" class="btn dark" id="sigCompClear">Clear</button>
      </div>
    </div>
  </div>

  <div class="controls" style="margin-top:14px">
    <button id="pdfBtn" class="btn dark" disabled>Generate PDF</button>
    <button id="clearBtn" class="btn red">Clear Form</button>
  </div>

  <div class="footer-note">
    WARM UP UK • 321–323 Romford High Road, Essex RM6 6AX • 01708 300670
  </div>
</div>

<script>
/* ----------------- CONSTANTS ----------------- */
const PRODUCTS = [
  "Loft Insulation 270mm Fibreglass",
  "Multifoil YBS SuperQuilt",
  "Pitched Roof TLX Silver",
  "Cavity Wall Insulation",
  "Spray Foam Removal",
  "Loft Boarding",
  "Ventilation Upgrade",
  "Vermin Treatment",
  "Timber Treatment"
];
const ADMIN_FEE = 150;
const VAT_RATE = 0.20;

/* ----------------- UTILITIES ----------------- */
const $ = sel => document.querySelector(sel);
function num(v){ const n=parseFloat(v); return isNaN(n)?0:n; }
function toGBP(n){ return (n||0).toFixed(2); }
function todayDMY(){
  const d=new Date(); const p=n=>String(n).padStart(2,'0');
  return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()}`; // DD-MM-YYYY
}
function genContractNo(){
  const d = new Date(); const p=n=>String(n).padStart(2,'0');
  return `WUU-${d.getFullYear().toString().slice(-2)}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}-${Math.floor(1000+Math.random()*9000)}`;
}

/* ----------------- HEADER INIT ----------------- */
const contractNo = $('#contractNo');
const contractDate = $('#contractDate');
contractNo.value = genContractNo();
contractDate.value = todayDMY();
const installDate = $('#installDate');
installDate.value = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});

/* ----------------- PRODUCTS ----------------- */
const linesEl = $('#lines');
const addLineBtn = $('#addLineBtn');
const removeLineBtn = $('#removeLineBtn');
const clearLinesBtn = $('#clearLinesBtn');

function makeSelect(){
  const sel = document.createElement('select');
  sel.innerHTML = `<option value="" disabled selected>Choose a product...</option>` +
                  PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
  return sel;
}
function makeLine(){
  const wrap = document.createElement('div');
  wrap.className = 'line';

  const top = document.createElement('div');
  top.className = 'row';
  const sel = makeSelect();
  top.appendChild(sel);

  const under = document.createElement('div');
  under.className = 'under';
  const qty = document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='1'; qty.placeholder='Qty 0';
  const unit = document.createElement('input'); unit.type='number'; unit.min='0'; unit.step='0.01'; unit.placeholder='Unit £ 0.00';
  const total = document.createElement('input'); total.readOnly=true; total.className='readonly'; total.placeholder='Line Total 0.00';

  // Labels (visually above fields)
  const qtyBox = document.createElement('div'); qtyBox.innerHTML = `<div class="banner">Qty</div>`; qtyBox.appendChild(qty);
  const unitBox= document.createElement('div'); unitBox.innerHTML= `<div class="banner">Unit £</div>`; unitBox.appendChild(unit);
  const totBox = document.createElement('div'); totBox.className='total'; totBox.innerHTML = `<div class="banner">Line Total</div>`; totBox.appendChild(total);

  under.append(qtyBox, unitBox, totBox);
  wrap.append(top, under);

  function recalcLine(){
    const val = num(qty.value) * num(unit.value);
    total.value = toGBP(val);
    recalcTotals();
  }
  [qty, unit, sel].forEach(el=> el.addEventListener('input', recalcLine));

  return wrap;
}
function addLine(){ linesEl.appendChild(makeLine()); recalcTotals(); }
function removeLine(){ if(linesEl.lastElementChild){ linesEl.lastElementChild.remove(); recalcTotals(); } }
function clearLines(){ linesEl.innerHTML=''; addLine(); }
addLineBtn.addEventListener('click', addLine);
removeLineBtn.addEventListener('click', removeLine);
clearLinesBtn.addEventListener('click', ()=>{ if(confirm('Clear all product lines?')){ clearLines(); }});
clearLines(); addLine(); addLine(); // start with 3

/* ----------------- TOTALS ----------------- */
const subtotalEl = $('#subtotal');
const adminFeeEl = $('#adminFee');
const vatAmtEl = $('#vatAmt');
const grandEl = $('#grand');
const balanceEl = $('#balance');
const depositEl = $('#deposit');
const vatToggle = $('#vatToggle');

function getSubtotal(){
  let s=0;
  linesEl.querySelectorAll('.line').forEach(line=>{
    const q = num(line.querySelector('input[placeholder^="Qty"]').value);
    const u = num(line.querySelector('input[placeholder^="Unit"]').value);
    s += q*u;
  });
  return s;
}
function recalcTotals(){
  const subtotal = getSubtotal();
  const admin = ADMIN_FEE;
  const beforeVAT = subtotal + admin;
  const vat = vatToggle.checked ? beforeVAT * VAT_RATE : 0;
  const grand = beforeVAT + vat;
  const deposit = num(depositEl.value);
  const balance = Math.max(grand - deposit, 0);

  subtotalEl.textContent = toGBP(subtotal);
  adminFeeEl.textContent = toGBP(admin);
  vatAmtEl.textContent = toGBP(vat);
  grandEl.textContent = toGBP(grand);
  balanceEl.textContent = `£ ${toGBP(balance)}`;
}
vatToggle.addEventListener('change', recalcTotals);
depositEl.addEventListener('input', recalcTotals);

/* ----------------- SIGNATURES ----------------- */
/* Lightweight canvas signer (no external lib) */
function makePad(canvas){
  const ctx = canvas.getContext('2d');
  let drawing=false,lastX=0,lastY=0;

  function resize(){
    const dpr = Math.max(window.devicePixelRatio||1,1);
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.round(r.width*dpr);
    canvas.height= Math.round(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
  }
  resize();
  window.addEventListener('resize', resize);

  function pos(e){
    const r = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]){
      return {x:e.touches[0].clientX - r.left, y:e.touches[0].clientY - r.top};
    }
    return {x:e.clientX - r.left, y:e.clientY - r.top};
  }
  function start(e){ drawing=true; document.body.style.overflow='hidden'; const p=pos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault(); }
  function end(){ drawing=false; document.body.style.overflow=''; }

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove', move, {passive:false});
  window.addEventListener('touchend', end);

  return {
    clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); resize(); },
    isEmpty(){
      const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
      for(let i=3;i<pixels.length;i+=4){ if(pixels[i]!==0) return false; } return true;
    },
    toDataURL(){ return canvas.toDataURL('image/png'); }
  }
}
const padCustomer = makePad(document.getElementById('sigCustomer'));
const padCompany  = makePad(document.getElementById('sigCompany'));
document.getElementById('sigCustClear').addEventListener('click', ()=>padCustomer.clear());
document.getElementById('sigCompClear').addEventListener('click', ()=>padCompany.clear());

/* Enable PDF when waiver ticked */
const pdfBtn = document.getElementById('pdfBtn');
const waiverAck = document.getElementById('waiverAck');
function updatePDFGate(){ pdfBtn.disabled = !waiverAck.checked; }
waiverAck.addEventListener('change', updatePDFGate); updatePDFGate();

/* ----------------- PDF ----------------- */
async function captureNodeAsCanvas(node){
  return await html2canvas(node, {
    backgroundColor:'#ffffff',
    scale:2,
    useCORS:true,
    windowWidth: node.scrollWidth,
    windowHeight: node.scrollHeight
  });
}
/* bake canvases to <img> so signatures don't vanish in html2canvas */
function bakeSignatures(){
  const swaps=[];
  document.querySelectorAll('.sig canvas').forEach(cv=>{
    const img = document.createElement('img');
    img.src = cv.toDataURL('image/png');
    img.style.width = cv.style.width || (cv.width + 'px');
    img.style.height = cv.style.height || (cv.height + 'px');
    img.style.border = cv.style.border; img.style.borderRadius = cv.style.borderRadius;
    cv.parentNode.insertBefore(img, cv);
    cv.style.display='none';
    swaps.push({cv,img});
  });
  return ()=>swaps.forEach(({cv,img})=>{ img.remove(); cv.style.display=''; });
}

async function generatePDF(){
  recalcTotals();
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'mm',format:'a4',orientation:'p'});
  const a4w = pdf.internal.pageSize.getWidth();
  const a4h = pdf.internal.pageSize.getHeight();

  /* -------- Page 1: everything inside #capture -------- */
  const restore = bakeSignatures();
  const canvas1 = await captureNodeAsCanvas(document.getElementById('capture'));
  restore();

  // Fit/slice onto A4
  const imgW = a4w;
  const ratio = canvas1.width / imgW;
  let topPx = 0; const pagePx = a4h * ratio;
  while(topPx < canvas1.height){
    const sliceH = Math.min(pagePx, canvas1.height - topPx);
    const pageCanvas = document.createElement('canvas');
    pageCanvas.width = canvas1.width; pageCanvas.height = sliceH;
    pageCanvas.getContext('2d').drawImage(canvas1, 0, topPx, canvas1.width, sliceH, 0, 0, canvas1.width, sliceH);
    const img = pageCanvas.toDataURL('image/jpeg', 0.95);
    if(topPx>0) pdf.addPage();
    pdf.addImage(img, 'JPEG', 0, 0, imgW, sliceH/ratio);
    topPx += sliceH;
  }

  /* -------- Page 2: Terms & Conditions -------- */
  pdf.addPage();
  pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
  pdf.text('Terms & Conditions (Summary)', 14, 16);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  const terms = [
    "1. All works to be carried out by or on behalf of WARM UP UK to agreed specification.",
    "2. Customer responsible for providing safe access to all work areas.",
    "3. Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.",
    "4. Electrical/ventilation upgrades, if required by building guidance, may be chargeable.",
    "5. Payment terms: unless otherwise stated, balance due on completion.",
    "6. Materials remain property of WARM UP UK until paid in full.",
    "7. Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.",
    "8. By signing, the customer confirms accuracy of details and authorises the work as described."
  ];
  const left=14, width=a4w-28; let y=26;
  terms.forEach(t=>{ const lines=pdf.splitTextToSize(t,width); pdf.text(lines,left,y); y += 7 + (lines.length-1)*5; });

  /* -------- Page 3: Signatures stacked smaller -------- */
  pdf.addPage();
  pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
  pdf.text('Signatures', 14, 16);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);

  const sigYGap = 70;
  function drawSigBlock(title, dataUrl, printed, yStart){
    pdf.text(title, 14, yStart);
    pdf.addImage(dataUrl,'PNG',14,yStart+4, a4w-28, 40); // smaller
    pdf.text(`Printed name: ${printed || ''}`, 14, yStart+50);
  }
  drawSigBlock('Customer Signature', padCustomer.toDataURL(), $('#sigCustName').value, 22);
  drawSigBlock('Company Signature',  padCompany.toDataURL(),  $('#sigCompName').value, 22+sigYGap);

  pdf.save(`${contractNo.value}.pdf`);
}
document.getElementById('pdfBtn').addEventListener('click', generatePDF);

/* ----------------- CLEAR ----------------- */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('Clear the entire form?')) return;
  ['custName','custAddr','custPhone','custEmail','notes','deposit','sigCustName','sigCompName'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value = (id==='deposit' ? 0 : ''); });
  vatToggle.checked=false;
  clearLines();
  padCustomer.clear(); padCompany.clear();
  contractNo.value = genContractNo();
  contractDate.value = todayDMY();
  installDate.value = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
  recalcTotals();
});

/* initial totals */
recalcTotals();
</script>
</body>
</html>
