<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>WARM UP UK – Contract</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#000;
    --accent:#d4af37; /* gold */
    --danger:#d90000;
    --line:#e8e8e8;
    --ink:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0; background:#f7f7f8; color:var(--ink);
    -webkit-font-smoothing:antialiased;
    overscroll-behavior:contain;
  }
  input, select, textarea, button { font-size:16px; } /* stop iOS zoom */

  .sheet{ max-width:900px; margin:16px auto; padding:16px;
    border:1px solid #ddd; border-radius:12px; background:#fff;
    box-shadow:0 3px 12px rgba(0,0,0,.06);
  }

  header.brand{
    display:flex; gap:16px; align-items:center; border-bottom:1px solid var(--line); padding-bottom:12px;
  }
  header.brand img.logo{ width:210px; height:auto; object-fit:contain; } /* ~3× bigger */
  .brandblock{flex:1}
  .brandblock h1{margin:0; font-size:28px; letter-spacing:.08em}
  .brandblock .addr{margin-top:6px; font-size:14px; line-height:1.35; color:#333}

  .gold{ background:var(--accent); color:#000; }
  .btn{ border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
  .btn.dark{ background:#111; color:#fff}
  .btn.secondary{ background:#2f2f2f; color:#fff}
  .btn.danger{ background:#b00020; color:#fff}
  .controls{ display:flex; gap:8px; flex-wrap:wrap; }

  .section-title{ font-weight:800; margin:18px 0 10px; font-size:16px; }

  .box{ background:#fafafa; border:1px solid var(--line); padding:10px; border-radius:8px;}
  .box label{display:block; font-size:12px; color:#555; margin-bottom:6px;}
  .box input, .box textarea, .box select{ width:100%; border:1px solid #ccc; border-radius:6px; padding:10px; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width:740px){ .grid2{grid-template-columns:1fr} }

  /* Contract/date row right under header, above customer for mobile space */
  .contractRow{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:12px 0 0; }
  .contractRow .box{ background:#fff; }
  @media (max-width:740px){ .contractRow{grid-template-columns:1fr 1fr 1fr} }

  /* Product lines as cards for mobile stacking */
  .lines{ display:grid; gap:10px; }
  .line{ border:1px solid var(--line); border-radius:10px; padding:10px; background:#fafafa; }
  .line .top{ display:block; }
  .line .bottom{
    display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:8px;
  }
  .line .bottom .cell label{ font-size:12px; color:#555; display:block; margin-bottom:4px }
  .line .bottom input{ width:100%; border:1px solid #ccc; border-radius:6px; padding:10px; text-align:right }
  .line .bottom .total input{ background:#f2f2f2; font-weight:700 }
  /* Mobile: stack Qty/Unit/Line Total under the product dropdown */
  @media (max-width:740px){
    .line .bottom{ grid-template-columns:1fr; }
  }

  .fine{ font-size:12px; color:#666; }

  .summary{ border:1px solid var(--line); border-radius:8px; padding:10px; background:#fff; }
  .summary .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #e3e3e3; }
  .summary .row:last-child{ border-bottom:none; }
  .grand{ font-size:18px; font-weight:800; }
  .pound{ color:var(--accent); font-weight:800; }

  .notes{ border:1px solid var(--line); border-radius:8px; padding:12px; background:#fff; }
  .notes textarea{ min-height:120px } /* wider/taller */

  .waiver{ border:2px solid var(--danger); background:#fff7f7; border-radius:10px; padding:12px; }
  .waiver h3{margin:0 0 6px; font-size:16px; color:#b00020}
  .waiver p{margin:6px 0 10px; font-size:14px; line-height:1.3}
  .waiver label{display:flex; gap:8px; align-items:flex-start}
  .waiver .flash{
    font-weight:800; color:#fff; background:var(--danger); padding:4px 8px; border-radius:6px;
    display:inline-block; animation:blink 1s infinite; margin-bottom:6px;
  }
  @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:.25} }
  .waiver.ack .flash{ display:none; }

  .signatures .sig-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width:740px){ .signatures .sig-grid{ grid-template-columns:1fr } }
  .sig{ border:1px dashed #bbb; border-radius:8px; padding:10px; background:#fafafa; }
  .sig canvas{
    width:100%; height:200px; background:#fff; border:1px solid #ddd; border-radius:6px;
    touch-action:none;
  }
  .sig .sig-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:6px }
  .sig .sig-row input{ flex:1 }

  .footer-note{ text-align:center; font-size:12px; color:#777; margin-top:10px; }

  /* Only show control buttons on screen, never on PDF capture */
  .screen-only{ display:flex; gap:8px; flex-wrap:wrap; }
  @media print{ .screen-only{ display:none !important } }

  /* PDF container sections (for clean multi-page slicing) */
  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }

  /* Keep totals high to help them land on PDF page 1 */
  .totalsWrap{ margin-top:12px; display:grid; grid-template-columns:1fr 320px; gap:12px; align-items:start; }
  @media (max-width:900px){ .totalsWrap{ grid-template-columns:1fr } }
</style>
</head>
<body>
  <div id="capture" class="sheet">
    <!-- HEADER -->
    <header class="brand">
      <img class="logo" src="warmupuklogo.jpg" alt="WARM UP UK logo" />
      <div class="brandblock">
        <h1>WARM UP UK</h1>
        <div class="addr">
          321-323 Romford High Road, Essex RM6 6AX<br />
          <strong>Tel:</strong> 01708 300670
        </div>
      </div>
    </header>

    <!-- CONTRACT # / DATE / INSTALL DATE (placed above Customer for mobile space) -->
    <div class="contractRow">
      <div class="box">
        <label>Contract #</label>
        <input id="contractNo" readonly />
      </div>
      <div class="box">
        <label>Date (DD-MM-YYYY)</label>
        <input id="contractDate" readonly />
      </div>
      <div class="box">
        <label>Install Date</label>
        <input id="installDate" type="date" />
      </div>
    </div>

    <!-- CUSTOMER -->
    <div class="section-title">Customer</div>
    <div class="grid2">
      <div class="box">
        <label>Customer Name</label>
        <input id="custName" placeholder="Full name" />
        <label>Property Address</label>
        <textarea id="custAddr" rows="3" placeholder="House/Street, Town, Postcode"></textarea>
      </div>
      <div class="box">
        <label>Phone</label>
        <input id="custPhone" placeholder="07…" />
        <label>Email</label>
        <input id="custEmail" placeholder="email@example.com" />
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="section-title">Products / Services</div>
    <div id="lines" class="lines"></div>

    <!-- Screen-only product controls (moved into the Products section as requested) -->
    <div class="screen-only" style="margin:10px 0 0">
      <button type="button" id="addLineBtn" class="btn gold">+ Add Line</button>
      <button type="button" id="removeLineBtn" class="btn gold">− Remove Last</button>
      <button type="button" id="clearLinesBtn" class="btn danger">Clear Lines</button>
      <button type="button" id="scrollTotalsBtn" class="btn dark">Jump to Totals</button>
    </div>

    <!-- TOTALS (pulled up under lines so PDF keeps them on page 1) -->
    <div class="totalsWrap">
      <div class="box">
        <div class="section-title" style="margin-top:0">Options</div>
        <div style="display:flex; gap:10px; align-items:center">
          <input type="checkbox" id="vatToggle" />
          <label for="vatToggle">Apply <strong>VAT 20%</strong></label>
        </div>
        <div class="fine" style="margin-top:6px">Admin Fee of <strong>£150</strong> is automatically applied.</div>
      </div>

      <div class="summary" id="totalsBox">
        <div class="row"><div>Subtotal</div><div>£ <span id="subtotal">0.00</span></div></div>
        <div class="row"><div>Admin Fee</div><div>£ <span id="adminFee">150.00</span></div></div>
        <div class="row"><div>VAT (20%)</div><div>£ <span id="vatAmt">0.00</span></div></div>
        <div class="row grand"><div>Grand Total</div><div><span class="pound">£</span> <span id="grand">150.00</span></div></div>
        <div class="row">
          <div>Deposit</div>
          <div style="display:flex; gap:6px; align-items:center">
            £ <input id="deposit" type="number" min="0" step="0.01" value="0"
                     style="width:120px; text-align:right; border:1px solid #ccc; border-radius:6px; padding:6px 8px">
          </div>
        </div>
        <div class="row" style="border-top:1px dashed #e3e3e3; margin-top:6px; padding-top:8px">
          <div><strong>Balance Due</strong></div><div><strong>£ <span id="balance">150.00</span></strong></div>
        </div>
      </div>
    </div>

    <!-- NOTES (wider) -->
    <div class="notes" style="margin-top:12px">
      <div class="section-title" style="margin-top:0">Notes</div>
      <textarea id="notes" placeholder="Any specific instructions or clarifications…"></textarea>
    </div>

    <!-- WAIVER under notes (still on page 1) -->
    <div id="waiver" class="waiver avoid-break" style="margin-top:12px">
      <div class="flash">ACTION REQUIRED</div>
      <h3>Express Waiver</h3>
      <p>
        I request that WARM UP UK begins work before the end of my 14-day cooling-off period. I understand this may
        affect my right to cancel once the work has started and materials have been ordered or installed.
      </p>
      <label><input type="checkbox" id="waiverAck"> I acknowledge and accept the Express Waiver.</label>
    </div>

    <!-- SCREEN-ONLY MAIN CONTROLS -->
    <div class="screen-only" style="margin-top:12px">
      <button id="pdfBtn" type="button" class="btn dark" disabled>Generate PDF</button>
      <button id="clearBtn" type="button" class="btn danger">Clear Form</button>
    </div>

    <!-- PAGE 2 CONTENT (T&Cs + Signatures) – captured into PDF as page two -->
    <div id="page2" class="avoid-break" style="margin-top:18px">
      <div class="box">
        <div class="section-title" style="margin-top:0">Terms &amp; Conditions (Summary)</div>
        <ol style="padding-left:18px">
          <li>All works to be carried out by or on behalf of WARM UP UK to agreed specification.</li>
          <li>Customer responsible for providing safe access to all work areas.</li>
          <li>Any unforeseen remedial works (e.g., rotten timbers, vermin damage) will be quoted separately.</li>
          <li>Electrical/ventilation upgrades, if required by building guidance, may be chargeable.</li>
          <li>Payment terms: unless otherwise stated, balance due on completion.</li>
          <li>Materials remain property of WARM UP UK until paid in full.</li>
          <li>Cancellations within 14 days are subject to statutory rights; bespoke materials may incur charges.</li>
          <li>By signing, the customer confirms accuracy of details and authorises the work as described.</li>
          <li>VAT: charged where applicable at the prevailing rate.</li>
          <li>Dispute resolution: contact us in writing; we aim to resolve issues promptly and fairly.</li>
        </ol>
      </div>

      <div class="signatures" style="margin-top:12px">
        <div class="section-title" style="margin-top:0">Signatures</div>
        <div class="sig-grid">
          <div class="sig">
            <label><strong>Customer Signature</strong></label>
            <canvas id="sigCustomer"></canvas>
            <div class="sig-row">
              <input id="sigCustName" placeholder="Customer printed name" />
              <button type="button" class="btn secondary" data-clear="sigCustomer">Clear</button>
            </div>
          </div>
          <div class="sig">
            <label><strong>Company Signature</strong></label>
            <canvas id="sigCompany"></canvas>
            <div class="sig-row">
              <input id="sigCompName" placeholder="Company representative" />
              <button type="button" class="btn secondary" data-clear="sigCompany">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-note">
      WARM UP UK • 321-323 Romford High Road, Essex RM6 6AX • 01708 300670
    </div>
  </div>

<script>
(function(){
  // ---------- CONSTANTS ----------
  const PRODUCTS = [
    "Loft Insulation 270mm Fibreglass",
    "Multifoil YBS SuperQuilt",
    "Pitched Roof TLX Silver",
    "Cavity Wall Insulation",
    "Spray Foam Removal",
    "Loft Boarding",
    "Ventilation Upgrade",
    "Vermin treatment",
    "Timber treatment"
  ];
  const ADMIN_FEE = 150;
  const VAT_RATE = 0.20;

  // ---------- EL REFS ----------
  const linesEl     = document.getElementById('lines');
  const addLineBtn  = document.getElementById('addLineBtn');
  const removeLineBtn = document.getElementById('removeLineBtn');
  const clearLinesBtn = document.getElementById('clearLinesBtn');
  const scrollTotalsBtn = document.getElementById('scrollTotalsBtn');

  const vatToggle   = document.getElementById('vatToggle');
  const subtotalEl  = document.getElementById('subtotal');
  const adminFeeEl  = document.getElementById('adminFee');
  const vatAmtEl    = document.getElementById('vatAmt');
  const grandEl     = document.getElementById('grand');
  const depositEl   = document.getElementById('deposit');
  const balanceEl   = document.getElementById('balance');

  const waiverEl    = document.getElementById('waiver');
  const waiverAck   = document.getElementById('waiverAck');
  const pdfBtn      = document.getElementById('pdfBtn');
  const clearBtn    = document.getElementById('clearBtn');

  const contractNo  = document.getElementById('contractNo');
  const contractDate= document.getElementById('contractDate');
  const installDate = document.getElementById('installDate');
  const custName    = document.getElementById('custName');
  const custAddr    = document.getElementById('custAddr');
  const custPhone   = document.getElementById('custPhone');
  const custEmail   = document.getElementById('custEmail');
  const notes       = document.getElementById('notes');

  // ---------- UTIL ----------
  const num = (v)=>{ const n=parseFloat(v); return isNaN(n)?0:n; };
  const money = (n)=> (Number(n||0).toFixed(2));

  function genContractNo(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    const code = `${pad(d.getDate())}${pad(d.getMonth()+1)}${String(d.getFullYear()).slice(-2)}-${pad(d.getHours())}${pad(d.getMinutes())}`;
    return `WUU-${code}-${Math.floor(1000+Math.random()*9000)}`;
  }
  function todayDDMMYYYY(){
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()}`;
  }

  contractNo.value = genContractNo();
  contractDate.value = todayDDMMYYYY();

  // ---------- PRODUCTS (card rows; mobile stack) ----------
  function makeSelect(){
    const sel = document.createElement('select');
    sel.innerHTML = `<option value="" disabled selected>Choose a product…</option>` +
      PRODUCTS.map(p => `<option value="${p}">${p}</option>`).join('');
    return sel;
  }

  function makeLine(){
    const row = document.createElement('div');
    row.className = 'line';

    const top = document.createElement('div');
    top.className = 'top';
    const sel = makeSelect();
    top.appendChild(sel);

    const bottom = document.createElement('div');
    bottom.className = 'bottom';

    const qty = document.createElement('div');
    qty.className = 'cell';
    qty.innerHTML = `<label>Qty</label><input type="number" min="0" step="1" value="0">`;

    const unit = document.createElement('div');
    unit.className = 'cell';
    unit.innerHTML = `<label>Unit £</label><input type="number" min="0" step="0.01" value="0">`;

    const total = document.createElement('div');
    total.className = 'cell total';
    total.innerHTML = `<label>Line Total</label><input type="text" value="0.00" readonly>`;

    bottom.append(qty, unit, total);
    row.append(top, bottom);

    function recalcLine(){
      const q = num(qty.querySelector('input').value);
      const u = num(unit.querySelector('input').value);
      total.querySelector('input').value = money(q*u);
      recalcTotals();
    }
    [qty.querySelector('input'), unit.querySelector('input')].forEach(i => {
      i.addEventListener('input', recalcLine);
    });
    sel.addEventListener('change', ()=>{}); // reserved

    return row;
  }

  function addLine(){ linesEl.appendChild(makeLine()); recalcTotals(); }
  function removeLine(){
    if(linesEl.lastElementChild){ linesEl.removeChild(linesEl.lastElementChild); recalcTotals(); }
  }
  function clearLines(){ linesEl.innerHTML=''; recalcTotals(); }

  addLineBtn.addEventListener('click', addLine);
  removeLineBtn.addEventListener('click', removeLine);
  clearLinesBtn.addEventListener('click', ()=>{ if(confirm('Clear all product lines?')){ clearLines(); addLine(); }});
  scrollTotalsBtn.addEventListener('click', ()=> document.getElementById('totalsBox').scrollIntoView({behavior:'smooth'}));

  // start with three lines (your usual flow)
  addLine(); addLine(); addLine();

  // ---------- TOTALS ----------
  function getSubtotal(){
    let s = 0;
    [...document.querySelectorAll('.line')].forEach(row=>{
      const q = num(row.querySelector('.bottom .cell:nth-child(1) input').value);
      const u = num(row.querySelector('.bottom .cell:nth-child(2) input').value);
      s += q*u;
    });
    return s;
  }

  function recalcTotals(){
    const subtotal = getSubtotal();
    const admin = ADMIN_FEE;
    const beforeVAT = subtotal + admin;
    const vat = document.getElementById('vatToggle').checked ? beforeVAT * VAT_RATE : 0;
    const grand = beforeVAT + vat;
    const deposit = num(depositEl.value);
    const balance = Math.max(grand - deposit, 0);

    subtotalEl.textContent = money(subtotal);
    adminFeeEl.textContent = money(admin);
    vatAmtEl.textContent = money(vat);
    grandEl.textContent = money(grand);
    balanceEl.textContent = money(balance);
  }
  vatToggle.addEventListener('change', recalcTotals);
  depositEl.addEventListener('input', recalcTotals);

  // ---------- SIGNATURES with resize-safe memory ----------
  function signaturePad(canvas){
    const ctx = canvas.getContext('2d');
    let drawing=false, last=null;
    let strokes = []; // store paths as arrays of points [{x,y},...]

    function resize(restoreImg){
      const dpr = Math.max(window.devicePixelRatio||1,1);
      const rect = canvas.getBoundingClientRect();
      const prev = canvas.toDataURL('image/png');
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2; ctx.lineCap='round'; ctx.strokeStyle='#000'; ctx.fillStyle='#000';
      if(restoreImg){
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, rect.width, rect.height); };
        img.src = prev;
      }else{
        // redraw strokes scaled to new size if we kept normalized points
        redraw();
      }
    }

    function pos(e){
      const r = canvas.getBoundingClientRect();
      if(e.touches && e.touches[0]){
        return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
      }
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    function start(e){
      drawing=true;
      last = pos(e);
      strokes.push([last]);
      e.preventDefault();
      document.body.style.overflow='hidden';
    }
    function move(e){
      if(!drawing) return;
      const p = pos(e);
      const path = strokes[strokes.length-1];
      path.push(p);
      ctx.beginPath(); ctx.moveTo(last.x, last.y); ctx.lineTo(p.x, p.y); ctx.stroke();
      last = p;
      e.preventDefault();
    }
    function end(){
      drawing=false; last=null;
      document.body.style.overflow='';
    }
    function clear(){
      strokes = [];
      ctx.clearRect(0,0,canvas.width,canvas.height);
      resize(false);
    }
    function redraw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
      strokes.forEach(path=>{
        for(let i=1;i<path.length;i++){
          ctx.beginPath();
          ctx.moveTo(path[i-1].x, path[i-1].y);
          ctx.lineTo(path[i].x, path[i].y);
          ctx.stroke();
        }
      });
    }
    function toDataURL(){ return canvas.toDataURL('image/png'); }
    function isEmpty(){ return strokes.length===0; }

    // init + keep across rotate
    resize(false);
    window.addEventListener('resize', ()=>{ resize(false); });

    canvas.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start, {passive:false});
    window.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end);

    return { clear, toDataURL, isEmpty, redraw };
  }

  const sigCustomer = signaturePad(document.getElementById('sigCustomer'));
  const sigCompany  = signaturePad(document.getElementById('sigCompany'));
  document.querySelectorAll('[data-clear]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-clear');
      (id === 'sigCustomer' ? sigCustomer : sigCompany).clear();
    });
  });

  // ---------- WAIVER GATE ----------
  function updateWaiver(){
    if(waiverAck.checked){ waiverEl.classList.add('ack'); pdfBtn.disabled=false; }
    else { waiverEl.classList.remove('ack'); pdfBtn.disabled=true; }
  }
  waiverAck.addEventListener('change', updateWaiver);

  // ---------- PDF HELPERS ----------
  function bakeCanvases(){
    const swaps = [];
    document.querySelectorAll('canvas').forEach(cv=>{
      const img = document.createElement('img');
      img.src = cv.toDataURL('image/png');
      img.style.width = cv.style.width || (cv.width + "px");
      img.style.height = cv.style.height || (cv.height + "px");
      img.style.border = cv.style.border; img.style.borderRadius = cv.style.borderRadius;
      cv.parentNode.insertBefore(img, cv);
      cv.style.display='none';
      swaps.push({cv,img});
    });
    return ()=>{ swaps.forEach(({cv,img})=>{ img.remove(); cv.style.display=''; }); };
  }

  async function renderNodeToPdfPages(pdf, node){
    const { jsPDF } = window.jspdf;
    const a4w=210, a4h=297;
    const canvas = await html2canvas(node, {
      scale:2, useCORS:true, backgroundColor:'#ffffff',
      windowWidth: node.scrollWidth, windowHeight: node.scrollHeight
    });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const mmPerPx = a4w / canvas.width;
    const imgH = canvas.height * mmPerPx;

    if(imgH <= a4h){
      pdf.addImage(imgData,'JPEG',0,0,a4w,imgH);
    }else{
      let topPx=0; const pagePx = a4h / mmPerPx;
      while(topPx < canvas.height){
        const sliceH = Math.min(pagePx, canvas.height-topPx);
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width; pageCanvas.height = sliceH;
        const ctx = pageCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, topPx, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
        const pageImg = pageCanvas.toDataURL('image/jpeg', 0.95);
        if(topPx>0) pdf.addPage();
        pdf.addImage(pageImg,'JPEG',0,0,a4w,sliceH*mmPerPx);
        topPx += sliceH;
      }
    }
  }

  // ---------- PDF GENERATION ----------
  async function generatePDF(){
    recalcTotals();

    if(!waiverAck.checked){
      alert('Please acknowledge the Express Waiver before generating the PDF.');
      return;
    }
    // Bake canvases so signatures appear
    const restore = bakeCanvases();

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:'mm', format:'a4', orientation:'p'});

    // PAGE 1: capture only the top section up to (and including) waiver
    // We'll capture the full "capture" then slice by pages automatically.
    await renderNodeToPdfPages(pdf, document.getElementById('capture'));

    // PAGE 2: Force a dedicated page with T&Cs + Signatures only (clean)
    pdf.addPage();
    await renderNodeToPdfPages(pdf, document.getElementById('page2'));

    restore();
    pdf.save(`${contractNo.value || 'WarmUpUK_Contract'}.pdf`);
  }
  document.getElementById('pdfBtn').addEventListener('click', generatePDF);

  // ---------- CLEAR ----------
  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Clear all fields?')) return;
    [custName,custAddr,custPhone,custEmail,notes].forEach(i=>i.value='');
    // reset products to 3
    linesEl.innerHTML=''; addLine(); addLine(); addLine();
    vatToggle.checked=false; depositEl.value='0'; recalcTotals();
    waiverAck.checked=false; updateWaiver();
    document.getElementById('sigCustName').value=''; document.getElementById('sigCompName').value='';
    sigCustomer.clear(); sigCompany.clear();
    contractNo.value = genContractNo(); contractDate.value = todayDDMMYYYY();
    installDate.value = '';
    window.scrollTo({top:0, behavior:'smooth'});
  });

  // init
  updateWaiver();
  recalcTotals();
})();
</script>
</body>
</html>
