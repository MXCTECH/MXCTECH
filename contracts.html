<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Warm Up UK – Contract</title>
<style>
  :root{
    --gold:#C9A227;
    --dark:#111111;
    --mid:#444;
    --light:#f7f7f7;
    --danger:#cc0000;
  }
  *{box-sizing:border-box}
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin:0; background:#fff; color:#111; line-height:1.35;
  }
  .wrap{max-width:1000px; margin:0 auto; padding:16px;}
  header{
    display:flex; gap:16px; align-items:center; flex-wrap:wrap; padding:8px 0 12px;
    border-bottom:2px solid #eee;
  }
  header img{height:64px; width:auto; display:block;}
  .brand h1{margin:0; font-size:24px; letter-spacing:0.5px;}
  .brand .sub{font-size:14px; color:#555; margin-top:4px;}
  .brand .sub strong{color:#000}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1 1 240px}
  label{font-size:12px; color:#444; display:block; margin-bottom:6px}
  input, select, textarea{
    width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff;
  }
  textarea{min-height:80px; resize:vertical}
  .section-title{
    font-weight:700; margin:18px 0 10px; font-size:16px; color:#000;
    border-left:4px solid var(--gold); padding-left:8px;
  }
  table{width:100%; border-collapse:collapse; background:#fff}
  th, td{border:1px solid #eee; padding:10px; font-size:14px; vertical-align:middle}
  th{background:#fafafa; text-align:left}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
  .btn{
    appearance:none; border:none; padding:10px 14px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px;
    background:#000; color:#fff;
  }
  .btn.secondary{background:#eaeaea; color:#111}
  .btn.danger{background:var(--danger)}
  .right{margin-left:auto}
  .money{font-variant-numeric: tabular-nums}
  .totals{
    display:grid; grid-template-columns:1fr auto; gap:8px; max-width:420px; margin-left:auto; margin-top:10px;
  }
  .totals .label{color:#555}
  .totals .value{font-weight:700}
  .highlight{color:#000}
  .waiver{
    position:relative; border:2px solid var(--danger); border-radius:12px; padding:12px; background:#fff7f7; margin:10px 0 6px;
    animation:flash 1s infinite;
  }
  @keyframes flash{
    0%,100%{box-shadow:0 0 0 0 rgba(204,0,0,0.6)}
    50%{box-shadow:0 0 12px 2px rgba(204,0,0,0.35)}
  }
  .waiver h3{margin:0 0 8px; color:#a40000; font-size:16px}
  .waiver small{color:#7a0000}
  .sig-wrap{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0;
  }
  .sig{
    border:1px dashed #bbb; border-radius:8px; padding:8px; background:#fff;
  }
  .sig label{margin-bottom:6px}
  canvas.signature{
    width:100%; height:220px; background:#fff; border:1px solid #eee; border-radius:6px; touch-action:none;
  }
  .note{font-size:12px; color:#666}
  .terms{font-size:12px; color:#222; background:#fcfcfc; border:1px solid #eee; border-radius:8px; padding:10px}
  .footer{font-size:12px; color:#666; text-align:center; margin:16px 0 6px}
  @media (max-width:560px){
    .sig-wrap{grid-template-columns:1fr}
    canvas.signature{height:180px}
    header img{height:56px}
    .brand h1{font-size:20px}
  }
</style>
</head>
<body>
<div class="wrap" id="contractRoot">

  <header>
    <img src="warmupuklogo.jpg" alt="Warm Up UK logo" />
    <div class="brand">
      <h1>WARM UP UK</h1>
      <div class="sub">
        <strong>Address:</strong> 321-323 Romford High Road, Essex, RM6 6AX
      </div>
    </div>
  </header>

  <div class="row">
    <div class="col">
      <label>Customer Name</label>
      <input id="custName" placeholder="Full name" />
    </div>
    <div class="col">
      <label>Phone</label>
      <input id="custPhone" inputmode="tel" placeholder="07…" />
    </div>
    <div class="col">
      <label>Email</label>
      <input id="custEmail" type="email" placeholder="name@email.com" />
    </div>
  </div>
  <div class="row">
    <div class="col" style="flex: 1 1 100%">
      <label>Installation Address</label>
      <input id="custAddress" placeholder="House, Street, Town, Postcode" />
    </div>
  </div>

  <div class="section-title">Products</div>

  <!-- PRODUCTS TABLE (layout preserved: dropdown + qty + unit cost + line total) -->
  <table id="productsTable" aria-label="Products">
    <thead>
      <tr>
        <th style="width:44%">Product</th>
        <th style="width:14%">Qty</th>
        <th style="width:20%">Unit (£)</th>
        <th style="width:18%">Line (£)</th>
        <th style="width:4%"></th>
      </tr>
    </thead>
    <tbody id="productBody">
      <!-- rows inserted by JS from template -->
    </tbody>
  </table>

  <div class="actions">
    <button class="btn" id="addRowBtn">+ Add Product</button>
    <button class="btn secondary" id="clearRowsBtn">Clear Products</button>
    <div class="right"></div>
    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="vatToggle" /> Add VAT
    </label>
    <label style="display:flex; align-items:center; gap:6px;">
      Admin Fee £ <input id="adminFee" type="number" inputmode="decimal" value="0" style="width:90px; padding:6px 8px" />
    </label>
  </div>

  <div class="totals">
    <div class="label">Sub-Total</div><div class="value money" id="subTotal">£0.00</div>
    <div class="label">Admin Fee</div><div class="value money" id="adminFeeOut">£0.00</div>
    <div class="label">VAT (20%)</div><div class="value money" id="vatOut">£0.00</div>
    <div class="label highlight">Grand Total</div><div class="value money" id="grandTotal">£0.00</div>
  </div>

  <div class="section-title">Express Waiver</div>
  <div class="waiver">
    <h3>Express Waiver – Customer Confirmation Required</h3>
    <p style="margin:6px 0 8px;">
      By enabling the <strong>Express Waiver</strong>, you acknowledge that you have reviewed the product choice and installation scope,
      and you agree for works to commence at the earliest available date. This may waive certain cooling-off provisions.
    </p>
    <label style="display:flex; gap:8px; align-items:center; margin-top:6px;">
      <input type="checkbox" id="waiverConfirm" />
      <span><strong>I confirm</strong> the Express Waiver.</span>
    </label>
    <small>Tick “I confirm” before generating the PDF.</small>
  </div>

  <div class="section-title">Signatures</div>
  <div class="sig-wrap">
    <div class="sig">
      <label>Customer Signature</label>
      <canvas class="signature" id="sigCustomer"></canvas>
      <div class="actions">
        <button class="btn secondary" data-clear="sigCustomer">Clear</button>
      </div>
      <div class="note">Sign with your finger (mobile) or mouse (desktop).</div>
    </div>
    <div class="sig">
      <label>Company Representative Signature</label>
      <canvas class="signature" id="sigCompany"></canvas>
      <div class="actions">
        <button class="btn secondary" data-clear="sigCompany">Clear</button>
      </div>
      <div class="note">Sign with your finger (mobile) or mouse (desktop).</div>
    </div>
  </div>

  <div class="section-title">Notes</div>
  <textarea id="notes" placeholder="Any special access notes, loft condition, ventilation, etc."></textarea>

  <div class="section-title">Terms & Conditions (Summary)</div>
  <div class="terms">
    <ol>
      <li>Quotation valid for 30 days. Variations subject to site conditions.</li>
      <li>Customer confirms access, power, and clear loft/storage areas as needed.</li>
      <li>Products per contract; substitutions require written approval.</li>
      <li>Property owner’s permission obtained by customer where applicable.</li>
      <li>Payment terms as agreed on the contract; deposits non-refundable if customer cancels after waiver.</li>
      <li>VAT charged where applicable.</li>
      <li>Workmanship warranty per Warm Up UK policy; manufacturer warranties per product.</li>
      <li>Dispute resolution in England & Wales jurisdiction.</li>
    </ol>
  </div>

  <div class="actions" style="margin-top:16px">
    <button class="btn danger" id="resetAll">Reset Form</button>
    <div class="right"></div>
    <button class="btn" id="generatePdf">Generate PDF</button>
  </div>

  <div class="footer">
    © <span id="year"></span> WARM UP UK · 321-323 Romford High Road, Essex, RM6 6AX
  </div>
</div>

<!-- PRODUCT ROW TEMPLATE (drop-in) -->
<template id="productRowTpl">
  <tr>
    <td>
      <select class="prod">
        <option value="">Select a product…</option>
        <option>Loft Insulation 270mm Fibreglass</option>
        <option>Multifoil YBS SuperQuilt</option>
        <option>Pitched Roof TLX Silver</option>
        <option>Cavity Wall Insulation</option>
        <option>Spray Foam Removal</option>
        <option>Loft Boarding</option>
        <option>Ventilation Upgrade</option>
        <option>Vermin Treatment</option>
        <option>Timber Treatment</option>
      </select>
    </td>
    <td><input class="qty" type="number" inputmode="decimal" min="0" step="0.01" value="0" /></td>
    <td><input class="unit" type="number" inputmode="decimal" min="0" step="0.01" value="0" /></td>
    <td class="money line">£0.00</td>
    <td><button class="btn secondary remove" title="Remove row">✕</button></td>
  </tr>
</template>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.4/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(function(){
  const $ = (sel,ctx=document)=>ctx.querySelector(sel);
  const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
  const money = n => "£" + (Number(n)||0).toFixed(2);

  // YEAR
  $('#year').textContent = new Date().getFullYear();

  // PRODUCTS
  const body = $('#productBody');
  const tpl = $('#productRowTpl');

  function addRow(prefill){
    const node = tpl.content.firstElementChild.cloneNode(true);
    if(prefill){
      node.querySelector('.prod').value = prefill.prod || "";
      node.querySelector('.qty').value = prefill.qty ?? 0;
      node.querySelector('.unit').value = prefill.unit ?? 0;
    }
    // events
    node.querySelector('.qty').addEventListener('input', recalc);
    node.querySelector('.unit').addEventListener('input', recalc);
    node.querySelector('.prod').addEventListener('change', recalc);
    node.querySelector('.remove').addEventListener('click', ()=>{ node.remove(); recalc(); });
    body.appendChild(node);
    recalc();
  }

  $('#addRowBtn').addEventListener('click', ()=>addRow());
  $('#clearRowsBtn').addEventListener('click', ()=>{
    body.innerHTML = '';
    addRow();
    recalc();
  });

  function recalc(){
    let sub = 0;
    $$('#productBody tr').forEach(tr=>{
      const qty = parseFloat(tr.querySelector('.qty').value) || 0;
      const unit= parseFloat(tr.querySelector('.unit').value) || 0;
      const line= qty * unit;
      sub += line;
      tr.querySelector('.line').textContent = money(line);
    });
    const admin = parseFloat($('#adminFee').value)||0;
    const vat = $('#vatToggle').checked ? (sub+admin)*0.20 : 0;
    $('#subTotal').textContent = money(sub);
    $('#adminFeeOut').textContent = money(admin);
    $('#vatOut').textContent = money(vat);
    $('#grandTotal').textContent = money(sub + admin + vat);
  }
  $('#adminFee').addEventListener('input', recalc);
  $('#vatToggle').addEventListener('change', recalc);

  // INIT: two rows to match your usual layout
  addRow();
  addRow();

  // SIGNATURES
  const sigPads = {};
  function setupSig(canvasId){
    const canvas = document.getElementById(canvasId);
    function fit(){
      // handle DPR for crisp signatures + mobile rotation
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = rect.width * ratio;
      canvas.height = rect.height * ratio;
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      // keep existing drawing if needed – here we clear on resize
      sigPads[canvasId].clear();
    }
    sigPads[canvasId] = new window.SignaturePad(canvas, { penColor: "#000", backgroundColor: "rgba(0,0,0,0)" });
    window.addEventListener('resize', fit);
    fit();
  }
  setupSig('sigCustomer');
  setupSig('sigCompany');

  $$('[data-clear]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-clear');
      sigPads[id].clear();
    });
  });

  $('#resetAll').addEventListener('click', ()=>{
    // clear inputs
    ['custName','custPhone','custEmail','custAddress','notes'].forEach(id=>{ $('#'+id).value=''; });
    $('#vatToggle').checked=false;
    $('#adminFee').value='0';
    $('#waiverConfirm').checked=false;
    sigPads['sigCustomer'].clear();
    sigPads['sigCompany'].clear();
    body.innerHTML='';
    addRow();
    addRow();
    recalc();
    window.scrollTo({top:0, behavior:'smooth'});
  });

  // PDF
  async function makePDF(){
    if(!$('#waiverConfirm').checked){
      alert('Please tick the Express Waiver confirmation before generating the PDF.');
      return;
    }
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','pt','a4');
    const root = document.getElementById('contractRoot');

    // embed signatures into hidden images temporarily for capture
    // Create signature images
    const sigCustData = sigPads['sigCustomer'].isEmpty() ? null : sigPads['sigCustomer'].toDataURL('image/png');
    const sigCompData = sigPads['sigCompany'].isEmpty() ? null : sigPads['sigCompany'].toDataURL('image/png');

    // Render to canvas (A4 width scaling)
    const a4w = 595.28, a4h = 841.89, margin = 24;
    const scale = 2; // higher for clarity

    const canvas = await html2canvas(root, { scale });
    const imgData = canvas.toDataURL('image/png');
    const pageWidth = a4w - margin*2;
    const pageHeight = a4h - margin*2;
    const imgWidth = pageWidth;
    const imgHeight = canvas.height * (imgWidth / canvas.width);

    let heightLeft = imgHeight;
    let position = margin;

    pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0){
      pdf.addPage();
      position = margin - (imgHeight - heightLeft);
      pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // Add signatures onto the last page (or create a page if empty)
    const addSig = (data, x, y, label)=>{
      if(!data) return;
      const cur = pdf.internal.getNumberOfPages();
      pdf.setPage(cur);
      pdf.setFontSize(10);
      pdf.text(label, x, y-6);
      pdf.addImage(data, 'PNG', x, y, 180, 70);
      pdf.setDrawColor(180); pdf.rect(x, y, 180, 70);
    };

    // Place at bottom of final page (safe margin)
    const last = pdf.internal.getNumberOfPages();
    pdf.setPage(last);
    const bottomY = a4h - 90;
    addSig(sigCustData, margin, bottomY, 'Customer Signature');
    addSig(sigCompData, margin+200, bottomY, 'Company Signature');

    pdf.save(`Warm_Up_UK_Contract_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  $('#generatePdf').addEventListener('click', makePDF);

  // Recalc on input changes globally
  document.addEventListener('input', e=>{
    if(e.target.matches('.qty,.unit')) recalc();
  });

})();
</script>
</body>
</html>
