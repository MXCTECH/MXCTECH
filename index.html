<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contract – Warm Up UK</title>

  <!-- You can keep your existing global CSS. The rules below only style the signature section/buttons. -->
  <style>
    :root{
      --gold:#caa231;
      --ink:#111;
      --soft:#f5f6f8;
      --dash:#c9cbd1;
      --radius:16px;
    }
    body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:900px;margin:0 auto;padding:24px}
    .section-title{font-size:28px;font-weight:800;margin:8px 0 16px}
    .card{background:#fff;border:1px solid #e6e7ea;border-radius:20px;box-shadow:0 6px 20px rgba(0,0,0,.04);padding:16px 18px;margin-bottom:18px}
    .sig-label{font-size:18px;font-weight:700;margin:6px 0 10px}
    .sig-pad{
      background:var(--soft);
      border:2px dashed var(--dash);
      border-radius:16px;
      touch-action:none; /* keep pen drawing smooth */
      width:100%;
      height:220px;
      display:block;
    }
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 300px}
    .btnbar{display:flex;gap:14px;flex-wrap:wrap;justify-content:flex-start}
    .btn{
      appearance:none;border:0;border-radius:14px;
      padding:14px 18px;font-weight:700;font-size:16px;cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.08)
    }
    .btn-clear{background:#eef0f4}
    .btn-primary{background:var(--gold);color:#000}
    .footerbar{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.96);backdrop-filter:saturate(140%) blur(6px);border-top:1px solid #ececf0}
    .footerbar .inner{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;justify-content:flex-start;flex-wrap:wrap}
    /* Make sure the whole contract fits nicely when rendered */
    #contract{background:#fff}
    /* Avoid accidental text selection while drawing */
    .noselect{user-select:none;-webkit-user-select:none}
  </style>
</head>

<body class="noselect">
  <div id="contract" class="container">

    <!-- ====== YOUR HEADER / ADDRESS / ETC (leave as-is if you already have one) ====== -->
    <div class="card" id="headerBlock">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div style="font-weight:900;font-size:22px">Warm Up UK Homes Limited</div>
        <div style="font-size:14px;opacity:.8">
          Fitzwilliam House, Middle Bank, Doncaster, DN4 5NG • 07470 474 774
        </div>
      </div>
    </div>

    <!-- ====== CUSTOMER / ORDER DETAILS (keep or replace with yours) ====== -->
    <div class="card" id="customerDetails">
      <!-- Your existing details fields can stay as-is; these are placeholders -->
      <div class="row">
        <div class="col"><label>Customer Name</label><br><input id="custName" style="width:100%;padding:12px;border:1px solid #e1e2e6;border-radius:12px"></div>
        <div class="col"><label>Address</label><br><input id="custAddr" style="width:100%;padding:12px;border:1px solid #e1e2e6;border-radius:12px"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="col"><label>Phone</label><br><input id="custPhone" style="width:100%;padding:12px;border:1px solid #e1e2e6;border-radius:12px"></div>
        <div class="col"><label>Email</label><br><input id="custEmail" style="width:100%;padding:12px;border:1px solid #e1e2e6;border-radius:12px"></div>
      </div>
    </div>

    <!-- ====== PRODUCTS SECTION – DO NOT CHANGE ======
         Paste your existing, working products HTML+JS inside the wrapper below.
         NOTHING here is styled by this file; your own styles/scripts keep control. -->
    <div id="productsWrapper" class="card">
      <!-- BEGIN PRODUCTS (leave as-is) -->
      <!-- ✂️ PASTE YOUR EXISTING PRODUCTS BLOCK HERE (unchanged) ✂️ -->
      <div id="products-placeholder" style="padding:8px 2px;opacity:.55;font-size:14px">
        (Paste your existing Products block here; this placeholder is just a marker.)
      </div>
      <!-- END PRODUCTS -->
    </div>

    <!-- ====== SIGNATURES ====== -->
    <div class="section-title">Signatures</div>
    <div class="card">
      <div class="sig-label">Customer Signature</div>
      <canvas id="sigCustomer" class="sig-pad"></canvas>
      <div class="btnbar" style="margin:10px 0 4px">
        <button class="btn btn-clear" id="clearCustomer">Clear</button>
      </div>
    </div>

    <div class="card">
      <div class="sig-label">Company Representative Signature</div>
      <canvas id="sigRep" class="sig-pad"></canvas>
      <div class="btnbar" style="margin:10px 0 4px">
        <button class="btn btn-clear" id="clearRep">Clear</button>
      </div>
    </div>

    <!-- ====== TERMS (keep/replace with your full content) ====== -->
    <div class="card" id="termsBlock">
      <div class="sig-label">Terms &amp; Conditions</div>
      <ol style="margin:8px 0 0 18px;line-height:1.35">
        <li>All works to be carried out as specified on the order form.</li>
        <li>Prices include admin fee where applicable.</li>
        <li>Customer confirms authority to proceed.</li>
        <!-- Keep your full 1–8 summary here -->
      </ol>
    </div>

  </div><!-- /#contract -->

  <!-- Sticky footer buttons -->
  <div class="footerbar">
    <div class="inner">
      <button class="btn btn-clear" id="clearAll">Clear Form</button>
      <button class="btn btn-primary" id="genPdf">Generate PDF</button>
    </div>
  </div>

  <!-- ====== LIBRARIES ====== -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <script>
    /* ========= Signature setup ========= */
    const pads = [
      { canvas: document.getElementById('sigCustomer'), clearBtn: document.getElementById('clearCustomer') },
      { canvas: document.getElementById('sigRep'),      clearBtn: document.getElementById('clearRep') }
    ];
    const sigObjects = [];

    function resizeCanvasForDPR(canvas) {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.round(rect.width  * ratio);
      canvas.height = Math.round(rect.height * ratio);
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
    }

    function setupSignaturePad(entry){
      resizeCanvasForDPR(entry.canvas);
      const pad = new SignaturePad(entry.canvas, {
        penColor: '#111',
        backgroundColor: 'rgba(0,0,0,0)' // keep transparent
      });
      entry.clearBtn.addEventListener('click', () => pad.clear());
      sigObjects.push(pad);

      // Prevent page scroll while drawing
      let drawing = false;
      entry.canvas.addEventListener('pointerdown', () => { drawing = true; }, {passive:false});
      entry.canvas.addEventListener('pointerup',   () => { drawing = false; }, {passive:false});
      entry.canvas.addEventListener('pointercancel',() => { drawing = false; }, {passive:false});
      entry.canvas.addEventListener('touchmove', (e) => {
        if (drawing) e.preventDefault();
      }, {passive:false});
    }

    pads.forEach(setupSignaturePad);
    window.addEventListener('resize', () => pads.forEach(p=>resizeCanvasForDPR(p.canvas)));

    /* ========= Clear all ========= */
    document.getElementById('clearAll').addEventListener('click', () => {
      // Clear basic inputs here; keep your own products clear logic untouched
      ['custName','custAddr','custPhone','custEmail'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.value='';
      });
      sigObjects.forEach(p=>p.clear());
    });

    /* ========= PDF generation with signature flatten ========= */
    function flattenSignaturesGetRestorers() {
      // Replace each signature canvas with an <img> so html2pdf captures it reliably
      const restorers = [];
      sigObjects.forEach((pad, idx) => {
        const canvas = pads[idx].canvas;
        const parent = canvas.parentNode;
        const img = new Image();
        img.style.width = canvas.style.width || '100%';
        img.style.height = canvas.style.height || `${canvas.getBoundingClientRect().height}px`;
        img.style.borderRadius = getComputedStyle(canvas).borderRadius;
        img.style.border = getComputedStyle(canvas).border;
        img.style.background = getComputedStyle(canvas).background;

        img.src = pad.isEmpty() ? // show a faint blank if empty to keep the box size
          (function(){
            const c=document.createElement('canvas');
            c.width=canvas.width; c.height=canvas.height;
            return c.toDataURL('image/png');
          })()
          : pad.toDataURL('image/png');

        parent.replaceChild(img, canvas);
        restorers.push(() => parent.replaceChild(canvas, img));
      });
      return restorers;
    }

    document.getElementById('genPdf').addEventListener('click', async () => {
      const contractNode = document.getElementById('contract');

      // 1) Flatten signatures
      const restore = flattenSignaturesGetRestorers();

      // 2) Build filename from customer name (optional)
      const name = (document.getElementById('custName')?.value || 'Contract').replace(/[^\w\- ]+/g,'').trim();
      const fileName = name ? `${name} - Warm Up UK Contract.pdf` : 'Warm Up UK Contract.pdf';

      // 3) Generate
      const opt = {
        margin:       [8,8,8,8],         // top, left, bottom, right (mm)
        filename:     fileName,
        image:        { type: 'jpeg', quality: 0.96 },
        html2canvas:  { scale: 2, useCORS: true, allowTaint: true, backgroundColor:'#ffffff' },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak:    { mode: ['avoid-all','css','legacy'] }
      };

      try{
        await html2pdf().from(contractNode).set(opt).save();
      } catch(e){
        alert('PDF error: '+ e.message);
      } finally {
        // 4) Restore canvases so you can continue signing/editing after PDF
        restore.forEach(fn=>fn());
      }
    });
  </script>
</body>
</html>
