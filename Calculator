<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculator / Contract — MXCTECH</title>
<style>
  :root{--bg:#0c0f16;--panel:#171b23;--panel2:#10141c;--line:#232936;--text:#e9edf7;--muted:#9aa4bd;--blue:#1F6BFF;--red:#E53935;--gold:#E3AD27;--green:#17a56a;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0d14,#0b0e15 60%,#0c0f16);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:14px 16px;background:rgba(16,20,28,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  header img{height:34px;border-radius:6px}
  header h1{margin:0;font-size:18px;font-weight:900}
  main{max-width:1100px;margin:auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 8px 26px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  label{color:var(--muted);font-size:12px;margin:2px 0 6px;display:block}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:var(--panel2);color:var(--text)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted);font-size:12px;text-transform:uppercase}
  .btn{border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer}
  .btn.blue{background:var(--blue);border-color:var(--blue)}
  .btn.green{background:var(--green);border-color:var(--green)}
  .btn.red{background:var(--red);border-color:var(--red)}
  a.btn{text-decoration:none;display:inline-block}
  canvas{border:1px dashed #2b3146;border-radius:10px;background:#0c101a}
  @media (max-width:980px){ .grid,.grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <img src="mxctech-logo.png" alt="logo"><h1>Calculator / Build Contract</h1>
  <a href="index.html" class="btn" style="margin-left:auto">Home</a>
</header>

<main id="page">
  <!-- CUSTOMER BLOCK -->
  <section class="card">
    <div class="grid">
      <div><label>Customer Name</label><input id="custName"></div>
      <div><label>Phone</label><input id="custPhone" placeholder="+44… or 07…"></div>
      <div><label>Email</label><input id="custEmail"></div>
      <div><label>Address</label><input id="addr1"></div>
      <div><label>Postcode</label><input id="postcode"></div>
      <div><label>Rep Name</label><input id="repName"></div>
    </div>
  </section>

  <!-- ITEMS -->
  <section class="card">
    <h3 style="margin:0 0 10px">Products</h3>
    <div class="grid2">
      <div><label>Item</label><input id="itemName" placeholder="Multifoil Insulation"></div>
      <div class="grid2" style="gap:12px">
        <div><label>Qty</label><input id="qty" type="number" min="1" value="1"></div>
        <div><label>Unit (£)</label><input id="price" type="number" step="0.01" placeholder="0.00"></div>
      </div>
    </div>
    <div style="margin-top:8px"><button class="btn green" id="addItem">Add Item</button></div>
    <table id="itemsTable" style="margin-top:10px">
      <thead><tr><th>Item</th><th>Qty</th><th>Unit (£)</th><th>Line (£)</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- TOTALS -->
  <section class="card">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label style="display:flex;gap:8px;align-items:center"><input id="vatOn" type="checkbox" checked style="transform:scale(1.2)"> Apply VAT 20%</label>
      <div style="margin-left:auto">Subtotal: £<strong id="subtotal">0.00</strong> &nbsp; VAT: £<strong id="vat">0.00</strong> &nbsp; Total: £<strong id="total">0.00</strong></div>
    </div>
  </section>

  <!-- SIGNATURE -->
  <section class="card">
    <h3 style="margin:0 0 10px">Signature</h3>
    <canvas id="sig" width="800" height="220"></canvas>
    <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" id="clearSig">Clear</button></div>
  </section>

  <!-- ACTIONS -->
  <section class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn blue" id="saveContract">Save Contract</button>
      <button class="btn" id="downloadPDF">Download PDF</button>
      <a class="btn" id="openContract" target="_blank">Open Contract Page</a>
    </div>
  </section>

  <!-- SAVED -->
  <section class="card" id="saved">
    <h3 style="margin:0 0 10px">Saved Contracts</h3>
    <table id="contractsTbl">
      <thead><tr><th>Date</th><th>Customer</th><th>Total</th><th>Open</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
const $=s=>document.querySelector(s); const load=(k,d=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const fmt=n=>Number(n||0).toFixed(2);

function contractURL(){
  const u=new URL(location.href); const p=u.pathname.split('/'); p[p.length-1]='contract.html'; u.pathname=p.join('/'); return u;
}

/* Items */
let items=[];
function renderItems(){
  const tb=$('#itemsTable tbody'); tb.innerHTML='';
  items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.name}</td><td>${it.qty}</td><td>£${fmt(it.price)}</td><td>£${fmt(it.qty*it.price)}</td>
      <td><button class="btn red" onclick="removeItem(${i})">Remove</button></td>`;
    tb.appendChild(tr);
  });
  calcTotals();
}
function removeItem(i){ items.splice(i,1); renderItems(); }
$('#addItem').addEventListener('click',()=>{
  const name=$('#itemName').value.trim()||'Item'; const qty=Number($('#qty').value||1); const price=Number($('#price').value||0);
  if(qty<=0) return; items.push({name,qty,price}); renderItems();
});

/* Totals */
function calcTotals(){
  const sub=items.reduce((s,it)=>s+it.qty*it.price,0);
  const vat=$('#vatOn').checked? sub*0.2 : 0;
  $('#subtotal').textContent=fmt(sub); $('#vat').textContent=fmt(vat); $('#total').textContent=fmt(sub+vat);
}
$('#vatOn').addEventListener('change',calcTotals);

/* Signature */
const canvas=$('#sig'); const ctx=canvas.getContext('2d'); ctx.lineWidth=2; ctx.strokeStyle='#e9edf7';
let drawing=false,last=null;
function pos(e){const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top};}
function down(e){drawing=true; last=pos(e); e.preventDefault();}
function move(e){if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault();}
function up(){drawing=false;}
canvas.addEventListener('mousedown',down); canvas.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
canvas.addEventListener('touchstart',down,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false}); canvas.addEventListener('touchend',up);
$('#clearSig').addEventListener('click',()=>ctx.clearRect(0,0,canvas.width,canvas.height));
function sigData(){ return canvas.toDataURL('image/png'); }

/* Build prefill params */
function qParams(){
  return new URLSearchParams({
    custName:$('#custName').value,custPhone:$('#custPhone').value,custEmail:$('#custEmail').value,
    addr1:$('#addr1').value,postcode:$('#postcode').value,repName:$('#repName').value,
    jobType:'Insulation'
  }).toString();
}

/* Save contract (local) */
$('#saveContract').addEventListener('click',()=>{
  const data={
    id:crypto.randomUUID(),
    contractNo:`MXC-${new Date().toISOString().slice(0,10)}-${Math.floor(Math.random()*9000+1000)}`,
    custName:$('#custName').value,custPhone:$('#custPhone').value,custEmail:$('#custEmail').value,
    addr1:$('#addr1').value,postcode:$('#postcode').value,repName:$('#repName').value,
    items, subtotal:Number($('#subtotal').textContent), vat:Number($('#vat').textContent), total:Number($('#total').textContent),
    installDate:'', jobType:'Insulation', signatureData:sigData()
  };
  const list=load('mxc_contracts'); list.push(data); save('mxc_contracts',list);
  alert('Contract saved');
  renderSaved();
});

/* Open full contract page */
const openEl=$('#openContract');
openEl.addEventListener('click',(e)=>{
  e.preventDefault();
  const u=contractURL(); u.search=qParams(); window.open(u,'_blank');
});

/* PDF of the calculator page */
$('#downloadPDF').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const node=document.getElementById('page');
  const snap=await html2canvas(node,{scale:2,backgroundColor:'#0c0f16'});
  const img=snap.toDataURL('image/png'); const pdf=new jsPDF('p','pt','a4');
  const w=pdf.internal.pageSize.getWidth(), h=pdf.internal.pageSize.getHeight();
  const r=Math.min(w/snap.width,h/snap.height); pdf.addImage(img,'PNG', (w-snap.width*r)/2, 20, snap.width*r, snap.height*r);
  pdf.save('calculator-contract.pdf');
});

/* Saved table */
function renderSaved(){
  const tb=$('#contractsTbl tbody'); tb.innerHTML='';
  const list=load('mxc_contracts');
  list.sort((a,b)=>(a.installDate||'').localeCompare(b.installDate||'')); 
  list.forEach(c=>{
    const u=contractURL(); u.search='id='+encodeURIComponent(c.id);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date().toLocaleDateString()}</td><td>${c.custName||''}</td><td>£${fmt(c.total)}</td><td><a class="btn" href="${u}" target="_blank">Open</a></td>`;
    tb.appendChild(tr);
  });
}
renderItems(); calcTotals(); renderSaved();
</script>
</body>
</html>
